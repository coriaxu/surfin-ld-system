<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Surfin 学习发展系统</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* =========================================
       1. 全局变量 & 基础样式
       ========================================= */
    :root {
      --primary-deep: #0A3249;
      --primary: #0F4264;
      --primary-light: #2D71A1;
      --primary-glow: rgba(45, 113, 161, 0.4);

      --surface-base: #F5F6F8;
      --surface-card: #FFFFFF;
      --surface-elevated: #FAFBFC;
      --surface-sidebar: #0F4264;

      --text-title: #1A2B3C;
      --text-body: #4A5568;
      --text-muted: #A0AEC0;
      --text-inverse: #FFFFFF;
      --text-sidebar: rgba(255, 255, 255, 0.7);
      --text-sidebar-active: #FFFFFF;

      --accent-success: #10B981;
      --accent-success-glow: rgba(16, 185, 129, 0.15);
      --accent-warning: #F59E0B;
      --accent-warning-glow: rgba(245, 158, 11, 0.15);
      --accent-danger: #EF4444;
      --accent-danger-glow: rgba(239, 68, 68, 0.15);

      --border-subtle: rgba(0, 0, 0, 0.06);
      --border-medium: rgba(0, 0, 0, 0.1);

      --shadow-ambient: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-elevated: 0 4px 6px rgba(0, 0, 0, 0.04), 0 10px 15px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0, 0, 0, 0.02);
      --shadow-floating: 0 10px 25px rgba(0, 0, 0, 0.08), 0 20px 48px rgba(0, 0, 0, 0.06), 0 1px 4px rgba(0, 0, 0, 0.08);
      --shadow-glow-primary: 0 0 20px rgba(15, 66, 100, 0.15), 0 0 40px rgba(15, 66, 100, 0.05);

      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;

      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);

      --sidebar-width: 240px;
      --sidebar-collapsed-width: 0px;
    }

    /* --- [暗夜星辰 - Dark Mode] --- */
    body[data-theme="dark"] {
      --primary-deep: #051624;
      --primary: #0A2647;
      --primary-light: #144272;
      --primary-glow: rgba(20, 66, 114, 0.4);
      --surface-base: #020C1B;
      --surface-card: #0A192F;
      --surface-elevated: #112240;
      --surface-sidebar: #051624;
      --text-title: #E6F1FF;
      --text-body: #8892B0;
      --text-muted: #495670;
      --text-sidebar: rgba(255, 255, 255, 0.6);
      --border-subtle: rgba(255, 255, 255, 0.05);
      --border-medium: rgba(255, 255, 255, 0.1);
      --shadow-ambient: 0 4px 6px rgba(0, 0, 0, 0.3);
      --shadow-elevated: 0 10px 15px rgba(0, 0, 0, 0.4);
    }

    /* --- [流金岁月 - Royal Wine] --- */
    body[data-theme="wine"] {
      --primary-deep: #4A0E0E;
      --primary: #6B0D0D;
      --primary-light: #941111;
      --primary-glow: rgba(148, 17, 17, 0.3);
      --surface-base: #FDF4F4;
      --surface-card: #FFFFFF;
      --surface-elevated: #F9EBEB;
      --surface-sidebar: #4A0E0E;
      --text-title: #4A0E0E;
      --text-body: #6D4C4C;
      --text-muted: #A68A8A;
      --border-subtle: rgba(107, 13, 13, 0.08);
      --border-medium: rgba(107, 13, 13, 0.15);
    }

    /* --- [生机薄荷 - Growth Mint] --- */
    body[data-theme="mint"] {
      --primary-deep: #1B5E20;
      --primary: #2E7D32;
      --primary-light: #4CAF50;
      --primary-glow: rgba(76, 175, 80, 0.3);
      --surface-base: #F1F8E9;
      --surface-card: #FFFFFF;
      --surface-elevated: #E8F5E9;
      --surface-sidebar: #1B5E20;
      --text-title: #1B5E20;
      --text-body: #33691E;
      --text-muted: #7CB342;
    }

    /* --- [匠心工匠 - Smartisan Craft] --- */
    body[data-theme="craft"] {
      --primary-deep: #2A2A2A;
      --primary: #3F3F3F;
      --primary-light: #555555;
      --primary-glow: rgba(85, 85, 85, 0.3);
      --surface-base: #E0E0E0;
      --surface-card: #F5F5F5;
      --surface-elevated: #EEEEEE;
      --surface-sidebar: #2A2A2A;
      --text-title: #212121;
      --text-body: #424242;
      --text-muted: #757575;
      --border-subtle: rgba(0, 0, 0, 0.05);
      --border-medium: rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: background var(--transition-smooth), border-color var(--transition-smooth), color var(--transition-smooth);
    }

    body {
      background: var(--surface-base);
      color: var(--text-body);
      font-family: "Helvetica Neue", -apple-system, "Microsoft YaHei", sans-serif;
      font-size: 15px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      display: flex;
    }

    /* 侧边栏 */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--primary) 0%, var(--primary-deep) 100%);
      min-height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      z-index: 200;
      transition: transform var(--transition-smooth);
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      overflow: hidden;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-inverse);
      letter-spacing: -0.3px;
      white-space: nowrap;
    }

    .sidebar-toggle {
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-sm);
      color: var(--text-sidebar);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
      flex-shrink: 0;
    }

    .sidebar-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text-inverse);
    }

    .sidebar-toggle svg {
      width: 16px;
      height: 16px;
    }

    .sidebar-nav {
      flex: 1;
      padding: 16px 12px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-label {
      font-size: 11px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0 12px;
      margin-bottom: 8px;
      white-space: nowrap;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      color: var(--text-sidebar);
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-bottom: 4px;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-sidebar-active);
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: var(--text-sidebar-active);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .nav-item span {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
    }

    /* 主内容区 */
    .main-wrapper {
      margin-left: var(--sidebar-width);
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: margin-left var(--transition-smooth);
    }

    .main-wrapper.expanded {
      margin-left: 0;
    }

    /* Brand mark */
    .brand-mark {
      width: 36px;
      height: 36px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .brand-mark svg {
      width: 20px;
      height: 20px;
      color: var(--text-inverse);
    }

    /* 顶部栏 */
    .topbar {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border-subtle);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .topbar-open-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border-medium);
      background: var(--surface-card);
      border-radius: var(--radius-md);
      color: var(--text-body);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
      box-shadow: var(--shadow-ambient);
    }

    .topbar-open-btn:hover {
      background: var(--surface-elevated);
      border-color: var(--primary-light);
      color: var(--primary);
      box-shadow: var(--shadow-elevated);
    }

    .topbar-open-btn svg {
      width: 18px;
      height: 18px;
    }

    .main-wrapper.expanded .topbar-open-btn {
      display: flex;
    }

    .page-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-title);
    }

    .topbar-actions {
      display: flex;
      gap: 8px;
    }

    /* 按钮 */
    .btn {
      border: none;
      border-radius: var(--radius-sm);
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }

    .btn svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      color: var(--text-inverse);
      box-shadow: var(--shadow-ambient);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-elevated), var(--shadow-glow-primary);
    }

    .btn-secondary {
      background: var(--surface-card);
      color: var(--text-body);
      border: 1px solid var(--border-medium);
    }

    .btn-secondary:hover {
      background: var(--surface-elevated);
      box-shadow: var(--shadow-ambient);
    }

    .btn-ghost {
      background: transparent;
      color: var(--primary-light);
      padding: 6px 10px;
    }

    .btn-ghost:hover {
      background: rgba(15, 66, 100, 0.06);
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-edit {
      background: #5AC769;
      color: #FFFFFF;
      padding: 5px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
    }

    .btn-edit:hover {
      background: #4CAF50;
    }

    .btn-delete {
      background: #E64340;
      color: #FFFFFF;
      padding: 5px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
    }

    .btn-delete:hover {
      background: #D32F2F;
    }

    /* 主内容 */
    main {
      flex: 1;
      padding: 24px 32px 40px;
    }

    /* 页面容器 */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* 统计卡片 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: var(--surface-card);
      border-radius: var(--radius-lg);
      padding: 22px 24px;
      box-shadow: var(--shadow-ambient);
      border: 1px solid var(--border-subtle);
      transition: all var(--transition-smooth);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.5) 50%, rgba(255, 255, 255, 0) 100%);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-floating);
    }

    /* 彩色卡片样式 - 更鲜艳的颜色 */
    .stat-card.blue {
      background: linear-gradient(135deg, #5B9EE1 0%, #4A8FD4 100%);
      border: none;
    }

    .stat-card.green {
      background: linear-gradient(135deg, #2DD4A8 0%, #20C997 100%);
      border: none;
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #FFCA28 0%, #FFB300 100%);
      border: none;
    }

    .stat-card.red {
      background: linear-gradient(135deg, #FF7B8A 0%, #F56778 100%);
      border: none;
    }

    .stat-card.blue,
    .stat-card.green,
    .stat-card.orange,
    .stat-card.red {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .stat-card.blue:hover,
    .stat-card.green:hover,
    .stat-card.orange:hover,
    .stat-card.red:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card.blue .stat-label,
    .stat-card.green .stat-label,
    .stat-card.orange .stat-label,
    .stat-card.red .stat-label {
      color: #FFFFFF;
      font-weight: 600;
    }

    .stat-card.blue .stat-value,
    .stat-card.green .stat-value,
    .stat-card.orange .stat-value,
    .stat-card.red .stat-value {
      color: #FFFFFF;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .stat-card.blue .stat-desc,
    .stat-card.green .stat-desc,
    .stat-card.orange .stat-desc,
    .stat-card.red .stat-desc {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }

    .stat-card.blue .stat-icon,
    .stat-card.green .stat-icon,
    .stat-card.orange .stat-icon,
    .stat-card.red .stat-icon {
      background: rgba(255, 255, 255, 0.25);
      color: #FFFFFF;
    }

    .stat-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat-label {
      font-size: 15px;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: -0.2px;
    }

    .stat-icon {
      width: 42px;
      height: 42px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-icon svg {
      width: 20px;
      height: 20px;
      stroke-width: 2.2;
    }

    .stat-icon.blue {
      background: linear-gradient(135deg, rgba(15, 66, 100, 0.12) 0%, rgba(45, 113, 161, 0.08) 100%);
      color: var(--primary);
    }

    .stat-icon.green {
      background: linear-gradient(135deg, var(--accent-success-glow) 0%, rgba(16, 185, 129, 0.08) 100%);
      color: var(--accent-success);
    }

    .stat-icon.orange {
      background: linear-gradient(135deg, var(--accent-warning-glow) 0%, rgba(245, 158, 11, 0.08) 100%);
      color: var(--accent-warning);
    }

    .stat-icon.red {
      background: linear-gradient(135deg, var(--accent-danger-glow) 0%, rgba(239, 68, 68, 0.08) 100%);
      color: var(--accent-danger);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-title);
      line-height: 1.1;
      margin-bottom: 6px;
      letter-spacing: -0.5px;
    }

    .stat-desc {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* 卡片 */
    .card {
      background: var(--surface-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-ambient);
      border: 1px solid var(--border-subtle);
      overflow: hidden;
    }

    .card-header {
      padding: 18px 22px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(180deg, rgba(250, 251, 252, 0.5) 0%, transparent 100%);
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-title);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title-icon {
      width: 26px;
      height: 26px;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, rgba(15, 66, 100, 0.1) 0%, rgba(45, 113, 161, 0.05) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }

    .card-title-icon svg {
      width: 14px;
      height: 14px;
    }

    .card-body {
      padding: 22px;
    }

    .card-intro {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 18px;
      line-height: 1.7;
    }

    /* 图表网格 */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    .chart-area {
      position: relative;
      height: 200px;
    }

    /* 表单 */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.span-full {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-body);
    }

    input,
    select,
    textarea {
      padding: 10px 12px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-family: inherit;
      background: var(--surface-card);
      color: var(--text-title);
      transition: all var(--transition-fast);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(45, 113, 161, 0.1);
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
    }

    textarea {
      resize: vertical;
      min-height: 68px;
    }

    .form-footer {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      padding-top: 4px;
    }

    /* 表格 */
    .table-wrap {
      overflow-x: auto;
      margin-top: 18px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 2px solid var(--border-subtle);
      background: var(--surface-elevated);
    }

    td {
      padding: 12px;
      font-size: 13px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-body);
    }

    tr {
      transition: background var(--transition-fast);
    }

    tr:hover td {
      background: rgba(15, 66, 100, 0.02);
    }

    tr:last-child td {
      border-bottom: none;
    }

    td:first-child {
      font-weight: 600;
      color: var(--text-title);
    }

    .tag {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
    }

    .tag-primary {
      background: linear-gradient(135deg, rgba(15, 66, 100, 0.12) 0%, rgba(45, 113, 161, 0.08) 100%);
      color: var(--primary);
    }

    .tag-warning {
      background: linear-gradient(135deg, var(--accent-warning-glow) 0%, rgba(245, 158, 11, 0.08) 100%);
      color: var(--accent-warning);
    }

    .val-positive {
      color: var(--accent-success);
      font-weight: 600;
    }

    .val-negative {
      color: var(--accent-danger);
      font-weight: 600;
    }

    .actions-row {
      display: flex;
      gap: 4px;
    }

    .empty-cell {
      padding: 36px 12px !important;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* 空状态占位 */
    .empty-state {
      text-align: center;
      padding: 80px 40px;
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      background: var(--surface-elevated);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .empty-state-icon svg {
      width: 28px;
      height: 28px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-title);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 320px;
      margin: 0 auto;
    }

    /* 滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-base);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-body);
    }

    /* AI 知识库样式 */
    .ai-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--surface-card);
      padding: 4px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-ambient);
      width: fit-content;
    }

    .ai-tab {
      padding: 10px 24px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 600;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .ai-tab:hover {
      color: var(--text-body);
      background: var(--surface-base);
    }

    .ai-tab.active {
      background: var(--primary);
      color: white;
    }

    .ai-panel {
      display: none;
    }

    .ai-panel.active {
      display: block;
    }

    .ai-top-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .ai-kanban-card {
      min-height: 300px;
    }

    .ai-chart-card {
      min-height: 300px;
    }

    .card-title-sm {
      font-size: 14px;
    }

    .kanban-episode {
      font-size: 13px;
      color: var(--text-muted);
      padding: 8px 12px;
      background: var(--surface-base);
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
    }

    .kanban-episode.active {
      color: var(--primary);
      font-weight: 600;
      background: rgba(15, 66, 100, 0.08);
    }

    .kanban-tasks {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kanban-task {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--surface-base);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-body);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .kanban-task:hover {
      background: var(--surface-elevated);
    }

    .kanban-task.done {
      background: rgba(16, 185, 129, 0.08);
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .kanban-task .task-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--text-muted);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all var(--transition-fast);
    }

    .kanban-task.done .task-checkbox {
      background: var(--accent-success);
      border-color: var(--accent-success);
      color: white;
    }

    .kanban-task .task-checkbox svg {
      width: 12px;
      height: 12px;
      opacity: 0;
    }

    .kanban-task.done .task-checkbox svg {
      opacity: 1;
    }

    .kanban-empty {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .chart-zoom {
      display: flex;
      gap: 4px;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--surface-base);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: all var(--transition-fast);
    }

    .btn-icon:hover {
      background: var(--surface-elevated);
      color: var(--text-body);
    }

    .chart-container-md {
      height: 200px;
    }

    .select-sm {
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-sm);
      background: var(--surface-card);
      color: var(--text-body);
    }

    .heatmap-container {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      padding: 8px 0;
    }

    .heatmap-week {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .heatmap-day {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background: #ebedf0;
      cursor: pointer;
      position: relative;
    }

    .heatmap-day:hover {
      outline: 2px solid var(--primary-light);
      outline-offset: 1px;
    }

    .heatmap-day[data-level="1"] {
      background: #9be9a8;
    }

    .heatmap-day[data-level="2"] {
      background: #40c463;
    }

    .heatmap-day[data-level="3"] {
      background: #30a14e;
    }

    .heatmap-day[data-level="4"] {
      background: #216e39;
    }

    .heatmap-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-title);
      color: white;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--transition-fast);
      z-index: 100;
      margin-bottom: 4px;
    }

    .heatmap-day:hover .heatmap-tooltip {
      opacity: 1;
    }

    .heatmap-legend {
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: flex-end;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .heatmap-legend-item {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .heatmap-legend-label {
      margin: 0 4px;
    }

    .form-grid-5 {
      grid-template-columns: repeat(5, 1fr);
    }

    .span-3 {
      grid-column: span 3;
    }

    .rate-good {
      color: var(--accent-success);
      font-weight: 600;
    }

    .rate-mid {
      color: var(--accent-warning);
      font-weight: 600;
    }

    .rate-low {
      color: var(--accent-danger);
      font-weight: 600;
    }

    .tag-news {
      background: #E3F2FD;
      color: #1976D2;
    }

    .tag-tool {
      background: #E8F5E9;
      color: #388E3C;
    }

    .tag-paper {
      background: #FFF3E0;
      color: #F57C00;
    }

    .tag-thought {
      background: #F3E5F5;
      color: #7B1FA2;
    }

    .tag-mixed {
      background: #ECEFF1;
      color: #546E7A;
    }

    @media (max-width: 1200px) {
      .ai-top-grid {
        grid-template-columns: 1fr;
      }

      .form-grid-5 {
        grid-template-columns: repeat(3, 1fr);
      }

      .span-3 {
        grid-column: span 2;
      }
    }

    @media (max-width: 768px) {
      .form-grid-5 {
        grid-template-columns: repeat(2, 1fr);
      }

      .span-3 {
        grid-column: span 2;
      }
    }

    /* =========================================
       8. 交互组件 (Toast & Modal)
       ========================================= */
    /* Toast 提示 */
    .toast-container {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      background: var(--surface-card);
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: var(--shadow-floating);
      border: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-title);
      animation: toast-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
      min-width: 280px;
    }

    .toast.success {
      border-left: 4px solid var(--accent-success);
    }

    .toast.error {
      border-left: 4px solid var(--accent-danger);
    }

    .toast.info {
      border-left: 4px solid var(--primary);
    }

    .toast-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast.success .toast-icon {
      color: var(--accent-success);
    }

    .toast.error .toast-icon {
      color: var(--accent-danger);
    }

    .toast.info .toast-icon {
      color: var(--primary);
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes toast-out {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      to {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
    }

    /* Modal 弹窗 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      z-index: 900;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-overlay.active {
      display: flex;
      opacity: 1;
    }

    .modal {
      background: var(--surface-card);
      width: 400px;
      max-width: 90vw;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-floating);
      transform: scale(0.95);
      transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-title);
    }

    .modal-body {
      font-size: 15px;
      color: var(--text-body);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* 主题下拉菜单 */
    .theme-switcher {
      position: relative;
    }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 12px);
      right: 0;
      background: var(--surface-card);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-floating);
      width: 160px;
      display: none;
      z-index: 500;
      flex-direction: column;
      padding: 6px;
      animation: toast-in 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .theme-dropdown.active {
      display: flex;
    }

    .theme-option {
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-body);
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all var(--transition-fast);
    }

    .theme-option:hover {
      background: var(--surface-elevated);
      color: var(--primary);
    }

    .theme-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
    }

    body[data-theme="dark"] .theme-dot {
      border-color: rgba(255, 255, 255, 0.2);
    }

    body[data-theme="dark"] .topbar {
      background: rgba(10, 25, 47, 0.85);
    }

    body[data-theme="wine"] .topbar {
      background: rgba(255, 255, 255, 0.85);
    }

    body[data-theme="mint"] .topbar {
      background: rgba(255, 255, 255, 0.85);
    }

    body[data-theme="craft"] .topbar {
      background: rgba(245, 245, 245, 0.85);
    }
  </style>
</head>

<body>
  <!-- 侧边栏 -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="brand-mark">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
          </svg>
        </div>
        <span class="sidebar-title">Surfin L&D</span>
      </div>
      <button class="sidebar-toggle" id="sidebarToggle" title="收起侧边栏">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6" />
        </svg>
      </button>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-label">概览</div>
        <div class="nav-item active" data-page="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7" />
            <rect x="14" y="3" width="7" height="7" />
            <rect x="14" y="14" width="7" height="7" />
            <rect x="3" y="14" width="7" height="7" />
          </svg>
          <span>培训大屏</span>
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-section-label">管理</div>
        <div class="nav-item" data-page="training">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
          </svg>
          <span>培训管理</span>
        </div>
        <div class="nav-item" data-page="aiknowledge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
            <line x1="12" y1="22.08" x2="12" y2="12" />
          </svg>
          <span>AI 知识库</span>
        </div>
        <div class="nav-item" data-page="budget">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23" />
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
          </svg>
          <span>预算与开销</span>
        </div>
      </div>
    </nav>
  </aside>

  <!-- 主内容区 -->
  <div class="main-wrapper">
    <header class="topbar">
      <div class="topbar-left">
        <button class="topbar-open-btn" id="sidebarOpen" title="打开侧边栏">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
            <line x1="9" y1="3" x2="9" y2="21" />
          </svg>
        </button>
        <h1 class="page-title" id="pageTitle">培训大屏</h1>
      </div>
      <div class="topbar-actions" id="topbarActions">
        <div class="theme-switcher">
          <button class="btn btn-secondary btn-sm" id="themeBtn" onclick="toggleThemeDropdown(event)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5" />
              <path
                d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
            </svg>
            主题方案
          </button>
          <div class="theme-dropdown" id="themeDropdown">
            <div class="theme-option" onclick="setTheme('default')"><span class="theme-dot"
                style="background:#0F4264"></span>经典原力</div>
            <div class="theme-option" onclick="setTheme('dark')"><span class="theme-dot"
                style="background:#020C1B"></span>暗夜星辰</div>
            <div class="theme-option" onclick="setTheme('wine')"><span class="theme-dot"
                style="background:#6B0D0D"></span>流金岁月</div>
            <div class="theme-option" onclick="setTheme('mint')"><span class="theme-dot"
                style="background:#2E7D32"></span>生机薄荷</div>
            <div class="theme-option" onclick="setTheme('craft')"><span class="theme-dot"
                style="background:#3F3F3F"></span>匠心工匠</div>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="exportExcel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="8" y1="13" x2="16" y2="13" />
            <line x1="8" y1="17" x2="16" y2="17" />
          </svg>
          Excel
        </button>
        <button class="btn btn-secondary btn-sm" onclick="exportJson()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          JSON
        </button>
        <button class="btn btn-secondary btn-sm" onclick="importJson()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          导入
        </button>
        <button class="btn btn-primary btn-sm" onclick="exportPdf()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
          </svg>
          PDF
        </button>
      </div>
    </header>

    <main id="mainContent">
      <!-- 培训大屏 -->
      <div class="page active" id="page-dashboard">
        <section class="stats-grid">
          <div class="stat-card blue">
            <div class="stat-header">
              <span class="stat-label">本月培训场次</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                  <line x1="16" y1="2" x2="16" y2="6" />
                  <line x1="8" y1="2" x2="8" y2="6" />
                  <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statSessions">0</div>
            <div class="stat-desc" id="statUpcoming">最近培训：-</div>
          </div>
          <div class="stat-card green">
            <div class="stat-header">
              <span class="stat-label">本月总人时</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12 6 12 12 16 14" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statHours">0</div>
            <div class="stat-desc">人数 × 时长</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-header">
              <span class="stat-label">预算使用率</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23" />
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statBudgetUsage">0%</div>
            <div class="stat-desc" id="statBudgetRemain">剩余预算：-</div>
          </div>
          <div class="stat-card red">
            <div class="stat-header">
              <span class="stat-label">特殊项目支出</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statSpecialSpend">¥0</div>
            <div class="stat-desc">特殊项目专项</div>
          </div>
        </section>

        <section class="charts-grid">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                  </svg></span>
                培训人时趋势
              </h2>
            </div>
            <div class="card-body">
              <div class="chart-area"><canvas id="hoursChart"></canvas></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10" />
                    <line x1="18" y1="20" x2="18" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="16" />
                  </svg></span>
                预算 vs 开销
              </h2>
            </div>
            <div class="card-body">
              <div class="chart-area"><canvas id="budgetChart"></canvas></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
                    <path d="M22 12A10 10 0 0 0 12 2v10z" />
                  </svg></span>
                费用构成
              </h2>
            </div>
            <div class="card-body">
              <div class="chart-area"><canvas id="costPie"></canvas></div>
            </div>
          </div>
        </section>
      </div>

      <!-- 培训管理 -->
      <div class="page" id="page-training">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                </svg></span>
              培训场次管理
            </h2>
          </div>
          <div class="card-body">
            <p class="card-intro">记录培训时间、课程、项目、讲师、人数、时长，系统自动计算培训总人时。</p>
            <form id="sessionForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">培训时间</label>
                  <input type="date" id="sessionDate" required />
                </div>
                <div class="form-group">
                  <label class="form-label">课程名称</label>
                  <input type="text" id="sessionCourse" placeholder="如：新员工入职培训" required />
                </div>
                <div class="form-group">
                  <label class="form-label">所属项目</label>
                  <input type="text" id="sessionProject" placeholder="如：项目 A" required />
                </div>
                <div class="form-group">
                  <label class="form-label">讲师</label>
                  <input type="text" id="sessionLecturer" placeholder="讲师姓名" required />
                </div>
                <div class="form-group">
                  <label class="form-label">参加人数</label>
                  <input type="number" min="1" id="sessionPeople" required />
                </div>
                <div class="form-group">
                  <label class="form-label">培训时长（小时）</label>
                  <input type="number" step="0.5" min="0.5" id="sessionDuration" required />
                </div>
                <div class="form-group span-full">
                  <label class="form-label">备注</label>
                  <textarea id="sessionNote" placeholder="培训内容要点"></textarea>
                </div>
                <input type="hidden" id="sessionId" />
                <div class="form-footer">
                  <button class="btn btn-primary" type="submit">保存记录</button>
                </div>
              </div>
            </form>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>时间</th>
                    <th>课程</th>
                    <th>项目</th>
                    <th>讲师</th>
                    <th>人数</th>
                    <th>时长</th>
                    <th>总人时</th>
                    <th>备注</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="sessionTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- AI 知识库 -->
      <div class="page" id="page-aiknowledge">
        <!-- 项目切换 Tab -->
        <div class="ai-tabs">
          <button class="ai-tab active" data-tab="station">AI 广播站</button>
          <button class="ai-tab" data-tab="share">AI 分享月</button>
        </div>

        <!-- AI 广播站 -->
        <div class="ai-panel active" id="panel-station">
          <!-- 看板 + 图表 -->
          <div class="ai-top-grid">
            <!-- 左侧看板 -->
            <div class="card ai-kanban-card">
              <div class="card-header">
                <h3 class="card-title card-title-sm">
                  <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path d="M9 11H3v10h6V11zM21 3h-6v18h6V3zM15 7H9v14h6V7z" />
                    </svg></span>
                  本期看板
                </h3>
                <button class="btn btn-sm btn-secondary" onclick="newStationEpisode()">+ 新建期次</button>
              </div>
              <div class="card-body">
                <div class="kanban-episode" id="stationKanbanEpisode">未选择期次</div>
                <div class="kanban-tasks" id="stationKanbanTasks"></div>
              </div>
            </div>
            <!-- 右侧图表 -->
            <div class="card ai-chart-card">
              <div class="card-header">
                <h3 class="card-title card-title-sm">
                  <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path d="M18 20V10M12 20V4M6 20v-6" />
                    </svg></span>
                  查看率趋势
                </h3>
                <div class="chart-zoom">
                  <button class="btn-icon" onclick="zoomStationChart('out')" title="缩小"><svg viewBox="0 0 24 24"
                      width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8" />
                      <line x1="21" y1="21" x2="16.65" y2="16.65" />
                      <line x1="8" y1="11" x2="14" y2="11" />
                    </svg></button>
                  <button class="btn-icon" onclick="zoomStationChart('in')" title="放大"><svg viewBox="0 0 24 24"
                      width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8" />
                      <line x1="21" y1="21" x2="16.65" y2="16.65" />
                      <line x1="11" y1="8" x2="11" y2="14" />
                      <line x1="8" y1="11" x2="14" y2="11" />
                    </svg></button>
                  <button class="btn-icon" onclick="zoomStationChart('reset')" title="重置"><svg viewBox="0 0 24 24"
                      width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                      <path d="M3 3v5h5" />
                    </svg></button>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container chart-container-md">
                  <canvas id="stationChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- 日历热力图 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                  </svg></span>
                年度发布热力图
              </h3>
              <select id="stationHeatmapYear" class="select-sm" onchange="renderStationHeatmap()"></select>
            </div>
            <div class="card-body">
              <div class="heatmap-container" id="stationHeatmap"></div>
              <div class="heatmap-legend">
                <span class="heatmap-legend-label">查看率</span>
                <span class="heatmap-legend-item" style="background:#ebedf0"></span>
                <span class="heatmap-legend-item" style="background:#9be9a8"></span>
                <span class="heatmap-legend-item" style="background:#40c463"></span>
                <span class="heatmap-legend-item" style="background:#30a14e"></span>
                <span class="heatmap-legend-item" style="background:#216e39"></span>
                <span class="heatmap-legend-label">高</span>
              </div>
            </div>
          </div>

          <!-- 数据录入 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                  </svg></span>
                数据录入
              </h3>
            </div>
            <div class="card-body">
              <form id="stationForm">
                <div class="form-grid form-grid-5">
                  <div class="form-group">
                    <label class="form-label">期数</label>
                    <input type="number" id="stationEpisode" min="0" placeholder="第几期" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">发布日期</label>
                    <input type="date" id="stationDate" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">本期主题</label>
                    <input type="text" id="stationTitle" placeholder="标题或关键词" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">查看人数</label>
                    <input type="number" id="stationViews" min="0" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">公司总人数</label>
                    <input type="number" id="stationTotal" min="1" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">内容类型</label>
                    <select id="stationCategory">
                      <option value="news">AI 新闻</option>
                      <option value="tool">AI 工具</option>
                      <option value="paper">AI 论文</option>
                      <option value="thought">AI 思考</option>
                      <option value="mixed">综合</option>
                    </select>
                  </div>
                  <div class="form-group span-3">
                    <label class="form-label">备注</label>
                    <input type="text" id="stationNote" placeholder="特殊情况记录（选填）" />
                  </div>
                  <input type="hidden" id="stationId" />
                </div>
                <div class="form-footer">
                  <button class="btn btn-primary" type="submit">保存记录</button>
                  <button class="btn btn-warning" type="button" id="stationCancelBtn" style="display:none;"
                    onclick="cancelStationEdit()">取消编辑</button>
                  <button class="btn btn-secondary" type="button" onclick="resetStationForm()">清空</button>
                </div>
              </form>
            </div>
          </div>

          <!-- 历史记录 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                  </svg></span>
                历史记录
              </h3>
            </div>
            <div class="card-body">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>期数</th>
                      <th>发布日期</th>
                      <th>主题</th>
                      <th>类型</th>
                      <th>查看人数</th>
                      <th>总人数</th>
                      <th>查看率</th>
                      <th>备注</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="stationTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- AI 分享月 -->
        <div class="ai-panel" id="panel-share">
          <!-- 看板 + 图表 -->
          <div class="ai-top-grid">
            <!-- 左侧看板 -->
            <div class="card ai-kanban-card">
              <div class="card-header">
                <h3 class="card-title card-title-sm">
                  <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path d="M9 11H3v10h6V11zM21 3h-6v18h6V3zM15 7H9v14h6V7z" />
                    </svg></span>
                  本期看板
                </h3>
                <button class="btn btn-sm btn-secondary" onclick="newShareEpisode()">+ 新建期次</button>
              </div>
              <div class="card-body">
                <div class="kanban-episode" id="shareKanbanEpisode">未选择期次</div>
                <div class="kanban-tasks" id="shareKanbanTasks"></div>
              </div>
            </div>
            <!-- 右侧图表 -->
            <div class="card ai-chart-card">
              <div class="card-header">
                <h3 class="card-title card-title-sm">
                  <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path d="M18 20V10M12 20V4M6 20v-6" />
                    </svg></span>
                  参与率趋势
                </h3>
              </div>
              <div class="card-body">
                <div class="chart-container chart-container-md">
                  <canvas id="shareChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- 数据录入 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                  </svg></span>
                数据录入
              </h3>
            </div>
            <div class="card-body">
              <form id="shareForm">
                <div class="form-grid form-grid-5">
                  <div class="form-group">
                    <label class="form-label">期数</label>
                    <input type="number" id="shareEpisode" min="1" placeholder="第几期" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">培训日期</label>
                    <input type="date" id="shareDate" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">本期主题</label>
                    <input type="text" id="shareTitle" placeholder="分享主题" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">参加人数</label>
                    <input type="number" id="shareAttendees" min="0" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">公司总人数</label>
                    <input type="number" id="shareTotal" min="1" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">时长（分钟）</label>
                    <input type="number" id="shareDuration" min="1" placeholder="分钟" required />
                  </div>
                  <div class="form-group span-3">
                    <label class="form-label">备注</label>
                    <input type="text" id="shareNote" placeholder="特殊情况记录（选填）" />
                  </div>
                  <input type="hidden" id="shareId" />
                </div>
                <div class="form-footer">
                  <button class="btn btn-primary" type="submit">保存记录</button>
                  <button class="btn btn-secondary" type="button" onclick="resetShareForm()">清空</button>
                </div>
              </form>
            </div>
          </div>

          <!-- 历史记录 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                  </svg></span>
                历史记录
              </h3>
            </div>
            <div class="card-body">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>期数</th>
                      <th>培训日期</th>
                      <th>主题</th>
                      <th>参加人数</th>
                      <th>总人数</th>
                      <th>参与率</th>
                      <th>时长</th>
                      <th>备注</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="shareTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 预算与开销 -->
      <div class="page" id="page-budget">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
                  <line x1="1" y1="10" x2="23" y2="10" />
                </svg></span>
              预算与开销管理
            </h2>
          </div>
          <div class="card-body">
            <p class="card-intro">按月度记录预算与实际开销，区分常规项目与特殊项目，自动计算剩余金额。</p>
            <form id="budgetForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">月份</label>
                  <input type="month" id="budgetMonth" required />
                </div>
                <div class="form-group">
                  <label class="form-label">类型</label>
                  <select id="budgetType">
                    <option value="regular">常规项目</option>
                    <option value="special">特殊项目</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">预算金额（元）</label>
                  <input type="number" min="0" id="budgetAmount" required />
                </div>
                <div class="form-group">
                  <label class="form-label">实际开销（元）</label>
                  <input type="number" min="0" id="budgetSpent" required />
                </div>
                <div class="form-group span-full">
                  <label class="form-label">备注</label>
                  <textarea id="budgetNote" placeholder="预算说明或开销原因"></textarea>
                </div>
                <input type="hidden" id="budgetId" />
                <div class="form-footer">
                  <button class="btn btn-primary" type="submit">保存记录</button>
                </div>
              </div>
            </form>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>月份</th>
                    <th>类型</th>
                    <th>预算</th>
                    <th>实际</th>
                    <th>剩余</th>
                    <th>备注</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="budgetTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <input type="file" id="filePicker" accept="application/json" style="display:none;" />

  <!-- Toast 容器 -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- 确认弹窗 -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <div class="modal-header" id="confirmTitle">确认操作</div>
      <div class="modal-body" id="confirmMessage">您确定要执行此操作吗？</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeConfirm(false)">取消</button>
        <button class="btn btn-primary" id="confirmBtn" onclick="closeConfirm(true)">确认</button>
      </div>
    </div>
  </div>

  <script>
    const uid = () => Math.random().toString(36).slice(2, 10);
    const STORAGE_KEY = 'surfin_ld_system_v2';

    const state = {
      sessions: [],
      budgets: [],
      aiStations: [],
      aiShares: [],
      aiStationTasks: [],
      aiShareTasks: [],
      currentStationEpisode: null,
      currentShareEpisode: null
    };

    const pageTitles = {
      dashboard: '培训大屏',
      training: '培训管理',
      aiknowledge: 'AI 知识库',
      budget: '预算与开销'
    };

    /* =========================================
       2. 工具函数 (Toast & Modal)
       ========================================= */

    // Toast 提示
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      let icon = '';
      if (type === 'success') icon = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
      else if (type === 'error') icon = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
      else icon = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';

      toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
      container.appendChild(toast);

      // 3秒后移除
      setTimeout(() => {
        toast.style.animation = 'toast-out 0.3s forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Confirm 弹窗
    let currentConfirmCallback = null;
    const modalEl = document.getElementById('confirmModal');

    function showConfirm(message, onConfirm) {
      document.getElementById('confirmMessage').textContent = message;
      modalEl.classList.add('active');
      currentConfirmCallback = onConfirm;
    }

    window.closeConfirm = function (confirmed) {
      modalEl.classList.remove('active');
      if (confirmed && currentConfirmCallback) {
        currentConfirmCallback();
      }
      currentConfirmCallback = null;
    };

    // 主题切换
    function setTheme(theme) {
      if (theme === 'default') {
        document.body.removeAttribute('data-theme');
      } else {
        document.body.setAttribute('data-theme', theme);
      }
      localStorage.setItem('surfin_theme', theme);
      document.getElementById('themeDropdown').classList.remove('active');
      showToast(`已切换至「${getThemeName(theme)}」主题`, 'info');
      // 触发图表刷新以适配背景
      setTimeout(renderAll, 300);
    }

    function getThemeName(theme) {
      const names = { default: '经典原力', dark: '暗夜星辰', wine: '流金岁月', mint: '生机薄荷', craft: '匠心工匠' };
      return names[theme] || '未知';
    }

    function toggleThemeDropdown(e) {
      e.stopPropagation();
      document.getElementById('themeDropdown').classList.toggle('active');
    }

    document.addEventListener('click', () => {
      document.getElementById('themeDropdown').classList.remove('active');
    });

    /* =========================================
       3. 数据初始化 & 逻辑
       ========================================= */

    function initData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        Object.assign(state, JSON.parse(raw));
      } else {
        // 初始嵌入数据：确保 GitHub Pages 打开即有数据
        state.sessions = [
          { id: "kqdwlix8", date: "2024-08-12", course: "安全规范", project: "项目 Alpha", lecturer: "王工", people: 15, duration: 1.5, note: "设备安全" },
          { id: "wauqqfqc", date: "2024-08-05", course: "新员工入职", project: "总部培训", lecturer: "刘老师", people: 20, duration: 2, note: "流程介绍" }
        ];
        state.budgets = [
          { id: "wd3yzklf", month: "2024-08", type: "regular", amount: 15000, spent: 6200, note: "月度常规培训" },
          { id: "d3avcho5", month: "2024-08", type: "special", amount: 8000, spent: 4500, note: "专项技术提升" }
        ];
        state.aiStations = [
          { id: "ep23", episode: 23, date: "2024-08-01", title: "我被Gamma圈粉的八大亮点功能，绝对是 AI PPT 领域首选产品", views: 247, total: 260, category: "tool", note: "" },
          { id: "ep22", episode: 22, date: "2024-07-31", title: "OpenAI 发布 AI 搜索产品，有两大亮点不够惊艳", views: 238, total: 260, category: "news", note: "" },
          { id: "ep21", episode: 21, date: "2024-07-30", title: "两辆自动驾驶跑车展示《速度与激情》，AI 学会飘移只为一个极端场景", views: 230, total: 260, category: "news", note: "" },
          { id: "ep20", episode: 20, date: "2024-07-29", title: "AI 大神卡帕西公开神秘创业项目，专注 AI+教育，打造 AI原生学校", views: 251, total: 260, category: "news", note: "" },
          { id: "ep19", episode: 19, date: "2024-07-26", title: "日本总务省发布 AI白皮书：中国 AI 使用率领先全球，个人和企业都在用", views: 240, total: 260, category: "report", note: "" },
          { id: "ep18", episode: 18, date: "2024-07-25", title: "李飞飞自传《我看见的世界》，体验一次奇妙的阅读体验", views: 238, total: 260, category: "book", note: "" },
          { id: "ep17", episode: 17, date: "2024-07-24", title: "陈坤指导首部 AI 短剧《山海奇境之劈波斩浪》上映，分享 3 点观剧感受", views: 238, total: 260, category: "news", note: "" },
          { id: "ep16", episode: 16, date: "2024-07-23", title: "AI 投资人张津剑：三个关键词找到 AI 时代的机会信号", views: 239, total: 260, category: "news", note: "" },
          { id: "ep15", episode: 15, date: "2024-07-22", title: "OpenAI 发论文拿小学数学题开刀，AI 自问自答左右互搏攻防战", views: 244, total: 260, category: "paper", note: "" },
          { id: "ep14", episode: 14, date: "2024-07-19", title: "眼见不再为实？研究称仅六成用户能分清 AI 作品与人类作品", views: 240, total: 260, category: "report", note: "" },
          { id: "ep13", episode: 13, date: "2024-07-18", title: "畅想人形机器人的未来，这件事你必须知道", views: 234, total: 260, category: "news", note: "" },
          { id: "ep12", episode: 12, date: "2024-07-17", title: "OpenAI 内部推出 AI 能力五级模型，推理能力提升到底能给我们带来什么？", views: 199, total: 260, category: "news", note: "" },
          { id: "ep11", episode: 11, date: "2024-07-16", title: "萝卜快跑无人驾驶会是个抢人类饭碗的开始吗？", views: 245, total: 260, category: "news", note: "" },
          { id: "ep10", episode: 10, date: "2024-07-15", title: "中国 AI 教育类产品很能打，真题对比实测九章大模型和 GPT4o", views: 238, total: 260, category: "tool", note: "" },
          { id: "ep09", episode: 9, date: "2024-07-12", title: "AI 如何融入教育？看 MagicSchool深度定制教学场景", views: 248, total: 260, category: "tool", note: "" },
          { id: "ep08", episode: 8, date: "2024-07-11", title: "Kimi官方发布的浏览器插件！不完美但依旧值得推荐！", views: 250, total: 260, category: "tool", note: "" },
          { id: "ep07", episode: 7, date: "2024-07-10", title: "快手可灵 AI 生成视频五大特色让它成为“Sora 杀手”", views: 227, total: 260, category: "tool", note: "" },
          { id: "ep06", episode: 6, date: "2024-07-09", title: "清华团队构建 AI 版主题医院，准确率达 93%", views: 236, total: 260, category: "paper", note: "" },
          { id: "ep05", episode: 5, date: "2024-07-08", title: "如何让机器人陪伴孤独老人", views: 230, total: 260, category: "news", note: "" },
          { id: "ep04", episode: 4, date: "2024-07-05", title: "2024 年全球最急需的 9 大技能", views: 250, total: 260, category: "report", note: "" },
          { id: "ep03", episode: 3, date: "2024-07-04", title: "设计软件 Figma 带来重大更新", views: 220, total: 260, category: "tool", note: "" },
          { id: "ep02", episode: 2, date: "2024-07-03", title: "麦当劳将关闭AI语音点餐系统", views: 236, total: 260, category: "news", note: "" },
          { id: "ep01", episode: 1, date: "2024-07-02", title: "推荐国产好用的垂直 AI 搜索引擎", views: 232, total: 260, category: "tool", note: "" },
          { id: "ep00", episode: 0, date: "2024-07-01", title: "Surfin AI 广播站发刊词", views: 230, total: 260, category: "news", note: "" }
        ];
        state.aiShares = [
          { id: "rt8uuyen", episode: 12, date: "2024-12-10", title: "AI 提示词工程实战", attendees: 45, total: 320, duration: 60, note: "" },
          { id: "1dfksvqo", episode: 11, date: "2024-11-12", title: "ChatGPT 高级技巧", attendees: 52, total: 315, duration: 45, note: "" }
        ];
        state.aiStationTasks = [];
        state.aiShareTasks = [];
        state.currentStationEpisode = null;
        state.currentShareEpisode = null;
        persist();
      }
    }

    function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function calcManHours(s) { return Number(s.people) * Number(s.duration); }

    // 侧边栏收起/展开
    const sidebar = document.getElementById('sidebar');
    const mainWrapper = document.querySelector('.main-wrapper');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOpen = document.getElementById('sidebarOpen');

    // 从 localStorage 读取侧边栏状态
    const sidebarCollapsed = localStorage.getItem('sidebar_collapsed') === 'true';
    if (sidebarCollapsed) {
      sidebar.classList.add('collapsed');
      mainWrapper.classList.add('expanded');
    }

    function toggleSidebar(collapse) {
      if (collapse) {
        sidebar.classList.add('collapsed');
        mainWrapper.classList.add('expanded');
      } else {
        sidebar.classList.remove('collapsed');
        mainWrapper.classList.remove('expanded');
      }
      localStorage.setItem('sidebar_collapsed', collapse);
    }

    sidebarToggle.addEventListener('click', () => toggleSidebar(true));
    sidebarOpen.addEventListener('click', () => toggleSidebar(false));

    // 导航
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.dataset.page;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + page).classList.add('active');
        document.getElementById('pageTitle').textContent = pageTitles[page];
      });
    });

    function renderSessions() {
      const tbody = document.getElementById('sessionTable');
      tbody.innerHTML = '';
      if (state.sessions.length === 0) {
        tbody.innerHTML = '<tr><td class="empty-cell" colspan="9">暂无培训记录</td></tr>';
        return;
      }
      state.sessions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.date}</td>
          <td>${item.course}</td>
          <td>${item.project}</td>
          <td>${item.lecturer}</td>
          <td>${item.people}</td>
          <td>${item.duration}h</td>
          <td><strong>${calcManHours(item)}</strong></td>
          <td>${item.note || '-'}</td>
          <td>
            <div class="actions-row">
              <button class="btn btn-edit" onclick="editSession('${item.id}')">编辑</button>
              <button class="btn btn-delete" onclick="deleteSession('${item.id}')">删除</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderBudgets() {
      const tbody = document.getElementById('budgetTable');
      tbody.innerHTML = '';
      if (state.budgets.length === 0) {
        tbody.innerHTML = '<tr><td class="empty-cell" colspan="7">暂无预算记录</td></tr>';
        return;
      }
      state.budgets.sort((a, b) => b.month.localeCompare(a.month)).forEach(item => {
        const remain = Number(item.amount) - Number(item.spent);
        const typeLabel = item.type === 'regular' ? '<span class="tag tag-primary">常规</span>' : '<span class="tag tag-warning">特殊</span>';
        const remainClass = remain >= 0 ? 'val-positive' : 'val-negative';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.month}</td>
          <td>${typeLabel}</td>
          <td>¥${item.amount.toLocaleString()}</td>
          <td>¥${item.spent.toLocaleString()}</td>
          <td class="${remainClass}">¥${remain.toLocaleString()}</td>
          <td>${item.note || '-'}</td>
          <td>
            <div class="actions-row">
              <button class="btn btn-edit" onclick="editBudget('${item.id}')">编辑</button>
              <button class="btn btn-delete" onclick="deleteBudget('${item.id}')">删除</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function resetSessionForm() { document.getElementById('sessionForm').reset(); document.getElementById('sessionId').value = ''; }
    function resetBudgetForm() { document.getElementById('budgetForm').reset(); document.getElementById('budgetId').value = ''; }

    window.editSession = function (id) {
      const item = state.sessions.find(s => s.id === id);
      if (!item) return;
      document.getElementById('sessionId').value = item.id;
      document.getElementById('sessionDate').value = item.date;
      document.getElementById('sessionCourse').value = item.course;
      document.getElementById('sessionProject').value = item.project;
      document.getElementById('sessionLecturer').value = item.lecturer;
      document.getElementById('sessionPeople').value = item.people;
      document.getElementById('sessionDuration').value = item.duration;
      document.getElementById('sessionNote').value = item.note;
      document.querySelector('.nav-item[data-page="training"]').click();
    };

    window.deleteSession = function (id) {
      showConfirm('确认删除这条培训记录吗？此操作不可恢复。', () => {
        state.sessions = state.sessions.filter(s => s.id !== id);
        persist(); renderAll();
        showToast('记录已删除', 'success');
      });
    };

    window.editBudget = function (id) {
      const item = state.budgets.find(s => s.id === id);
      if (!item) return;
      document.getElementById('budgetId').value = item.id;
      document.getElementById('budgetMonth').value = item.month;
      document.getElementById('budgetType').value = item.type;
      document.getElementById('budgetAmount').value = item.amount;
      document.getElementById('budgetSpent').value = item.spent;
      document.getElementById('budgetNote').value = item.note;
      document.querySelector('.nav-item[data-page="budget"]').click();
    };

    window.deleteBudget = function (id) {
      showConfirm('确认删除这条预算记录吗？此操作不可恢复。', () => {
        state.budgets = state.budgets.filter(s => s.id !== id);
        persist(); renderAll();
        showToast('记录已删除', 'success');
      });
    };

    function renderStats() {
      const now = new Date();
      const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const monthSessions = state.sessions.filter(s => s.date.startsWith(monthStr));
      const totalHours = monthSessions.reduce((sum, s) => sum + calcManHours(s), 0);
      const latest = monthSessions.sort((a, b) => new Date(b.date) - new Date(a.date))[0];

      document.getElementById('statSessions').textContent = monthSessions.length;
      document.getElementById('statHours').textContent = totalHours.toLocaleString();
      document.getElementById('statUpcoming').textContent = latest ? `最近：${latest.course}` : '最近培训：-';

      const monthBudgets = state.budgets.filter(b => b.month === monthStr);
      const budgetTotal = monthBudgets.reduce((s, b) => s + Number(b.amount), 0);
      const spentTotal = monthBudgets.reduce((s, b) => s + Number(b.spent), 0);
      const usage = budgetTotal ? Math.round((spentTotal / budgetTotal) * 100) : 0;

      document.getElementById('statBudgetUsage').textContent = `${usage}%`;
      document.getElementById('statBudgetRemain').textContent = budgetTotal ? `剩余：¥${(budgetTotal - spentTotal).toLocaleString()}` : '剩余预算：-';

      const specialSpent = monthBudgets.filter(b => b.type === 'special').reduce((s, b) => s + Number(b.spent), 0);
      document.getElementById('statSpecialSpend').textContent = `¥${specialSpent.toLocaleString()}`;
    }

    let hoursChart, budgetChart, costPie;

    function renderCharts() {
      const colors = {
        primary: '#0F4264',
        primaryLight: '#2D71A1',
        primaryAlpha: 'rgba(15, 66, 100, 0.1)',
        accent: '#F59E0B',
        grid: 'rgba(0, 0, 0, 0.06)',
        text: '#A0AEC0'
      };

      const byMonth = {};
      state.sessions.forEach(s => {
        const month = s.date.slice(0, 7);
        byMonth[month] = (byMonth[month] || 0) + calcManHours(s);
      });
      const monthLabels = Object.keys(byMonth).sort();
      const hoursData = monthLabels.map(m => byMonth[m]);

      if (hoursChart) hoursChart.destroy();
      hoursChart = new Chart(document.getElementById('hoursChart'), {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: '总人时',
            data: hoursData,
            borderColor: colors.primary,
            backgroundColor: colors.primaryAlpha,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: colors.primary,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: colors.text, font: { size: 11 } } },
            y: { grid: { color: colors.grid }, ticks: { color: colors.text, font: { size: 11 } } }
          }
        }
      });

      const months = [...new Set(state.budgets.map(b => b.month))].sort();
      const budgetAmount = months.map(m => state.budgets.filter(b => b.month === m).reduce((s, b) => s + Number(b.amount), 0));
      const budgetSpent = months.map(m => state.budgets.filter(b => b.month === m).reduce((s, b) => s + Number(b.spent), 0));

      if (budgetChart) budgetChart.destroy();
      budgetChart = new Chart(document.getElementById('budgetChart'), {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            { label: '预算', data: budgetAmount, backgroundColor: colors.primary, borderRadius: 6, barThickness: 32, maxBarThickness: 40 },
            { label: '实际', data: budgetSpent, backgroundColor: '#FA8072', borderRadius: 6, barThickness: 32, maxBarThickness: 40 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, pointStyle: 'rect', font: { size: 11 }, color: colors.text, padding: 12 } } },
          scales: {
            x: { grid: { display: false }, ticks: { color: colors.text, font: { size: 11 } } },
            y: { grid: { color: colors.grid }, ticks: { color: colors.text, font: { size: 11 } } }
          }
        }
      });

      const costRegular = state.budgets.filter(b => b.type === 'regular').reduce((s, b) => s + Number(b.spent), 0);
      const costSpecial = state.budgets.filter(b => b.type === 'special').reduce((s, b) => s + Number(b.spent), 0);
      const totalSpent = costRegular + costSpecial;

      // 圆心文字插件
      const centerTextPlugin = {
        id: 'centerText',
        beforeDraw: function (chart) {
          if (chart.config.type !== 'doughnut') return;
          const { ctx, chartArea } = chart;
          if (!chartArea) return;

          // 计算圆环真正的圆心位置
          const centerX = (chartArea.left + chartArea.right) / 2;
          const centerY = (chartArea.top + chartArea.bottom) / 2;

          ctx.restore();

          // 总支出标签
          ctx.font = '500 12px "Helvetica Neue", sans-serif';
          ctx.fillStyle = colors.text;
          ctx.textBaseline = 'middle';
          ctx.textAlign = 'center';
          ctx.fillText('总支出', centerX, centerY - 10);

          // 金额
          ctx.font = '700 20px "Helvetica Neue", sans-serif';
          ctx.fillStyle = colors.primary;
          ctx.fillText('¥' + totalSpent.toLocaleString(), centerX, centerY + 12);

          ctx.save();
        }
      };

      if (costPie) costPie.destroy();
      costPie = new Chart(document.getElementById('costPie'), {
        type: 'doughnut',
        data: {
          labels: ['常规开销', '特殊开销'],
          datasets: [{
            data: [costRegular, costSpecial],
            backgroundColor: [colors.primary, '#FA8072'],
            borderWidth: 0,
            hoverOffset: 4,
            borderRadius: 6,
            spacing: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '72%',
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rect', font: { size: 11 }, color: colors.text, padding: 16 } } }
        },
        plugins: [centerTextPlugin]
      });
    }

    // 导出功能
    window.exportJson = function () {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'surfin-ld-data.json'; a.click();
      URL.revokeObjectURL(url);
    };

    window.importJson = function () {
      document.getElementById('filePicker').click();
    };

    document.getElementById('filePicker').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data.sessions || !data.budgets) throw new Error('缺少关键字段');
          state.sessions = data.sessions;
          state.budgets = data.budgets;
          persist(); renderAll();
          showToast('数据导入成功', 'success');
        } catch (err) { showToast('导入失败：' + err.message, 'error'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    window.exportExcel = function () {
      const wb = XLSX.utils.book_new();

      // 培训记录表
      const sessionsData = state.sessions.map(s => ({
        '时间': s.date,
        '课程': s.course,
        '项目': s.project,
        '讲师': s.lecturer,
        '人数': s.people,
        '时长(h)': s.duration,
        '总人时': calcManHours(s),
        '备注': s.note || ''
      }));
      const ws1 = XLSX.utils.json_to_sheet(sessionsData);
      XLSX.utils.book_append_sheet(wb, ws1, '培训记录');

      // 预算记录表
      const budgetsData = state.budgets.map(b => ({
        '月份': b.month,
        '类型': b.type === 'regular' ? '常规' : '特殊',
        '预算': b.amount,
        '实际': b.spent,
        '剩余': b.amount - b.spent,
        '备注': b.note || ''
      }));
      const ws2 = XLSX.utils.json_to_sheet(budgetsData);
      XLSX.utils.book_append_sheet(wb, ws2, '预算开销');

      XLSX.writeFile(wb, 'Surfin学习发展数据.xlsx');
    };

    window.exportPdf = async function () {
      const activePageId = document.querySelector('.page.active').id;
      const element = document.querySelector('.page.active');
      const canvas = await html2canvas(element, { scale: 3, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
      const imgWidth = imgProps.width * ratio * 0.9;
      const imgHeight = imgProps.height * ratio * 0.9;
      pdf.addImage(imgData, 'PNG', (pageWidth - imgWidth) / 2, 10, imgWidth, imgHeight);
      pdf.save(`Surfin-${pageTitles[activePageId.replace('page-', '')]}.pdf`);
    };

    function renderAll() {
      renderSessions();
      renderBudgets();
      renderStats();
      renderCharts();
      persist();
    }

    document.getElementById('sessionForm').addEventListener('submit', e => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('sessionId').value || uid(),
        date: document.getElementById('sessionDate').value,
        course: document.getElementById('sessionCourse').value,
        project: document.getElementById('sessionProject').value,
        lecturer: document.getElementById('sessionLecturer').value,
        people: Number(document.getElementById('sessionPeople').value),
        duration: Number(document.getElementById('sessionDuration').value),
        note: document.getElementById('sessionNote').value
      };
      const existing = state.sessions.find(s => s.id === payload.id);
      if (existing) Object.assign(existing, payload);
      else state.sessions.push(payload);
      resetSessionForm(); renderAll();
      showToast('培训记录已保存', 'success');
    });

    document.getElementById('budgetForm').addEventListener('submit', e => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('budgetId').value || uid(),
        month: document.getElementById('budgetMonth').value,
        type: document.getElementById('budgetType').value,
        amount: Number(document.getElementById('budgetAmount').value),
        spent: Number(document.getElementById('budgetSpent').value),
        note: document.getElementById('budgetNote').value
      };
      const existing = state.budgets.find(b => b.id === payload.id);
      if (existing) Object.assign(existing, payload);
      else state.budgets.push(payload);
      resetBudgetForm(); renderAll();
      showToast('预算记录已保存', 'success');
    });

    // 初始化
    initData();
    // 加载主题
    const savedTheme = localStorage.getItem('surfin_theme');
    if (savedTheme) {
      if (savedTheme === 'default') document.body.removeAttribute('data-theme');
      else document.body.setAttribute('data-theme', savedTheme);
    }
    renderAll();

    // ============ AI 知识库功能 ============

    // Tab 切换
    document.querySelectorAll('.ai-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.ai-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
      });
    });

    // 任务模板
    const stationTaskTemplate = ['选题确定', '内容撰写', '制作发布', '数据回收'];
    const shareTaskTemplate = ['主题确定', '课件准备', '发布通知', '培训执行', '数据回收'];

    // 分类标签映射
    const categoryMap = {
      news: { label: 'AI 新闻', class: 'tag-news' },
      tool: { label: 'AI 工具', class: 'tag-tool' },
      paper: { label: 'AI 论文', class: 'tag-paper' },
      thought: { label: 'AI 思考', class: 'tag-thought' },
      mixed: { label: '综合', class: 'tag-mixed' }
    };

    // 图表实例
    let stationChart = null;
    let shareChart = null;
    let stationChartRange = { start: 0, count: 12 };

    // 渲染广播站表格
    function renderStations() {
      const tbody = document.getElementById('stationTable');
      tbody.innerHTML = '';
      if (state.aiStations.length === 0) {
        tbody.innerHTML = '<tr><td class="empty-cell" colspan="9">暂无广播站记录</td></tr>';
        return;
      }
      state.aiStations.sort((a, b) => b.episode - a.episode).forEach(item => {
        const rate = ((item.views / item.total) * 100).toFixed(1);
        const rateClass = rate >= 90 ? 'rate-good' : rate >= 80 ? 'rate-mid' : 'rate-low';
        const cat = categoryMap[item.category] || categoryMap.mixed;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>第 ${item.episode} 期</strong></td>
          <td>${item.date}</td>
          <td>${item.title}</td>
          <td><span class="tag ${cat.class}">${cat.label}</span></td>
          <td>${item.views}</td>
          <td>${item.total}</td>
          <td class="${rateClass}">${rate}%</td>
          <td>${item.note || '-'}</td>
          <td>
            <div class="actions-row">
              <button class="btn btn-edit" onclick="editStation('${item.id}')">编辑</button>
              <button class="btn btn-delete" onclick="deleteStation('${item.id}')">删除</button>
            </div>
          </td>
        `;
        row.addEventListener('click', (e) => {
          if (!e.target.closest('button')) highlightStationChart(item.episode);
        });
        tbody.appendChild(row);
      });
    }

    // 渲染分享月表格
    function renderShares() {
      const tbody = document.getElementById('shareTable');
      tbody.innerHTML = '';
      if (state.aiShares.length === 0) {
        tbody.innerHTML = '<tr><td class="empty-cell" colspan="9">暂无分享月记录</td></tr>';
        return;
      }
      state.aiShares.sort((a, b) => b.episode - a.episode).forEach(item => {
        const rate = ((item.attendees / item.total) * 100).toFixed(1);
        const rateClass = rate >= 20 ? 'rate-good' : rate >= 15 ? 'rate-mid' : 'rate-low';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>第 ${item.episode} 期</strong></td>
          <td>${item.date}</td>
          <td>${item.title}</td>
          <td>${item.attendees}</td>
          <td>${item.total}</td>
          <td class="${rateClass}">${rate}%</td>
          <td>${item.duration} 分钟</td>
          <td>${item.note || '-'}</td>
          <td>
            <div class="actions-row">
              <button class="btn btn-edit" onclick="editShare('${item.id}')">编辑</button>
              <button class="btn btn-delete" onclick="deleteShare('${item.id}')">删除</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // 渲染广播站图表
    function renderStationChart() {
      const ctx = document.getElementById('stationChart');
      if (!ctx) return;

      const sorted = [...state.aiStations].sort((a, b) => a.episode - b.episode);
      const total = sorted.length;
      const start = Math.max(0, total - stationChartRange.count - stationChartRange.start);
      const end = total - stationChartRange.start;
      const data = sorted.slice(start, end);

      const labels = data.map(d => `第${d.episode}期`);
      const views = data.map(d => d.views);
      const rates = data.map(d => ((d.views / d.total) * 100).toFixed(1));

      if (stationChart) stationChart.destroy();
      stationChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: '查看人数',
              data: views,
              backgroundColor: 'rgba(15, 66, 100, 0.7)',
              borderRadius: 4,
              barThickness: 24,
              yAxisID: 'y'
            },
            {
              label: '查看率',
              data: rates,
              type: 'line',
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              pointRadius: 4,
              pointBackgroundColor: '#10B981',
              tension: 0.3,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', align: 'end', labels: { usePointStyle: true, font: { size: 11 } } }
          },
          scales: {
            x: { grid: { display: false } },
            y: { position: 'left', title: { display: true, text: '人数' }, grid: { color: 'rgba(0,0,0,0.05)' } },
            y1: { position: 'right', title: { display: true, text: '查看率 %' }, min: 0, max: 100, grid: { display: false } }
          }
        }
      });
    }

    // 渲染分享月图表
    function renderShareChart() {
      const ctx = document.getElementById('shareChart');
      if (!ctx) return;

      const sorted = [...state.aiShares].sort((a, b) => a.episode - b.episode);
      const labels = sorted.map(d => `第${d.episode}期`);
      const attendees = sorted.map(d => d.attendees);
      const rates = sorted.map(d => ((d.attendees / d.total) * 100).toFixed(1));

      if (shareChart) shareChart.destroy();
      shareChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: '参加人数',
              data: attendees,
              backgroundColor: 'rgba(15, 66, 100, 0.7)',
              borderRadius: 4,
              barThickness: 32,
              yAxisID: 'y'
            },
            {
              label: '参与率',
              data: rates,
              type: 'line',
              borderColor: '#F59E0B',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 2,
              pointRadius: 4,
              pointBackgroundColor: '#F59E0B',
              tension: 0.3,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', align: 'end', labels: { usePointStyle: true, font: { size: 11 } } }
          },
          scales: {
            x: { grid: { display: false } },
            y: { position: 'left', title: { display: true, text: '人数' }, grid: { color: 'rgba(0,0,0,0.05)' } },
            y1: { position: 'right', title: { display: true, text: '参与率 %' }, min: 0, max: 50, grid: { display: false } }
          }
        }
      });
    }

    // 图表缩放
    window.zoomStationChart = function (action) {
      const total = state.aiStations.length;
      if (action === 'in') {
        stationChartRange.count = Math.max(6, stationChartRange.count - 3);
      } else if (action === 'out') {
        stationChartRange.count = Math.min(total, stationChartRange.count + 3);
      } else {
        stationChartRange = { start: 0, count: 12 };
      }
      renderStationChart();
    };

    // 高亮图表某期
    function highlightStationChart(episode) {
      const sorted = [...state.aiStations].sort((a, b) => a.episode - b.episode);
      const idx = sorted.findIndex(d => d.episode === episode);
      if (idx >= 0 && stationChart) {
        stationChart.setActiveElements([{ datasetIndex: 0, index: idx }]);
        stationChart.update();
      }
    }

    // 渲染热力图
    function renderStationHeatmap() {
      const container = document.getElementById('stationHeatmap');
      const yearSelect = document.getElementById('stationHeatmapYear');
      if (!container || !yearSelect) return;

      // 初始化年份选择器
      const years = [...new Set(state.aiStations.map(s => new Date(s.date).getFullYear()))].sort((a, b) => b - a);
      if (years.length === 0) years.push(new Date().getFullYear());
      if (yearSelect.options.length === 0) {
        years.forEach(y => {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y + ' 年';
          yearSelect.appendChild(opt);
        });
      }

      const year = parseInt(yearSelect.value) || years[0];
      const startDate = new Date(year, 0, 1);
      const endDate = new Date(year, 11, 31);

      // 按日期索引数据
      const dataMap = {};
      state.aiStations.forEach(s => {
        const d = new Date(s.date);
        if (d.getFullYear() === year) {
          const key = s.date;
          dataMap[key] = { rate: (s.views / s.total) * 100, title: s.title, episode: s.episode };
        }
      });

      container.innerHTML = '';

      // 生成周列
      let currentDate = new Date(startDate);
      currentDate.setDate(currentDate.getDate() - currentDate.getDay()); // 从周日开始

      while (currentDate <= endDate || currentDate.getDay() !== 0) {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'heatmap-week';

        for (let i = 0; i < 7; i++) {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'heatmap-day';

          const dateStr = currentDate.toISOString().split('T')[0];
          const data = dataMap[dateStr];

          if (currentDate >= startDate && currentDate <= endDate) {
            if (data) {
              const level = data.rate >= 95 ? 4 : data.rate >= 90 ? 3 : data.rate >= 85 ? 2 : 1;
              dayDiv.dataset.level = level;
              dayDiv.innerHTML = `<div class="heatmap-tooltip">第${data.episode}期: ${data.title}<br>${data.rate.toFixed(1)}%</div>`;
            }
          } else {
            dayDiv.style.visibility = 'hidden';
          }

          weekDiv.appendChild(dayDiv);
          currentDate.setDate(currentDate.getDate() + 1);
        }

        container.appendChild(weekDiv);
      }
    }

    // 看板渲染
    function renderStationKanban() {
      const episodeEl = document.getElementById('stationKanbanEpisode');
      const tasksEl = document.getElementById('stationKanbanTasks');

      if (!state.currentStationEpisode) {
        episodeEl.textContent = '未选择期次';
        episodeEl.classList.remove('active');
        tasksEl.innerHTML = '<div class="kanban-empty">点击「新建期次」开始</div>';
        return;
      }

      episodeEl.textContent = `第 ${state.currentStationEpisode} 期`;
      episodeEl.classList.add('active');

      const tasks = state.aiStationTasks.filter(t => t.episode === state.currentStationEpisode);
      if (tasks.length === 0) {
        tasksEl.innerHTML = '<div class="kanban-empty">暂无任务</div>';
        return;
      }

      tasksEl.innerHTML = tasks.map(t => `
        <div class="kanban-task ${t.done ? 'done' : ''}" onclick="toggleStationTask('${t.id}')">
          <span class="task-checkbox">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </span>
          <span>${t.name}</span>
        </div>
      `).join('');
    }

    function renderShareKanban() {
      const episodeEl = document.getElementById('shareKanbanEpisode');
      const tasksEl = document.getElementById('shareKanbanTasks');

      if (!state.currentShareEpisode) {
        episodeEl.textContent = '未选择期次';
        episodeEl.classList.remove('active');
        tasksEl.innerHTML = '<div class="kanban-empty">点击「新建期次」开始</div>';
        return;
      }

      episodeEl.textContent = `第 ${state.currentShareEpisode} 期`;
      episodeEl.classList.add('active');

      const tasks = state.aiShareTasks.filter(t => t.episode === state.currentShareEpisode);
      if (tasks.length === 0) {
        tasksEl.innerHTML = '<div class="kanban-empty">暂无任务</div>';
        return;
      }

      tasksEl.innerHTML = tasks.map(t => `
        <div class="kanban-task ${t.done ? 'done' : ''}" onclick="toggleShareTask('${t.id}')">
          <span class="task-checkbox">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </span>
          <span>${t.name}</span>
        </div>
      `).join('');
    }

    // 新建期次
    window.newStationEpisode = function () {
      const maxEpisode = state.aiStations.length > 0 ? Math.max(...state.aiStations.map(s => s.episode)) : 0;
      const newEpisode = maxEpisode + 1;
      state.currentStationEpisode = newEpisode;

      // 复制任务模板
      stationTaskTemplate.forEach(name => {
        state.aiStationTasks.push({ id: uid(), episode: newEpisode, name, done: false });
      });

      persist();
      renderStationKanban();
      document.getElementById('stationEpisode').value = newEpisode;
    };

    window.newShareEpisode = function () {
      const maxEpisode = state.aiShares.length > 0 ? Math.max(...state.aiShares.map(s => s.episode)) : 0;
      const newEpisode = maxEpisode + 1;
      state.currentShareEpisode = newEpisode;

      shareTaskTemplate.forEach(name => {
        state.aiShareTasks.push({ id: uid(), episode: newEpisode, name, done: false });
      });

      persist();
      renderShareKanban();
      document.getElementById('shareEpisode').value = newEpisode;
    };

    // 切换任务状态
    window.toggleStationTask = function (id) {
      const task = state.aiStationTasks.find(t => t.id === id);
      if (task) {
        task.done = !task.done;
        persist();
        renderStationKanban();
      }
    };

    window.toggleShareTask = function (id) {
      const task = state.aiShareTasks.find(t => t.id === id);
      if (task) {
        task.done = !task.done;
        persist();
        renderShareKanban();
      }
    };

    // 表单操作
    function resetStationForm() {
      document.getElementById('stationForm').reset();
      document.getElementById('stationId').value = '';
    }

    function resetShareForm() {
      document.getElementById('shareForm').reset();
      document.getElementById('shareId').value = '';
    }

    window.resetStationForm = resetStationForm;
    window.resetShareForm = resetShareForm;

    window.editStation = function (id) {
      const item = state.aiStations.find(s => s.id === id);
      if (!item) return;
      document.getElementById('stationId').value = item.id;
      document.getElementById('stationEpisode').value = item.episode;
      document.getElementById('stationDate').value = item.date;
      document.getElementById('stationTitle').value = item.title;
      document.getElementById('stationViews').value = item.views;
      document.getElementById('stationTotal').value = item.total;
      document.getElementById('stationCategory').value = item.category;
      document.getElementById('stationNote').value = item.note || '';
      // 自动滚动到表单位置
      document.getElementById('stationForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
      // 显示取消编辑按钮
      document.getElementById('stationCancelBtn').style.display = 'inline-block';
    };

    window.deleteStation = function (id) {
      showConfirm('确认删除这条广播站记录吗？此操作不可恢复。', () => {
        state.aiStations = state.aiStations.filter(s => s.id !== id);
        persist();
        renderAIKnowledge();
        showToast('记录已删除', 'success');
      });
    };

    window.cancelStationEdit = function () {
      resetStationForm();
      document.getElementById('stationCancelBtn').style.display = 'none';
    };

    window.editShare = function (id) {
      const item = state.aiShares.find(s => s.id === id);
      if (!item) return;
      document.getElementById('shareId').value = item.id;
      document.getElementById('shareEpisode').value = item.episode;
      document.getElementById('shareDate').value = item.date;
      document.getElementById('shareTitle').value = item.title;
      document.getElementById('shareAttendees').value = item.attendees;
      document.getElementById('shareTotal').value = item.total;
      document.getElementById('shareDuration').value = item.duration;
      document.getElementById('shareNote').value = item.note || '';
    };

    window.deleteShare = function (id) {
      showConfirm('确认删除这条分享月记录吗？此操作不可恢复。', () => {
        state.aiShares = state.aiShares.filter(s => s.id !== id);
        persist();
        renderAIKnowledge();
        showToast('记录已删除', 'success');
      });
    };

    // 表单提交
    document.getElementById('stationForm').addEventListener('submit', e => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('stationId').value || uid(),
        episode: Number(document.getElementById('stationEpisode').value),
        date: document.getElementById('stationDate').value,
        title: document.getElementById('stationTitle').value,
        views: Number(document.getElementById('stationViews').value),
        total: Number(document.getElementById('stationTotal').value),
        category: document.getElementById('stationCategory').value,
        note: document.getElementById('stationNote').value
      };
      const existing = state.aiStations.find(s => s.id === payload.id);
      if (existing) Object.assign(existing, payload);
      else state.aiStations.push(payload);
      resetStationForm();
      persist();
      renderAIKnowledge();
      showToast('广播站记录已保存', 'success');
    });

    document.getElementById('shareForm').addEventListener('submit', e => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('shareId').value || uid(),
        episode: Number(document.getElementById('shareEpisode').value),
        date: document.getElementById('shareDate').value,
        title: document.getElementById('shareTitle').value,
        attendees: Number(document.getElementById('shareAttendees').value),
        total: Number(document.getElementById('shareTotal').value),
        duration: Number(document.getElementById('shareDuration').value),
        note: document.getElementById('shareNote').value
      };
      const existing = state.aiShares.find(s => s.id === payload.id);
      if (existing) Object.assign(existing, payload);
      else state.aiShares.push(payload);
      resetShareForm();
      persist();
      renderAIKnowledge();
      showToast('分享月记录已保存', 'success');
    });

    // 渲染所有AI知识库内容
    function renderAIKnowledge() {
      renderStations();
      renderShares();
      renderStationChart();
      renderShareChart();
      renderStationHeatmap();
      renderStationKanban();
      renderShareKanban();
    }

    // 初始化AI知识库
    setTimeout(() => {
      renderAIKnowledge();
    }, 100);
  </script>
</body>

</html>