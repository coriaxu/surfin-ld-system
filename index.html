<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Surfin 学习发展系统</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* =========================================
       1. 全局变量 & 基础样式
       ========================================= */
    :root {
      --primary-deep: #122C3F;
      --primary: #1E455F;
      --primary-light: #4B6E86;
      --primary-glow: rgba(75, 110, 134, 0.25);

      --surface-base: #EEF2F6;
      --surface-card: rgba(255, 255, 255, 0.72);
      --surface-elevated: rgba(248, 250, 252, 0.86);
      --surface-sidebar: rgba(12, 34, 52, 0.92);
      --surface-sidebar-strong: rgba(9, 28, 45, 0.98);

      --text-title: #1C2B3A;
      --text-body: #5B6776;
      --text-muted: #9AA6B2;
      --text-inverse: #FFFFFF;
      --text-sidebar: rgba(236, 243, 249, 0.74);
      --text-sidebar-active: #FFFFFF;
      --sidebar-accent: #57C6FF;
      --sidebar-accent-border: rgba(87, 198, 255, 0.6);
      --sidebar-accent-glow: rgba(87, 198, 255, 0.45);
      --sidebar-hover-bg: rgba(87, 198, 255, 0.12);
      --sidebar-active-bg: rgba(87, 198, 255, 0.22);

      --accent-success: #6F9C8D;
      --accent-success-glow: rgba(111, 156, 141, 0.18);
      --accent-warning: #C3A161;
      --accent-warning-glow: rgba(195, 161, 97, 0.2);
      --accent-danger: #C07C7B;
      --accent-danger-glow: rgba(192, 124, 123, 0.16);

      --chart-blue-bottom: rgba(46, 86, 124, 0.9);
      --chart-blue-mid: rgba(93, 134, 176, 0.85);
      --chart-blue-top: rgba(187, 210, 234, 0.85);
      --chart-blue-solid: rgba(46, 86, 124, 0.75);
      --chart-blue-edge: rgba(34, 72, 108, 0.85);
      --chart-green-line: #6FA58B;
      --chart-green-fill: rgba(111, 165, 139, 0.16);
      --chart-grid: rgba(28, 43, 58, 0.08);
      --dashboard-chart-primary: #4FAF88;
      --dashboard-chart-primary-fill: rgba(79, 175, 136, 0.2);
      --dashboard-chart-accent: #E6A35C;

      --border-subtle: rgba(28, 43, 58, 0.08);
      --border-medium: rgba(28, 43, 58, 0.14);
      --glass-border: rgba(255, 255, 255, 0.5);
      --glass-sheen: rgba(255, 255, 255, 0.28);
      --frosted-glow-1: rgba(116, 156, 196, 0.22);
      --frosted-glow-2: rgba(206, 224, 240, 0.35);
      --frosted-glow-3: rgba(232, 238, 245, 0.7);
      --frosted-haze-1: rgba(255, 255, 255, 0.5);
      --frosted-haze-2: rgba(146, 179, 214, 0.25);

      --shadow-ambient: 0 8px 20px rgba(15, 23, 42, 0.08);
      --shadow-elevated: 0 18px 40px rgba(15, 23, 42, 0.12), 0 1px 2px rgba(15, 23, 42, 0.04);
      --shadow-floating: 0 24px 60px rgba(15, 23, 42, 0.18), 0 6px 16px rgba(15, 23, 42, 0.08);
      --shadow-glow-primary: 0 0 24px rgba(30, 69, 95, 0.18), 0 0 46px rgba(75, 110, 134, 0.1);

      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;

      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);

      --sidebar-width: 240px;
      --sidebar-collapsed-width: 0px;
    }

    /* --- [暗夜星辰 - Dark Mode] --- */
    body[data-theme="dark"] {
      --primary-deep: #0A1B2A;
      --primary: #10314B;
      --primary-light: #2B5676;
      --primary-glow: rgba(43, 86, 118, 0.28);
      --surface-base: #020A14;
      --surface-card: rgba(10, 20, 33, 0.72);
      --surface-elevated: rgba(16, 32, 50, 0.82);
      --surface-sidebar: rgba(6, 18, 30, 0.92);
      --surface-sidebar-strong: rgba(4, 14, 24, 0.98);
      --text-title: #E7EDF6;
      --text-body: #A6B3C4;
      --text-muted: #6F8194;
      --text-sidebar: rgba(231, 237, 246, 0.68);
      --sidebar-accent: #4DA8FF;
      --sidebar-accent-border: rgba(77, 168, 255, 0.55);
      --sidebar-accent-glow: rgba(77, 168, 255, 0.4);
      --sidebar-hover-bg: rgba(77, 168, 255, 0.12);
      --sidebar-active-bg: rgba(77, 168, 255, 0.22);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-medium: rgba(255, 255, 255, 0.12);
      --glass-border: rgba(255, 255, 255, 0.14);
      --glass-sheen: rgba(255, 255, 255, 0.06);
      --frosted-glow-1: rgba(43, 86, 118, 0.16);
      --frosted-glow-2: rgba(18, 38, 58, 0.5);
      --frosted-glow-3: rgba(8, 16, 26, 0.85);
      --frosted-haze-1: rgba(18, 34, 52, 0.35);
      --frosted-haze-2: rgba(43, 86, 118, 0.2);
      --dashboard-chart-primary: #3B82F6;
      --dashboard-chart-primary-fill: rgba(59, 130, 246, 0.22);
      --dashboard-chart-accent: #F97316;
      --shadow-ambient: 0 12px 28px rgba(0, 0, 0, 0.45);
      --shadow-elevated: 0 20px 48px rgba(0, 0, 0, 0.55);
    }

    /* --- [流金岁月 - Royal Wine] --- */
    body[data-theme="wine"] {
      --primary-deep: #4B2B2A;
      --primary: #6A3F3E;
      --primary-light: #8E5C5A;
      --primary-glow: rgba(142, 92, 90, 0.22);
      --surface-base: #F4F0F1;
      --surface-card: rgba(255, 255, 255, 0.74);
      --surface-elevated: rgba(252, 248, 248, 0.88);
      --surface-sidebar: rgba(75, 43, 42, 0.92);
      --surface-sidebar-strong: rgba(66, 37, 36, 0.98);
      --text-title: #4C2F2F;
      --text-body: #6F5A5A;
      --text-muted: #A79696;
      --sidebar-accent: #FF8C8A;
      --sidebar-accent-border: rgba(255, 140, 138, 0.55);
      --sidebar-accent-glow: rgba(255, 140, 138, 0.4);
      --sidebar-hover-bg: rgba(255, 140, 138, 0.12);
      --sidebar-active-bg: rgba(255, 140, 138, 0.22);
      --border-subtle: rgba(76, 47, 47, 0.08);
      --border-medium: rgba(76, 47, 47, 0.14);
      --glass-border: rgba(255, 255, 255, 0.55);
      --glass-sheen: rgba(255, 255, 255, 0.26);
      --frosted-glow-1: rgba(161, 113, 111, 0.18);
      --frosted-glow-2: rgba(235, 218, 217, 0.4);
      --frosted-glow-3: rgba(246, 242, 242, 0.7);
      --frosted-haze-1: rgba(255, 255, 255, 0.45);
      --frosted-haze-2: rgba(180, 131, 129, 0.2);
      --dashboard-chart-primary: #E66565;
      --dashboard-chart-primary-fill: rgba(230, 101, 101, 0.22);
      --dashboard-chart-accent: #F4B163;
    }

    /* --- [生机薄荷 - Growth Mint] --- */
    body[data-theme="mint"] {
      --primary-deep: #2B5147;
      --primary: #3C6E5E;
      --primary-light: #6F9C8B;
      --primary-glow: rgba(111, 156, 139, 0.22);
      --surface-base: #EEF4F2;
      --surface-card: rgba(255, 255, 255, 0.72);
      --surface-elevated: rgba(243, 248, 246, 0.88);
      --surface-sidebar: rgba(38, 80, 70, 0.92);
      --surface-sidebar-strong: rgba(31, 68, 59, 0.98);
      --text-title: #2E4B40;
      --text-body: #587165;
      --text-muted: #8FA39A;
      --sidebar-accent: #5BE0A4;
      --sidebar-accent-border: rgba(91, 224, 164, 0.55);
      --sidebar-accent-glow: rgba(91, 224, 164, 0.4);
      --sidebar-hover-bg: rgba(91, 224, 164, 0.12);
      --sidebar-active-bg: rgba(91, 224, 164, 0.22);
      --frosted-glow-1: rgba(124, 166, 154, 0.18);
      --frosted-glow-2: rgba(216, 232, 227, 0.4);
      --frosted-glow-3: rgba(236, 243, 241, 0.7);
      --frosted-haze-1: rgba(255, 255, 255, 0.45);
      --frosted-haze-2: rgba(124, 166, 154, 0.2);
      --dashboard-chart-primary: #36B37E;
      --dashboard-chart-primary-fill: rgba(54, 179, 126, 0.22);
      --dashboard-chart-accent: #FF9F43;
    }

    /* --- [匠心工匠 - Smartisan Craft] --- */
    body[data-theme="craft"] {
      --primary-deep: #2F3338;
      --primary: #4B5058;
      --primary-light: #7B828B;
      --primary-glow: rgba(123, 130, 139, 0.22);
      --surface-base: #EFF0F2;
      --surface-card: rgba(255, 255, 255, 0.72);
      --surface-elevated: rgba(247, 248, 250, 0.86);
      --surface-sidebar: rgba(47, 51, 56, 0.92);
      --surface-sidebar-strong: rgba(40, 44, 48, 0.98);
      --text-title: #25292F;
      --text-body: #4B525A;
      --text-muted: #8A929A;
      --sidebar-accent: #6FB2FF;
      --sidebar-accent-border: rgba(111, 178, 255, 0.55);
      --sidebar-accent-glow: rgba(111, 178, 255, 0.38);
      --sidebar-hover-bg: rgba(111, 178, 255, 0.12);
      --sidebar-active-bg: rgba(111, 178, 255, 0.22);
      --border-subtle: rgba(37, 41, 47, 0.08);
      --border-medium: rgba(37, 41, 47, 0.14);
      --frosted-glow-1: rgba(144, 152, 162, 0.18);
      --frosted-glow-2: rgba(228, 231, 236, 0.45);
      --frosted-glow-3: rgba(242, 244, 247, 0.7);
      --frosted-haze-1: rgba(255, 255, 255, 0.45);
      --frosted-haze-2: rgba(160, 168, 178, 0.22);
      --dashboard-chart-primary: #4F81BD;
      --dashboard-chart-primary-fill: rgba(79, 129, 189, 0.22);
      --dashboard-chart-accent: #F28B82;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: background var(--transition-smooth), border-color var(--transition-smooth), color var(--transition-smooth);
    }

    body {
      background:
        radial-gradient(circle at 15% 0%, var(--frosted-glow-1), transparent 55%),
        radial-gradient(circle at 85% 10%, var(--frosted-glow-2), transparent 52%),
        radial-gradient(circle at 50% 100%, var(--frosted-glow-3), transparent 60%),
        var(--surface-base);
      background-attachment: fixed;
      color: var(--text-body);
      font-family: "Helvetica Neue", -apple-system, "Microsoft YaHei", sans-serif;
      font-size: 15px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      display: flex;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 25% 20%, var(--frosted-haze-1), transparent 40%),
        radial-gradient(circle at 80% 0%, var(--frosted-haze-2), transparent 50%);
      opacity: 0.7;
      pointer-events: none;
      z-index: 0;
    }

    /* 侧边栏 */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--surface-sidebar) 0%, var(--surface-sidebar-strong) 100%);
      min-height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      z-index: 200;
      transition: transform var(--transition-smooth);
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 12px 0 30px rgba(9, 20, 34, 0.25);
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      overflow: hidden;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-inverse);
      letter-spacing: -0.3px;
      white-space: nowrap;
    }

    .sidebar-toggle {
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(255, 255, 255, 0.16);
      border-radius: var(--radius-sm);
      color: var(--text-sidebar);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
      flex-shrink: 0;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .sidebar-toggle:hover {
      background: rgba(255, 255, 255, 0.24);
      color: var(--text-inverse);
    }

    .sidebar-toggle svg {
      width: 16px;
      height: 16px;
    }

    .sidebar-nav {
      flex: 1;
      padding: 16px 12px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-label {
      font-size: 11px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0 12px;
      margin-bottom: 8px;
      white-space: nowrap;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      color: var(--text-sidebar);
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-bottom: 4px;
      border: 1px solid transparent;
      backdrop-filter: blur(8px) saturate(140%);
      -webkit-backdrop-filter: blur(8px) saturate(140%);
    }

    .nav-item:hover {
      background: var(--sidebar-hover-bg);
      border-color: var(--sidebar-accent-border);
      color: var(--text-sidebar-active);
    }

    .nav-item.active {
      background: linear-gradient(135deg, var(--sidebar-active-bg), rgba(255, 255, 255, 0.14));
      border-color: var(--sidebar-accent-border);
      color: var(--text-sidebar-active);
      box-shadow: 0 12px 24px rgba(5, 16, 26, 0.22), 0 0 16px var(--sidebar-accent-glow);
    }

    .nav-item.active svg {
      filter: drop-shadow(0 0 6px var(--sidebar-accent-glow));
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .nav-item span {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
    }

    /* 主内容区 */
    .main-wrapper {
      margin-left: var(--sidebar-width);
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: margin-left var(--transition-smooth);
      position: relative;
      z-index: 1;
    }

    .main-wrapper.expanded {
      margin-left: 0;
    }

    /* Brand mark */
    .brand-mark {
      width: 36px;
      height: 36px;
      background: rgba(255, 255, 255, 0.14);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
    }

    .brand-mark svg {
      width: 20px;
      height: 20px;
      color: var(--text-inverse);
    }

    /* 顶部栏 */
    .topbar {
      background: var(--surface-card);
      backdrop-filter: blur(22px) saturate(180%);
      -webkit-backdrop-filter: blur(22px) saturate(180%);
      border-bottom: 1px solid var(--glass-border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .topbar-open-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--glass-border);
      background: var(--surface-card);
      border-radius: var(--radius-md);
      color: var(--text-body);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
      box-shadow: var(--shadow-ambient);
      backdrop-filter: blur(12px) saturate(160%);
      -webkit-backdrop-filter: blur(12px) saturate(160%);
    }

    .topbar-open-btn:hover {
      background: var(--surface-elevated);
      border-color: var(--primary-light);
      color: var(--primary);
      box-shadow: var(--shadow-elevated);
    }

    .topbar-open-btn svg {
      width: 18px;
      height: 18px;
    }

    .main-wrapper.expanded .topbar-open-btn {
      display: flex;
    }

    .page-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-title);
    }

    .topbar-actions {
      display: flex;
      gap: 8px;
    }

    /* 按钮 */
    .btn {
      border: none;
      border-radius: var(--radius-sm);
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: relative;
    }

    .btn svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      color: var(--text-inverse);
      box-shadow: var(--shadow-ambient);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-elevated), var(--shadow-glow-primary);
    }

    .btn-secondary {
      background: var(--surface-card);
      color: var(--text-body);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(12px) saturate(160%);
      -webkit-backdrop-filter: blur(12px) saturate(160%);
    }

    .btn-secondary:hover {
      background: var(--surface-elevated);
      box-shadow: var(--shadow-ambient);
    }

    .btn-ghost {
      background: transparent;
      color: var(--primary-light);
      padding: 6px 10px;
    }

    .btn-ghost:hover {
      background: var(--primary-glow);
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-edit {
      background: linear-gradient(135deg, #5AD4A1 0%, #2EBF86 100%);
      color: #FFFFFF;
      padding: 5px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(46, 191, 134, 0.32);
    }

    .btn-edit:hover {
      background: linear-gradient(135deg, #66E0AD 0%, #32C98C 100%);
    }

    .btn-delete {
      background: linear-gradient(135deg, #FF8A84 0%, #E65F63 100%);
      color: #FFFFFF;
      padding: 5px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(230, 95, 99, 0.32);
    }

    .btn-delete:hover {
      background: linear-gradient(135deg, #FF9A94 0%, #F06B6E 100%);
    }

    /* 主内容 */
    main {
      flex: 1;
      padding: 24px 32px 40px;
    }

    /* 页面容器 */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* 统计卡片 */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: var(--surface-card);
      border-radius: var(--radius-lg);
      padding: 22px 24px;
      box-shadow: var(--shadow-ambient);
      border: 1px solid var(--glass-border);
      transition: all var(--transition-smooth);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, var(--glass-sheen) 50%, rgba(255, 255, 255, 0) 100%);
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-floating);
    }

    /* 彩色卡片样式 - 更鲜艳的颜色 */
    .stat-card.blue {
      --stat-glow: rgba(86, 143, 197, 0.25);
      --stat-icon-bg: linear-gradient(135deg, rgba(86, 143, 197, 0.6) 0%, rgba(255, 255, 255, 0.7) 100%);
      --stat-icon-color: #2C5E8B;
      background: linear-gradient(135deg, rgba(86, 143, 197, 0.5) 0%, var(--surface-card) 72%);
      border: 1px solid rgba(86, 143, 197, 0.5);
    }

    .stat-card.green {
      --stat-glow: rgba(112, 184, 150, 0.22);
      --stat-icon-bg: linear-gradient(135deg, rgba(112, 184, 150, 0.6) 0%, rgba(255, 255, 255, 0.7) 100%);
      --stat-icon-color: #2E6F5B;
      background: linear-gradient(135deg, rgba(112, 184, 150, 0.5) 0%, var(--surface-card) 72%);
      border: 1px solid rgba(112, 184, 150, 0.5);
    }

    .stat-card.orange {
      --stat-glow: rgba(219, 174, 98, 0.22);
      --stat-icon-bg: linear-gradient(135deg, rgba(219, 174, 98, 0.6) 0%, rgba(255, 255, 255, 0.7) 100%);
      --stat-icon-color: #8A642A;
      background: linear-gradient(135deg, rgba(219, 174, 98, 0.5) 0%, var(--surface-card) 72%);
      border: 1px solid rgba(219, 174, 98, 0.55);
    }

    .stat-card.red {
      --stat-glow: rgba(222, 122, 122, 0.22);
      --stat-icon-bg: linear-gradient(135deg, rgba(222, 122, 122, 0.6) 0%, rgba(255, 255, 255, 0.7) 100%);
      --stat-icon-color: #8D3B3B;
      background: linear-gradient(135deg, rgba(222, 122, 122, 0.48) 0%, var(--surface-card) 72%);
      border: 1px solid rgba(222, 122, 122, 0.5);
    }

    .stat-card.blue,
    .stat-card.green,
    .stat-card.orange,
    .stat-card.red,
    .stat-card.indigo,
    .stat-card.teal,
    .stat-card.gold,
    .stat-card.rose {
      box-shadow: var(--shadow-ambient), 0 18px 36px var(--stat-glow);
    }

    .stat-card.blue:hover,
    .stat-card.green:hover,
    .stat-card.orange:hover,
    .stat-card.red:hover,
    .stat-card.indigo:hover,
    .stat-card.teal:hover,
    .stat-card.gold:hover,
    .stat-card.rose:hover {
      box-shadow: var(--shadow-floating), 0 22px 44px var(--stat-glow);
    }

    .stat-card.blue .stat-label,
    .stat-card.green .stat-label,
    .stat-card.orange .stat-label,
    .stat-card.red .stat-label,
    .stat-card.indigo .stat-label,
    .stat-card.teal .stat-label,
    .stat-card.gold .stat-label,
    .stat-card.rose .stat-label {
      color: var(--text-title);
      font-weight: 600;
    }

    .stat-card.blue .stat-value,
    .stat-card.green .stat-value,
    .stat-card.orange .stat-value,
    .stat-card.red .stat-value,
    .stat-card.indigo .stat-value,
    .stat-card.teal .stat-value,
    .stat-card.gold .stat-value,
    .stat-card.rose .stat-value {
      color: var(--text-title);
      text-shadow: none;
    }

    .stat-card.blue .stat-desc,
    .stat-card.green .stat-desc,
    .stat-card.orange .stat-desc,
    .stat-card.red .stat-desc,
    .stat-card.indigo .stat-desc,
    .stat-card.teal .stat-desc,
    .stat-card.gold .stat-desc,
    .stat-card.rose .stat-desc {
      color: var(--text-body);
      font-weight: 500;
    }

    .stat-card.blue .stat-icon,
    .stat-card.green .stat-icon,
    .stat-card.orange .stat-icon,
    .stat-card.red .stat-icon,
    .stat-card.indigo .stat-icon,
    .stat-card.teal .stat-icon,
    .stat-card.gold .stat-icon,
    .stat-card.rose .stat-icon {
      background: var(--stat-icon-bg);
      color: var(--stat-icon-color);
    }

    .stat-card.indigo {
      --stat-glow: rgba(92, 120, 200, 0.2);
      --stat-icon-bg: linear-gradient(135deg, rgba(92, 120, 200, 0.55) 0%, rgba(255, 255, 255, 0.7) 100%);
      --stat-icon-color: #2F4C8C;
      background: linear-gradient(135deg, rgba(92, 120, 200, 0.42) 0%, var(--surface-card) 72%);
      border: 1px solid rgba(92, 120, 200, 0.45);
    }

    .stat-card.teal {
      --stat-glow: rgba(70, 188, 184, 0.24);
      --stat-icon-bg: linear-gradient(135deg, rgba(70, 188, 184, 0.68) 0%, rgba(255, 255, 255, 0.68) 100%);
      --stat-icon-color: #1E6F6A;
      background: linear-gradient(135deg, rgba(70, 188, 184, 0.55) 0%, var(--surface-card) 72%);
      border: 1px solid rgba(70, 188, 184, 0.6);
    }

    .stat-card.gold {
      --stat-glow: rgba(239, 170, 60, 0.32);
      --stat-icon-bg: linear-gradient(135deg, rgba(239, 170, 60, 0.85) 0%, rgba(255, 255, 255, 0.62) 100%);
      --stat-icon-color: #6B3F0E;
      background: linear-gradient(135deg, rgba(239, 170, 60, 0.68) 0%, var(--surface-card) 72%);
      border: 1px solid rgba(239, 170, 60, 0.72);
    }

    .stat-card.rose {
      --stat-glow: rgba(216, 114, 142, 0.24);
      --stat-icon-bg: linear-gradient(135deg, rgba(216, 114, 142, 0.68) 0%, rgba(255, 255, 255, 0.68) 100%);
      --stat-icon-color: #823447;
      background: linear-gradient(135deg, rgba(216, 114, 142, 0.55) 0%, var(--surface-card) 72%);
      border: 1px solid rgba(216, 114, 142, 0.6);
    }

    .stat-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat-label {
      font-size: 15px;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: -0.2px;
    }

    .stat-icon {
      width: 42px;
      height: 42px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-icon svg {
      width: 20px;
      height: 20px;
      stroke-width: 2.2;
    }

    .stat-icon.blue {
      background: linear-gradient(135deg, rgba(75, 110, 134, 0.22) 0%, rgba(255, 255, 255, 0.35) 100%);
      color: var(--primary);
    }

    .stat-icon.green {
      background: linear-gradient(135deg, rgba(111, 156, 141, 0.22) 0%, rgba(255, 255, 255, 0.35) 100%);
      color: var(--accent-success);
    }

    .stat-icon.orange {
      background: linear-gradient(135deg, rgba(195, 161, 97, 0.22) 0%, rgba(255, 255, 255, 0.35) 100%);
      color: var(--accent-warning);
    }

    .stat-icon.red {
      background: linear-gradient(135deg, rgba(192, 124, 123, 0.22) 0%, rgba(255, 255, 255, 0.35) 100%);
      color: var(--accent-danger);
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-title);
      line-height: 1.1;
      margin-bottom: 6px;
      letter-spacing: -0.5px;
    }

    .stat-desc {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* 卡片 */
    .card {
      background: var(--surface-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-ambient);
      border: 1px solid var(--glass-border);
      overflow: hidden;
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
    }

    .card-header {
      padding: 18px 22px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0.08) 100%);
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-title);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title-icon {
      width: 26px;
      height: 26px;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, rgba(75, 110, 134, 0.2) 0%, rgba(255, 255, 255, 0.35) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }

    .card-title-icon svg {
      width: 14px;
      height: 14px;
    }

    .card-body {
      padding: 22px;
    }

    .card-intro {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 18px;
      line-height: 1.7;
    }

    /* 图表网格 */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (max-width: 1200px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    .chart-area {
      position: relative;
      height: 200px;
      background: var(--surface-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: 12px;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
    }

    /* 表单 */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.span-full {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-body);
    }

    input,
    select,
    textarea {
      padding: 10px 12px;
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-family: inherit;
      background: var(--surface-card);
      color: var(--text-title);
      transition: all var(--transition-fast);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(75, 110, 134, 0.18);
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
    }

    textarea {
      resize: vertical;
      min-height: 68px;
    }

    .form-footer {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      padding-top: 4px;
    }

    /* 表格 */
    .table-wrap {
      overflow-x: auto;
      margin-top: 18px;
      background: var(--surface-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: 8px 10px;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    }

    th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 1px solid var(--glass-border);
      background: var(--surface-elevated);
    }

    td {
      padding: 12px;
      font-size: 13px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-body);
    }

    tr {
      transition: background var(--transition-fast);
    }

    tr:hover td {
      background: var(--surface-elevated);
    }

    tr:last-child td {
      border-bottom: none;
    }

    td:first-child {
      font-weight: 600;
      color: var(--text-title);
    }

    .tag {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
    }

    .tag-primary {
      background: linear-gradient(135deg, rgba(75, 110, 134, 0.18) 0%, rgba(255, 255, 255, 0.35) 100%);
      color: var(--primary);
    }

    .tag-warning {
      background: linear-gradient(135deg, rgba(195, 161, 97, 0.2) 0%, rgba(255, 255, 255, 0.35) 100%);
      color: var(--accent-warning);
    }

    .val-positive {
      color: var(--accent-success);
      font-weight: 600;
    }

    .val-negative {
      color: var(--accent-danger);
      font-weight: 600;
    }

    .actions-row {
      display: flex;
      gap: 4px;
    }

    .empty-cell {
      padding: 36px 12px !important;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* 空状态占位 */
    .empty-state {
      text-align: center;
      padding: 80px 40px;
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      background: var(--surface-elevated);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .empty-state-icon svg {
      width: 28px;
      height: 28px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-title);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 320px;
      margin: 0 auto;
    }

    /* 滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-base);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-body);
    }

    /* AI 知识库样式 */
    .ai-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--surface-card);
      padding: 4px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-ambient);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(16px) saturate(160%);
      -webkit-backdrop-filter: blur(16px) saturate(160%);
      width: fit-content;
    }

    .ai-tab {
      padding: 10px 24px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 600;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .ai-tab:hover {
      color: var(--text-body);
      background: var(--surface-elevated);
    }

    .ai-tab.active {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      color: white;
      box-shadow: var(--shadow-ambient);
    }

    .ai-panel {
      display: none;
    }

    .ai-panel.active {
      display: block;
    }

    .ai-top-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .ai-kanban-card {
      min-height: 300px;
      --kanban-slate-50: #F3F6FA;
      --kanban-slate-100: #EBF0F6;
      --kanban-slate-200: #DCE3EC;
      --kanban-indigo: var(--primary-light);
      --kanban-indigo-soft: var(--primary-glow);
      --kanban-mist: var(--surface-elevated);
      --kanban-glass: var(--surface-card);
      --kanban-shadow: 0 24px 48px rgba(15, 23, 42, 0.12);
      --kanban-shadow-soft: 0 12px 28px rgba(15, 23, 42, 0.08);
      --kanban-done: rgba(168, 214, 191, 0.75);
      --kanban-done-ink: #2E5E4F;
      --kanban-done-border: rgba(96, 160, 132, 0.55);
      --kanban-done-glow: rgba(96, 160, 132, 0.24);
    }

    .ai-chart-card {
      min-height: 300px;
    }

    .card-title-sm {
      font-size: 14px;
    }

    .kanban-header {
      display: grid;
      gap: 10px;
      margin-bottom: 14px;
    }

    .kanban-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .kanban-episode {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-title);
      padding: 10px 14px;
      background: var(--kanban-glass);
      border-radius: var(--radius-sm);
      border: 1px solid var(--glass-border);
      box-shadow: var(--kanban-shadow-soft);
      position: relative;
      overflow: hidden;
      flex: 1;
      min-width: 0;
      backdrop-filter: blur(14px) saturate(150%);
      -webkit-backdrop-filter: blur(14px) saturate(150%);
    }

    .kanban-episode::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 0%, var(--primary-glow), transparent 62%);
      opacity: 0.45;
      pointer-events: none;
    }

    .kanban-episode.active {
      color: var(--primary);
      font-weight: 700;
    }

    .episode-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--kanban-indigo-soft);
      border: none;
      color: var(--kanban-indigo);
      flex-shrink: 0;
    }

    .episode-title-text {
      font-size: 14px;
      font-weight: 600;
      color: inherit;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kanban-episode-control {
      display: none;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .kanban-header.editing .kanban-episode-control {
      display: flex;
    }

    .kanban-episode-control input {
      flex: 1;
      min-width: 140px;
    }

    .kanban-episode-control input[type="text"] {
      flex: 2;
      min-width: 200px;
    }

    .btn-icon-sm {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--kanban-glass);
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: all var(--transition-fast);
      backdrop-filter: blur(10px) saturate(160%);
      -webkit-backdrop-filter: blur(10px) saturate(160%);
      box-shadow: var(--shadow-ambient);
      border: 1px solid var(--glass-border);
    }

    .btn-icon-sm:hover {
      color: var(--primary);
      box-shadow: var(--kanban-shadow-soft);
    }

    .kanban-header.editing .btn-icon-sm {
      color: var(--primary);
      background: var(--kanban-indigo-soft);
    }

    .kanban-summary {
      display: grid;
      grid-template-columns: minmax(200px, 1.2fr) minmax(200px, 1fr);
      gap: 16px;
      margin-bottom: 14px;
    }

    .kanban-summary-card {
      background: var(--kanban-glass);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--kanban-shadow-soft);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
    }

    .kanban-summary-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 80% 20%, var(--primary-glow), transparent 60%);
      opacity: 0.4;
      pointer-events: none;
    }

    .summary-label {
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .summary-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-title);
      margin-top: 4px;
    }

    .summary-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-title);
      margin-top: 4px;
    }

    .summary-bar {
      height: 6px;
      background: rgba(148, 163, 184, 0.24);
      border-radius: 999px;
      margin-top: 10px;
      overflow: hidden;
    }

    .summary-bar span {
      display: block;
      width: var(--progress, 0%);
      height: 100%;
      background: linear-gradient(90deg, var(--primary-light), var(--primary));
      box-shadow: 0 0 16px var(--primary-glow);
    }

    .summary-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .summary-metric {
      background: var(--kanban-glass);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--kanban-shadow-soft);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
    }

    .project-board {
      position: relative;
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(220px, 1fr);
      gap: 18px;
      padding: 18px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--glass-border);
      background: linear-gradient(160deg, var(--surface-card) 0%, var(--surface-elevated) 100%);
      box-shadow: var(--kanban-shadow);
      overflow-x: auto;
      scroll-snap-type: x proximity;
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
    }

    .project-board .kanban-empty {
      min-height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--kanban-glass);
      border-radius: var(--radius-md);
      border: 1px solid var(--glass-border);
      box-shadow: var(--kanban-shadow-soft);
    }

    .project-board::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 10% 10%, var(--primary-glow), transparent 52%),
        radial-gradient(circle at 90% 30%, var(--frosted-haze-2), transparent 56%);
      opacity: 0.45;
      pointer-events: none;
    }

    .project-lane {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--glass-border);
      background: var(--kanban-glass);
      box-shadow: var(--kanban-shadow-soft);
      min-height: 260px;
      scroll-snap-align: start;
      overflow: hidden;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
    }

    .project-lane::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--lane-accent, var(--primary)), transparent);
      opacity: 0.45;
    }

    .lane-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .lane-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-title);
    }

    .lane-count {
      font-size: 10px;
      color: var(--text-muted);
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.4);
      border: 1px solid var(--glass-border);
    }

    .lane-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    .lane-wip {
      align-self: flex-start;
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-body);
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.35);
      border: 1px solid var(--glass-border);
    }

    .lane-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lane-empty {
      font-size: 11px;
      color: var(--text-muted);
      padding: 12px;
      border-radius: var(--radius-sm);
      background: rgba(255, 255, 255, 0.35);
      border: 1px solid var(--glass-border);
      text-align: center;
    }

    .project-card {
      position: relative;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--glass-border);
      background: var(--kanban-glass);
      box-shadow: var(--kanban-shadow-soft);
      cursor: pointer;
      overflow: hidden;
      transition: background var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast),
        transform var(--transition-fast);
      backdrop-filter: blur(8px) saturate(140%);
      -webkit-backdrop-filter: blur(8px) saturate(140%);
    }

    .project-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 80% 20%, var(--primary-glow), transparent 58%);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .project-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-elevated);
    }

    .project-card:hover::before {
      opacity: 0.6;
    }

    .project-card.done {
      background: linear-gradient(160deg, var(--kanban-done), rgba(237, 248, 242, 0.92));
      border-color: var(--kanban-done-border);
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.16), 0 0 18px var(--kanban-done-glow);
    }

    .project-card.done::after {
      content: '完成';
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 10px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--kanban-done-ink);
      padding: 2px 6px;
      border-radius: 999px;
      border: none;
      background: rgba(96, 160, 132, 0.24);
    }

    .card-top {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      position: relative;
      z-index: 1;
    }

    .card-status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(120, 139, 158, 0.6);
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.7);
      margin-top: 4px;
      flex-shrink: 0;
    }

    .project-card.done .card-status {
      background: #5FA084;
      box-shadow: 0 0 12px rgba(95, 160, 132, 0.5);
    }

    .project-card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-title);
      line-height: 1.4;
    }

    .card-detail {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      position: relative;
      z-index: 1;
    }

    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      position: relative;
      z-index: 1;
    }

    .task-chip {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.4);
      color: var(--text-body);
    }

    .task-chip.ghost {
      background: rgba(255, 255, 255, 0.32);
      color: var(--text-muted);
    }

    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 10px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      position: relative;
      z-index: 1;
    }

    .card-footer strong {
      font-size: 11px;
      letter-spacing: 0.02em;
      text-transform: none;
      color: var(--text-body);
      font-weight: 600;
    }

    @media (max-width: 900px) {
      .kanban-summary {
        grid-template-columns: 1fr;
      }
    }

    .kanban-tasks {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kanban-task {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--surface-card);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-body);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
    }

    .kanban-task:hover {
      background: var(--surface-elevated);
    }

    .kanban-task.done {
      background: rgba(111, 156, 141, 0.3);
      color: #50665F;
      text-decoration: line-through;
    }

    .kanban-task .task-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(91, 103, 118, 0.5);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all var(--transition-fast);
    }

    .kanban-task.done .task-checkbox {
      background: #5FA084;
      border-color: #5FA084;
      color: white;
    }

    .kanban-task .task-checkbox svg {
      width: 12px;
      height: 12px;
      opacity: 0;
    }

    .kanban-task.done .task-checkbox svg {
      opacity: 1;
    }

    .kanban-empty {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .chart-zoom {
      display: flex;
      gap: 4px;
    }

    .chart-container {
      position: relative;
      overscroll-behavior: contain;
      touch-action: pan-y;
      background: var(--surface-elevated);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: 12px;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
    }

    .chart-area canvas,
    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--surface-card);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: all var(--transition-fast);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
    }

    .btn-icon:hover {
      background: var(--surface-elevated);
      color: var(--text-body);
    }

    .chart-container-md {
      height: 200px;
    }

    .select-sm {
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      background: var(--surface-card);
      color: var(--text-body);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
    }

    .heatmap-container {
      display: flex;
      gap: 3px;
      flex-wrap: wrap;
      padding: 8px 0;
    }

    .heatmap-week {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .heatmap-day {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background: #ebedf0;
      cursor: pointer;
      position: relative;
    }

    .heatmap-day:hover {
      outline: 2px solid var(--primary-light);
      outline-offset: 1px;
    }

    .heatmap-day[data-level="1"] {
      background: #B7D8C3;
    }

    .heatmap-day[data-level="2"] {
      background: #88B89B;
    }

    .heatmap-day[data-level="3"] {
      background: #6D9A7F;
    }

    .heatmap-day[data-level="4"] {
      background: #4F7460;
    }

    .heatmap-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-title);
      color: white;
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity var(--transition-fast);
      z-index: 100;
      margin-bottom: 4px;
    }

    .heatmap-day:hover .heatmap-tooltip {
      opacity: 1;
    }

    .heatmap-legend {
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: flex-end;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .heatmap-legend-item {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .heatmap-legend-label {
      margin: 0 4px;
    }

    .form-grid-5 {
      grid-template-columns: repeat(5, 1fr);
    }

    .span-3 {
      grid-column: span 3;
    }

    .rate-good {
      color: var(--accent-success);
      font-weight: 600;
    }

    .rate-mid {
      color: var(--accent-warning);
      font-weight: 600;
    }

    .rate-low {
      color: var(--accent-danger);
      font-weight: 600;
    }

    .tag-news {
      background: rgba(86, 128, 169, 0.16);
      color: #3C5E7A;
    }

    .tag-tool {
      background: rgba(111, 156, 141, 0.18);
      color: #4C7A6B;
    }

    .tag-paper {
      background: rgba(195, 161, 97, 0.18);
      color: #8C6F3E;
    }

    .tag-thought {
      background: rgba(164, 136, 145, 0.18);
      color: #7A5B63;
    }

    .tag-mixed {
      background: rgba(148, 163, 184, 0.16);
      color: #5B6776;
    }

    @media (max-width: 1200px) {
      .ai-top-grid {
        grid-template-columns: 1fr;
      }

      .form-grid-5 {
        grid-template-columns: repeat(3, 1fr);
      }

      .span-3 {
        grid-column: span 2;
      }
    }

    @media (max-width: 768px) {
      .form-grid-5 {
        grid-template-columns: repeat(2, 1fr);
      }

      .span-3 {
        grid-column: span 2;
      }
    }



    /* =========================================
       8. 交互组件 (Toast & Modal)
       ========================================= */
    /* Toast 提示 */
    .toast-container {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      background: var(--surface-card);
      padding: 12px 20px;
      border-radius: 50px;
      box-shadow: var(--shadow-floating);
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-title);
      animation: toast-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
      min-width: 280px;
      backdrop-filter: blur(16px) saturate(160%);
      -webkit-backdrop-filter: blur(16px) saturate(160%);
    }

    .toast.success {
      border-left: 4px solid var(--accent-success);
    }

    .toast.error {
      border-left: 4px solid var(--accent-danger);
    }

    .toast.info {
      border-left: 4px solid var(--primary);
    }

    .toast-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast.success .toast-icon {
      color: var(--accent-success);
    }

    .toast.error .toast-icon {
      color: var(--accent-danger);
    }

    .toast.info .toast-icon {
      color: var(--primary);
    }

    .backup-modal {
      width: 520px;
      max-width: 92vw;
    }

    .backup-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .backup-textarea {
      width: 100%;
      min-height: 170px;
      resize: vertical;
      font-size: 12px;
      line-height: 1.5;
      font-family: "SFMono-Regular", Menlo, Consolas, monospace;
    }

    .backup-meta {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes toast-out {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      to {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
    }

    /* Modal 弹窗 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      z-index: 900;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-overlay.active {
      display: flex;
      opacity: 1;
    }

    .modal {
      background: var(--surface-card);
      width: 400px;
      max-width: 90vw;
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-floating);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px) saturate(170%);
      -webkit-backdrop-filter: blur(20px) saturate(170%);
      transform: scale(0.95);
      transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-title);
    }

    .modal-body {
      font-size: 15px;
      color: var(--text-body);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* 主题下拉菜单 */
    .theme-switcher {
      position: relative;
    }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 12px);
      right: 0;
      background: var(--surface-card);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-floating);
      width: 160px;
      display: none;
      z-index: 500;
      flex-direction: column;
      padding: 6px;
      animation: toast-in 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(16px) saturate(160%);
      -webkit-backdrop-filter: blur(16px) saturate(160%);
    }

    .theme-dropdown.active {
      display: flex;
    }

    .theme-option {
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-body);
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all var(--transition-fast);
    }

    .theme-option:hover {
      background: var(--surface-elevated);
      color: var(--primary);
    }

    .theme-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1.5px solid rgba(0, 0, 0, 0.1);
    }

    body[data-theme="dark"] .theme-dot {
      border-color: rgba(255, 255, 255, 0.2);
    }

    body[data-theme="dark"] .topbar {
      background: rgba(7, 16, 27, 0.78);
    }

    body[data-theme="wine"] .topbar {
      background: rgba(255, 255, 255, 0.72);
    }

    body[data-theme="mint"] .topbar {
      background: rgba(255, 255, 255, 0.72);
    }

    body[data-theme="craft"] .topbar {
      background: rgba(245, 245, 245, 0.7);
    }

    /* =========================================
       New: AI分享月 - 线性时光轴 (Timeline) & 专属配色补丁
       ========================================= */
    body {
      /* 默认 (深色) 配色 */
      --share-primary: #8b5cf6;
      /* 星云紫 */
      --share-primary-glow: rgba(139, 92, 246, 0.5);
      --share-gold: #fbbf24;
      /* 流光金 */
      --share-bg: rgba(30, 27, 75, 0.6);
      --share-line-inactive: rgba(255, 255, 255, 0.1);
      --share-card-bg: rgba(255, 255, 255, 0.03);
      --share-card-border: rgba(255, 255, 255, 0.05);
    }

    body[data-theme="wine"],
    body[data-theme="mint"] {
      /* 浅色系适配 */
      --share-primary: #7c3aed;
      /* 深一点的紫 */
      --share-primary-glow: rgba(124, 58, 237, 0.3);
      --share-gold: #d97706;
      /* 深一点的金 */
      --share-bg: rgba(255, 255, 255, 0.5);
      --share-line-inactive: rgba(0, 0, 0, 0.1);
      --share-card-bg: rgba(255, 255, 255, 0.6);
      --share-card-border: rgba(0, 0, 0, 0.05);
    }

    .share-timeline-container {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      padding: 1.5rem 0;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--share-primary) transparent;
      margin-bottom: 1rem;
    }

    .share-timeline-container::-webkit-scrollbar {
      height: 6px;
    }

    .share-timeline-container::-webkit-scrollbar-thumb {
      background: var(--share-primary);
      border-radius: 3px;
    }

    /* 时光轴轨道 */
    .timeline-track {
      display: flex;
      align-items: flex-start;
      position: relative;
      padding: 0 1rem;
      min-width: max-content;
    }

    /* 连接线背景 (灰色底线) */
    .timeline-line-bg {
      position: absolute;
      top: 24px;
      left: 3rem;
      right: 3rem;
      height: 2px;
      background: var(--share-line-inactive);
      z-index: 0;
    }

    /* 激活的连接线 (流光) */
    .timeline-line-active {
      position: absolute;
      top: 24px;
      left: 3rem;
      height: 2px;
      background: var(--share-primary);
      z-index: 0;
      box-shadow: 0 0 8px var(--share-primary);
      transition: width 0.6s ease-in-out;
    }

    /* 步骤节点 */
    .timeline-step {
      position: relative;
      z-index: 1;
      width: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 0.5rem;
      cursor: pointer;
      opacity: 0.5;
      /* 默认未激活稍微透明 */
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .timeline-step:hover {
      opacity: 0.8;
    }

    .timeline-step:last-child {
      margin-right: 0;
    }

    /* 步骤图标 (圆形) */
    .step-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--surface-card);
      border: 2px solid var(--border-medium);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      margin-bottom: 1rem;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      /* 弹性效果 */
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-ambient);
    }

    .step-icon svg {
      width: 22px;
      height: 22px;
    }

    /* 步骤内容卡片 */
    .step-card {
      width: 90%;
      background: var(--share-card-bg);
      border: 1px solid var(--share-card-border);
      border-radius: 12px;
      padding: 0.8rem 0.5rem;
      text-align: center;
      transition: all 0.3s ease;
      transform: translateY(0);
    }

    .step-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-body);
      margin-bottom: 0.3rem;
    }

    .step-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.3;
    }

    /* 状态：进行中 (Active) */
    .timeline-step.active {
      opacity: 1;
    }

    .timeline-step.active .step-icon {
      background: var(--share-primary);
      border-color: var(--share-primary);
      color: white;
      box-shadow: 0 0 20px var(--share-primary-glow);
      transform: scale(1.15);
    }

    .timeline-step.active .step-card {
      background: rgba(139, 92, 246, 0.1);
      border-color: var(--share-primary);
      transform: translateY(-4px);
    }

    .timeline-step.active .step-title {
      color: var(--share-primary);
    }

    /* 状态：已完成 (Done) */
    .timeline-step.done {
      opacity: 1;
    }

    .timeline-step.done .step-icon {
      background: var(--surface-base);
      border-color: var(--share-gold);
      color: var(--share-gold);
    }

    /* =========================================
       New: 金融小百科 - UE5 质感 (Pro Finance)
       Deep Emerald + Gold + Glassmorphism + Volumetric Glow
       ========================================= */
    body {
      --fin-bg-start: #0f172a;
      --fin-bg-end: #020617;
      --fin-card-bg: rgba(30, 41, 59, 0.6);
      --fin-border: rgba(255, 255, 255, 0.08);
      --fin-accent: #f59e0b;
      /* Amber 500 */
      --fin-accent-glow: rgba(245, 158, 11, 0.4);
      --fin-text-main: #f8fafc;
      --fin-text-sub: #94a3b8;
      --fin-success: #10b981;
    }

    /* 浅色模式适配 (Keep it premium but light) */
    body[data-theme="wine"],
    body[data-theme="mint"],
    body[data-theme="craft"] {
      --fin-bg-start: #f8fafc;
      --fin-bg-end: #e2e8f0;
      --fin-card-bg: rgba(255, 255, 255, 0.8);
      --fin-border: rgba(0, 0, 0, 0.06);
      --fin-accent: #d97706;
      /* Amber 600 */
      --fin-accent-glow: rgba(217, 119, 6, 0.25);
      --fin-text-main: #1e293b;
      --fin-text-sub: #64748b;
    }

    .fin-container {
      background: linear-gradient(135deg, var(--fin-bg-start) 0%, var(--fin-bg-end) 100%);
      border-radius: 20px;
      padding: 2rem;
      min-height: 80vh;
      color: var(--fin-text-main);
      position: relative;
      overflow: hidden;
      /* Keep hidden to constrain children */
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.2);
    }

    /* 装饰性背景光 (Volumetric Light) */
    .fin-container::before {
      content: '';
      position: absolute;
      top: -100px;
      right: -100px;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, var(--fin-accent-glow) 0%, transparent 70%);
      opacity: 0.4;
      pointer-events: none;
      filter: blur(40px);
    }

    .fin-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 2.5rem;
      position: relative;
      z-index: 2;
    }

    .fin-title {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--fin-text-main) 30%, var(--fin-accent) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .fin-subtitle {
      font-size: 0.9rem;
      color: var(--fin-text-sub);
      margin-top: 0.5rem;
      font-weight: 400;
      opacity: 0.8;
    }

    /* 3D 悬浮时间轴 */
    .fin-timeline-wrap {
      display: flex;
      gap: 1.5rem;
      padding: 1rem 0.5rem 2rem 0.5rem;
      overflow-x: auto;
      overflow-y: hidden;
      perspective: 1000px;
      width: 100%;
      align-items: flex-start;
      /* Scrollbar styling */
      scrollbar-width: thin;
      scrollbar-color: var(--fin-accent) transparent;
    }

    .fin-step {
      flex: 0 0 160px;
      /* Fixed width, no shrink */
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      transform-style: preserve-3d;
      cursor: pointer;
      opacity: 0.6;
    }

    /* 卡片主体 */
    .fin-card {
      background: var(--fin-card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--fin-border);
      border-radius: 16px;
      padding: 1.25rem 1rem;
      height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    /* 顶部高光条 (Metallic Shine) */
    .fin-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .fin-step:hover {
      opacity: 0.9;
      transform: translateY(-4px) rotateX(4deg);
    }

    .fin-step:hover .fin-card {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    }

    /* 选中/进行中状态 */
    .fin-step.active {
      opacity: 1;
      transform: translateY(-8px) scale(1.02);
    }

    .fin-step.active .fin-card {
      border-color: var(--fin-accent);
      background: linear-gradient(160deg, var(--fin-card-bg) 0%, rgba(245, 158, 11, 0.05) 100%);
      box-shadow: 0 0 20px var(--fin-accent-glow), 0 0 0 1px var(--fin-accent) inset;
    }

    .fin-step.active .fin-card::after {
      opacity: 1;
    }

    /* 完成状态 */
    .fin-step.done .fin-card {
      border-color: var(--fin-success);
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
    }

    .fin-step.done .fin-icon {
      color: var(--fin-success);
    }

    .fin-icon {
      font-size: 1.5rem;
      color: var(--fin-text-sub);
      transition: color 0.3s;
    }

    .fin-step.active .fin-icon {
      color: var(--fin-accent);
      text-shadow: 0 0 10px var(--fin-accent);
    }

    .fin-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--fin-text-main);
    }

    .fin-meta {
      font-size: 0.75rem;
      color: var(--fin-text-sub);
      margin-top: auto;
    }

    /* Episode Selector (Glass Pill) */
    .fin-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
      padding: 6px;
      border-radius: 999px;
      border: 1px solid var(--fin-border);
    }

    .fin-btn {
      background: transparent;
      border: none;
      color: var(--fin-text-sub);
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .fin-btn.active,
    .fin-btn:hover {
      background: var(--fin-card-bg);
      color: var(--fin-text-main);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .fin-add-btn {
      background: var(--fin-accent);
      color: black;
      font-weight: 600;
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 0 12px var(--fin-accent-glow);
    }


    .timeline-step.done .step-title {
      color: var(--share-gold);
    }

    /* 脉冲动画 */
    @keyframes pulse-ring {
      0% {
        box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
      }

      70% {
        box-shadow: 0 0 0 12px rgba(139, 92, 246, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);
      }
    }

    .timeline-step.active .step-icon {
      animation: pulse-ring 2s infinite;
    }

    /* === Finance Kanban Board Styles === */
    .fin-tab-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(0, 0, 0, 0.15);
      padding: 0.5rem;
      border-radius: 12px;
      border: 1px solid var(--fin-border);
    }

    .fin-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: none;
      color: var(--fin-text-sub);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .fin-tab.active,
    .fin-tab:hover {
      background: var(--fin-card-bg);
      color: var(--fin-text-main);
    }

    /* Kanban View Container - constrains width to enable internal scrolling */
    #finKanbanView {
      width: 100%;
      max-width: calc(100vw - 340px);
      /* Account for sidebar and padding */
      overflow-x: hidden;
      /* Hide overflow on parent, let child scroll */
    }

    .kanban-board {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding-bottom: 1rem;
      min-height: 400px;
      /* Scrollbar Styling - High Contrast */
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.4) rgba(255, 255, 255, 0.05);
    }

    .kanban-board::-webkit-scrollbar {
      height: 8px;
    }

    .kanban-board::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .kanban-board::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.35);
      border-radius: 4px;
    }

    .kanban-board::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .kanban-card[draggable="true"] {
      cursor: grab;
    }

    .kanban-card.is-dragging {
      opacity: 0.5;
      transform: scale(0.95);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .kanban-column {
      transition: background 0.2s, box-shadow 0.2s;
      border-radius: 8px;
    }

    .kanban-column.drag-over {
      background: rgba(255, 255, 255, 0.05);
      box-shadow: inset 0 0 0 2px var(--fin-accent);
    }

    .kanban-column {
      flex: 0 0 280px;
      /* Increased to force scroll */
      background: rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      border: 1px solid var(--fin-border);
      display: flex;
      flex-direction: column;
    }

    .kanban-column.done {
      background: rgba(16, 185, 129, 0.08);
      border-color: rgba(16, 185, 129, 0.3);
    }

    .kanban-column-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      border-bottom: 1px solid var(--fin-border);
      color: var(--fin-text-main);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .kanban-column-header svg {
      color: var(--fin-text-sub);
    }

    .kanban-column.done .kanban-column-header svg {
      color: var(--fin-success);
    }

    .kanban-count {
      margin-left: auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--fin-text-sub);
    }

    .kanban-cards {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kanban-card {
      background: var(--fin-card-bg);
      border: 1px solid var(--fin-border);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .kanban-card:hover {
      border-color: var(--fin-accent);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: translateY(-2px);
    }

    .kanban-card-ep {
      font-weight: 700;
      color: var(--fin-accent);
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .kanban-card-title {
      color: var(--fin-text-main);
      font-size: 0.9rem;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .kanban-card-date {
      font-size: 0.75rem;
      color: var(--fin-text-sub);
      margin-top: 8px;
    }

    /* Finance Modal - Uses base .modal-overlay styles */

    .modal-content.fin-modal {
      background: var(--fin-card-bg);
      border: 1px solid var(--fin-border);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--fin-border);
    }

    .modal-header h3 {
      color: var(--fin-text-main);
      font-size: 1.1rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--fin-text-sub);
      font-size: 1.5rem;
      cursor: pointer;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--fin-text-main);
    }

    .modal-body {
      padding: 20px;
    }

    .fin-workflow-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .fin-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid var(--fin-border);
      background: rgba(0, 0, 0, 0.2);
      color: var(--fin-text-sub);
      transition: all 0.2s ease;
    }

    .fin-chip.done {
      background: var(--fin-success);
      color: #000;
      border-color: var(--fin-success);
    }

    .fin-chip:hover {
      border-color: var(--fin-accent);
    }
  </style>
</head>

<body>
  <!-- 侧边栏 -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="brand-mark">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
          </svg>
        </div>
        <span class="sidebar-title">Surfin L&D</span>
      </div>
      <button class="sidebar-toggle" id="sidebarToggle" title="收起侧边栏">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6" />
        </svg>
      </button>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-label">概览</div>
        <div class="nav-item active" data-page="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7" />
            <rect x="14" y="3" width="7" height="7" />
            <rect x="14" y="14" width="7" height="7" />
            <rect x="3" y="14" width="7" height="7" />
          </svg>
          <span>培训大屏</span>
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-section-label">管理</div>
        <div class="nav-item" data-page="training">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
          </svg>
          <span>培训管理</span>
        </div>
        <div class="nav-item" data-page="aiknowledge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
            <line x1="12" y1="22.08" x2="12" y2="12" />
          </svg>
          <span>AI 知识库</span>
        </div>
        <div class="nav-item" data-page="finance">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
          </svg>
          <span>金融小百科</span>
        </div>
        <div class="nav-item" data-page="budget">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23" />
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
          </svg>
          <span>预算与开销</span>
        </div>
      </div>
    </nav>
  </aside>

  <!-- 主内容区 -->
  <div class="main-wrapper">
    <header class="topbar">
      <div class="topbar-left">
        <button class="topbar-open-btn" id="sidebarOpen" title="打开侧边栏">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
            <line x1="9" y1="3" x2="9" y2="21" />
          </svg>
        </button>
        <h1 class="page-title" id="pageTitle">培训大屏</h1>
      </div>
      <div class="topbar-actions" id="topbarActions">
        <div class="theme-switcher">
          <button class="btn btn-secondary btn-sm" id="themeBtn" onclick="toggleThemeDropdown(event)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5" />
              <path
                d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
            </svg>
            主题方案
          </button>
          <div class="theme-dropdown" id="themeDropdown">
            <div class="theme-option" onclick="setTheme('default')"><span class="theme-dot"
                style="background:#1E455F"></span>经典原力</div>
            <div class="theme-option" onclick="setTheme('dark')"><span class="theme-dot"
                style="background:#0A1B2A"></span>暗夜星辰</div>
            <div class="theme-option" onclick="setTheme('wine')"><span class="theme-dot"
                style="background:#6A3F3E"></span>流金岁月</div>
            <div class="theme-option" onclick="setTheme('mint')"><span class="theme-dot"
                style="background:#3C6E5E"></span>生机薄荷</div>
            <div class="theme-option" onclick="setTheme('craft')"><span class="theme-dot"
                style="background:#4B5058"></span>匠心工匠</div>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="exportExcel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="8" y1="13" x2="16" y2="13" />
            <line x1="8" y1="17" x2="16" y2="17" />
          </svg>
          Excel
        </button>
        <button class="btn btn-secondary btn-sm" onclick="exportJson()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          JSON
        </button>
        <button class="btn btn-secondary btn-sm" onclick="openBackupModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" />
            <path d="M5 15V5a2 2 0 0 1 2-2h10" />
          </svg>
          备份码
        </button>
        <button class="btn btn-secondary btn-sm" onclick="importJson()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          导入
        </button>
        <button class="btn btn-primary btn-sm" onclick="exportPdf()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
          </svg>
          PDF
        </button>
      </div>
    </header>

    <main id="mainContent">
      <!-- 培训大屏 -->
      <div class="page active" id="page-dashboard">
        <section class="stats-grid">
          <div class="stat-card blue">
            <div class="stat-header">
              <span class="stat-label">本月培训场次</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                  <line x1="16" y1="2" x2="16" y2="6" />
                  <line x1="8" y1="2" x2="8" y2="6" />
                  <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statSessions">0</div>
            <div class="stat-desc" id="statUpcoming">最近培训：-</div>
          </div>
          <div class="stat-card green">
            <div class="stat-header">
              <span class="stat-label">本月总人时</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12 6 12 12 16 14" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statHours">0</div>
            <div class="stat-desc">人数 × 时长</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-header">
              <span class="stat-label">本月培训人数</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statMonthPeople">0</div>
            <div class="stat-desc">参与人数合计</div>
          </div>
          <div class="stat-card red">
            <div class="stat-header">
              <span class="stat-label">本月所有项目支出</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23" />
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statMonthSpend">¥0</div>
            <div class="stat-desc">含常规与专项</div>
          </div>
        </section>

        <section class="stats-grid">
          <div class="stat-card indigo">
            <div class="stat-header">
              <span class="stat-label">2026 年培训场次</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                  <line x1="16" y1="2" x2="16" y2="6" />
                  <line x1="8" y1="2" x2="8" y2="6" />
                  <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statYearSessions">0</div>
            <div class="stat-desc">全年累计</div>
          </div>
          <div class="stat-card teal">
            <div class="stat-header">
              <span class="stat-label">2026 年培训人数</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statYearPeople">0</div>
            <div class="stat-desc">参训人数累计</div>
          </div>
          <div class="stat-card gold">
            <div class="stat-header">
              <span class="stat-label">2026 年总人时</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <polyline points="12 6 12 12 16 14" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statYearHours">0</div>
            <div class="stat-desc">人数 × 时长</div>
          </div>
          <div class="stat-card rose">
            <div class="stat-header">
              <span class="stat-label">2026 年项目支出</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23" />
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statYearSpend">¥0</div>
            <div class="stat-desc">含常规与专项</div>
          </div>
        </section>

        <section class="stats-grid" style="margin-top: 1.5rem;">
          <div class="stat-card cyan">
            <!-- 金融小百科 Stat Card -->
            <div class="stat-header">
              <span class="stat-label">金融小百科总期数</span>
              <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                </svg>
              </div>
            </div>
            <div class="stat-value" id="statFinanceTotal">0</div>
            <div class="stat-desc">累计已发布期数</div>
          </div>
        </section>



        <section class="charts-grid">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                  </svg></span>
                培训人时趋势
              </h2>
            </div>
            <div class="card-body">
              <div class="chart-area"><canvas id="hoursChart"></canvas></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10" />
                    <line x1="18" y1="20" x2="18" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="16" />
                  </svg></span>
                预算 vs 开销
              </h2>
            </div>
            <div class="card-body">
              <div class="chart-area"><canvas id="budgetChart"></canvas></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
                    <path d="M22 12A10 10 0 0 0 12 2v10z" />
                  </svg></span>
                费用构成
              </h2>
            </div>
            <div class="card-body">
              <div class="chart-area"><canvas id="costPie"></canvas></div>
            </div>
          </div>
        </section>
      </div>

      <!-- 培训管理 -->
      <div class="page" id="page-training">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                </svg></span>
              培训场次管理
            </h2>
          </div>
          <div class="card-body">
            <p class="card-intro">记录培训时间、课程、项目、讲师、人数、时长，系统自动计算培训总人时。</p>
            <form id="sessionForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">培训时间</label>
                  <input type="date" id="sessionDate" required />
                </div>
                <div class="form-group">
                  <label class="form-label">课程名称</label>
                  <input type="text" id="sessionCourse" placeholder="如：新员工入职培训" required />
                </div>
                <div class="form-group">
                  <label class="form-label">所属项目</label>
                  <input type="text" id="sessionProject" placeholder="如：项目 A" required />
                </div>
                <div class="form-group">
                  <label class="form-label">讲师</label>
                  <input type="text" id="sessionLecturer" placeholder="讲师姓名" required />
                </div>
                <div class="form-group">
                  <label class="form-label">参加人数</label>
                  <input type="number" min="1" id="sessionPeople" required />
                </div>
                <div class="form-group">
                  <label class="form-label">培训时长（小时）</label>
                  <input type="number" step="0.5" min="0.5" id="sessionDuration" required />
                </div>
                <div class="form-group span-full">
                  <label class="form-label">备注</label>
                  <textarea id="sessionNote" placeholder="培训内容要点"></textarea>
                </div>
                <input type="hidden" id="sessionId" />
                <div class="form-footer">
                  <button class="btn btn-primary" type="submit">保存记录</button>
                </div>
              </div>
            </form>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>时间</th>
                    <th>课程</th>
                    <th>项目</th>
                    <th>讲师</th>
                    <th>人数</th>
                    <th>时长</th>
                    <th>总人时</th>
                    <th>备注</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="sessionTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- AI 知识库 -->
      <div class="page" id="page-aiknowledge">
        <!-- 项目切换 Tab -->
        <div class="ai-tabs">
          <button class="ai-tab active" data-tab="station">AI 广播站</button>
          <button class="ai-tab" data-tab="share">AI 分享月</button>
        </div>

        <!-- AI 广播站 -->
        <div class="ai-panel active" id="panel-station">
          <!-- 看板 + 图表 -->
          <div class="ai-top-grid">
            <!-- 左侧看板 -->
            <div class="card ai-kanban-card">
              <div class="card-header">
                <h3 class="card-title card-title-sm">
                  <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path d="M9 11H3v10h6V11zM21 3h-6v18h6V3zM15 7H9v14h6V7z" />
                    </svg></span>
                  本期看板
                </h3>
                <button class="btn btn-sm btn-secondary" onclick="newStationEpisode()">+ 新建期次</button>
              </div>
              <div class="card-body">
                <div class="kanban-header" id="stationKanbanHeader">
                  <div class="kanban-title-row">
                    <div class="kanban-episode" id="stationKanbanEpisode">未选择期次</div>
                    <button class="btn-icon-sm" type="button" onclick="toggleEpisodeEdit('station')" title="编辑主题">
                      <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M12 20h9" />
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
                      </svg>
                    </button>
                  </div>
                  <div class="kanban-episode-control">
                    <input type="number" id="stationEpisodePicker" class="select-sm" min="0" step="1"
                      placeholder="期数" />
                    <input type="text" id="stationTitlePicker" class="select-sm" placeholder="本期主题" />
                    <button class="btn btn-sm btn-primary" type="button" onclick="confirmStationEpisode()">确定</button>
                  </div>
                </div>
                <div class="kanban-summary" id="stationKanbanSummary"></div>
                <div class="project-board" id="stationKanbanBoard"></div>
              </div>
            </div>
            <!-- 右侧图表 -->
            <div class="card ai-chart-card">
              <div class="card-header">
                <h3 class="card-title card-title-sm">
                  <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path d="M18 20V10M12 20V4M6 20v-6" />
                    </svg></span>
                  查看率趋势
                </h3>
                <div class="chart-zoom">
                  <button class="btn-icon" onclick="zoomStationChart('out')" title="缩小"><svg viewBox="0 0 24 24"
                      width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8" />
                      <line x1="21" y1="21" x2="16.65" y2="16.65" />
                      <line x1="8" y1="11" x2="14" y2="11" />
                    </svg></button>
                  <button class="btn-icon" onclick="zoomStationChart('in')" title="放大"><svg viewBox="0 0 24 24"
                      width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8" />
                      <line x1="21" y1="21" x2="16.65" y2="16.65" />
                      <line x1="11" y1="8" x2="11" y2="14" />
                      <line x1="8" y1="11" x2="14" y2="11" />
                    </svg></button>
                  <button class="btn-icon" onclick="zoomStationChart('reset')" title="重置"><svg viewBox="0 0 24 24"
                      width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                      <path d="M3 3v5h5" />
                    </svg></button>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container chart-container-md">
                  <canvas id="stationChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- 日历热力图 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                    <line x1="16" y1="2" x2="16" y2="6" />
                    <line x1="8" y1="2" x2="8" y2="6" />
                    <line x1="3" y1="10" x2="21" y2="10" />
                  </svg></span>
                年度发布热力图
              </h3>
              <select id="stationHeatmapYear" class="select-sm" onchange="renderStationHeatmap()"></select>
            </div>
            <div class="card-body">
              <div class="heatmap-container" id="stationHeatmap"></div>
              <div class="heatmap-legend">
                <span class="heatmap-legend-label">查看率</span>
                <span class="heatmap-legend-item" style="background:#ebedf0"></span>
                <span class="heatmap-legend-item" style="background:#9be9a8"></span>
                <span class="heatmap-legend-item" style="background:#40c463"></span>
                <span class="heatmap-legend-item" style="background:#30a14e"></span>
                <span class="heatmap-legend-item" style="background:#216e39"></span>
                <span class="heatmap-legend-label">高</span>
              </div>
            </div>
          </div>

          <!-- 数据录入 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                  </svg></span>
                数据录入
              </h3>
            </div>
            <div class="card-body">
              <form id="stationForm">
                <div class="form-grid form-grid-5">
                  <div class="form-group">
                    <label class="form-label">期数</label>
                    <input type="number" id="stationEpisode" min="0" placeholder="第几期" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">发布日期</label>
                    <input type="date" id="stationDate" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">本期主题</label>
                    <input type="text" id="stationTitle" placeholder="标题或关键词" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">查看人数</label>
                    <input type="number" id="stationViews" min="0" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">公司总人数</label>
                    <input type="number" id="stationTotal" min="1" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">内容类型</label>
                    <select id="stationCategory">
                      <option value="news">AI 新闻</option>
                      <option value="tool">AI 工具</option>
                      <option value="paper">AI 论文</option>
                      <option value="thought">AI 思考</option>
                      <option value="mixed">综合</option>
                    </select>
                  </div>
                  <div class="form-group span-3">
                    <label class="form-label">备注</label>
                    <input type="text" id="stationNote" placeholder="特殊情况记录（选填）" />
                  </div>
                  <input type="hidden" id="stationId" />
                </div>
                <div class="form-footer">
                  <button class="btn btn-primary" type="submit">保存记录</button>
                  <button class="btn btn-warning" type="button" id="stationCancelBtn" style="display:none;"
                    onclick="cancelStationEdit()">取消编辑</button>
                  <button class="btn btn-secondary" type="button" onclick="resetStationForm()">清空</button>
                </div>
              </form>
            </div>
          </div>

          <!-- 历史记录 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                  </svg></span>
                历史记录
              </h3>
            </div>
            <div class="card-body">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>期数</th>
                      <th>发布日期</th>
                      <th>主题</th>
                      <th>类型</th>
                      <th>查看人数</th>
                      <th>总人数</th>
                      <th>查看率</th>
                      <th>备注</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="stationTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- AI 分享月 -->
        <div class="ai-panel" id="panel-share">
          <!-- 看板 + 图表 -->
          <div class="ai-top-grid">
            <!-- 左侧看板 (改为线性时光轴) -->
            <div class="card ai-kanban-card">
              <div class="card-header">
                <h3 class="card-title card-title-sm">
                  <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                    </svg></span>
                  本期推进 (Timeline)
                </h3>
                <button class="btn btn-sm btn-secondary" onclick="newShareEpisode()">+ 新建期次</button>
              </div>
              <div class="card-body">
                <div class="kanban-header" id="shareKanbanHeader">
                  <div class="kanban-title-row">
                    <div class="kanban-episode" id="shareKanbanEpisode">未选择期次</div>
                    <button class="btn-icon-sm" type="button" onclick="toggleEpisodeEdit('share')" title="编辑主题">
                      <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M12 20h9" />
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
                      </svg>
                    </button>
                  </div>
                  <div class="kanban-episode-control">
                    <input type="number" id="shareEpisodePicker" class="select-sm" min="0" step="1" placeholder="期数" />
                    <input type="text" id="shareTitlePicker" class="select-sm" placeholder="本期主题" />
                    <button class="btn btn-sm btn-primary" type="button" onclick="confirmShareEpisode()">确定</button>
                  </div>
                </div>

                <!-- 新的 Timeline 容器 -->
                <div class="share-timeline-container" id="shareTimelineBoard">
                  <div style="padding: 2rem; text-align: center; color: var(--text-muted); width: 100%;">
                    点击右上角「+ 新建期次」启动本期分享任务
                  </div>
                </div>
              </div>
            </div>
            <!-- 右侧图表 -->
            <div class="card ai-chart-card">
              <div class="card-header">
                <h3 class="card-title card-title-sm">
                  <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                      stroke-width="2">
                      <path d="M18 20V10M12 20V4M6 20v-6" />
                    </svg></span>
                  参与率趋势
                </h3>
              </div>
              <div class="card-body">
                <div class="chart-container chart-container-md">
                  <canvas id="shareChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- 数据录入 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                  </svg></span>
                数据录入
              </h3>
            </div>
            <div class="card-body">
              <form id="shareForm">
                <div class="form-grid form-grid-5">
                  <div class="form-group">
                    <label class="form-label">期数</label>
                    <input type="number" id="shareEpisode" min="1" placeholder="第几期" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">培训日期</label>
                    <input type="date" id="shareDate" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">本期主题</label>
                    <input type="text" id="shareTitle" placeholder="分享主题" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">参加人数</label>
                    <input type="number" id="shareAttendees" min="0" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">公司总人数</label>
                    <input type="number" id="shareTotal" min="1" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">时长（分钟）</label>
                    <input type="number" id="shareDuration" min="1" placeholder="分钟" required />
                  </div>
                  <div class="form-group span-3">
                    <label class="form-label">备注</label>
                    <input type="text" id="shareNote" placeholder="特殊情况记录（选填）" />
                  </div>
                  <input type="hidden" id="shareId" />
                </div>
                <div class="form-footer">
                  <button class="btn btn-primary" type="submit">保存记录</button>
                  <button class="btn btn-secondary" type="button" onclick="resetShareForm()">清空</button>
                </div>
              </form>
            </div>
          </div>

          <!-- 历史记录 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title card-title-sm">
                <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                  </svg></span>
                历史记录
              </h3>
            </div>
            <div class="card-body">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>期数</th>
                      <th>培训日期</th>
                      <th>主题</th>
                      <th>参加人数</th>
                      <th>总人数</th>
                      <th>参与率</th>
                      <th>时长</th>
                      <th>备注</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="shareTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 金融小百科 (全新 UE5 风格) -->
      <div class="page" id="page-finance">
        <div class="fin-container">
          <div class="fin-header">
            <div>
              <div class="fin-title">金融小百科</div>
              <div class="fin-subtitle">Financial Encryption Encyclopedia · 稳定币超入门</div>
            </div>
            <div class="fin-controls">
              <button class="fin-btn active" id="finTab-stablecoin">稳定币 (Season 1)</button>
              <button class="fin-btn" id="finTab-history">History</button>
            </div>
          </div>

          <!-- 稳定币超入门面板 (Kanban View) -->
          <div id="fin-panel-stablecoin">
            <!-- Tab Switcher -->
            <div class="fin-tab-bar" style="margin-bottom: 1.5rem;">
              <button class="fin-tab active" id="finView-kanban" onclick="switchFinanceView('kanban')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <rect x="3" y="3" width="7" height="7" />
                  <rect x="14" y="3" width="7" height="7" />
                  <rect x="14" y="14" width="7" height="7" />
                  <rect x="3" y="14" width="7" height="7" />
                </svg>
                看板
              </button>
              <button class="fin-tab" id="finView-stats" onclick="switchFinanceView('stats')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                  <line x1="18" y1="20" x2="18" y2="10" />
                  <line x1="12" y1="20" x2="12" y2="4" />
                  <line x1="6" y1="20" x2="6" y2="14" />
                </svg>
                统计
              </button>
              <div style="flex:1;"></div>
              <button class="btn btn-primary" onclick="newFinanceEpisode()">+ 新建期次</button>
            </div>

            <!-- Kanban Board View -->
            <div id="finKanbanView">
              <div class="kanban-board" id="financeKanbanBoard">
                <!-- Column: 选题策划 -->
                <div class="kanban-column" data-stage="topic" ondragover="financeDragOver(event)"
                  ondragleave="financeDragLeave(event)" ondrop="financeDrop(event)">
                  <div class="kanban-column-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                    </svg>
                    <span>选题策划</span>
                    <span class="kanban-count" id="finCount-topic">0</span>
                  </div>
                  <div class="kanban-cards" id="finCards-topic"></div>
                </div>
                <!-- Column: 文案撰写 -->
                <div class="kanban-column" data-stage="draft" ondragover="financeDragOver(event)"
                  ondragleave="financeDragLeave(event)" ondrop="financeDrop(event)">
                  <div class="kanban-column-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                    </svg>
                    <span>文案撰写</span>
                    <span class="kanban-count" id="finCount-draft">0</span>
                  </div>
                  <div class="kanban-cards" id="finCards-draft"></div>
                </div>
                <!-- Column: PPT制作 -->
                <div class="kanban-column" data-stage="ppt" ondragover="financeDragOver(event)"
                  ondragleave="financeDragLeave(event)" ondrop="financeDrop(event)">
                  <div class="kanban-column-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                      <line x1="3" y1="9" x2="21" y2="9" />
                      <line x1="9" y1="21" x2="9" y2="9" />
                    </svg>
                    <span>PPT制作</span>
                    <span class="kanban-count" id="finCount-ppt">0</span>
                  </div>
                  <div class="kanban-cards" id="finCards-ppt"></div>
                </div>
                <!-- Column: 视频制作 -->
                <div class="kanban-column" data-stage="video" ondragover="financeDragOver(event)"
                  ondragleave="financeDragLeave(event)" ondrop="financeDrop(event)">
                  <div class="kanban-column-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18" />
                      <line x1="7" y1="2" x2="7" y2="22" />
                      <line x1="17" y1="2" x2="17" y2="22" />
                      <line x1="2" y1="12" x2="22" y2="12" />
                    </svg>
                    <span>视频制作</span>
                    <span class="kanban-count" id="finCount-video">0</span>
                  </div>
                  <div class="kanban-cards" id="finCards-video"></div>
                </div>
                <!-- Column: 宣发文案 -->
                <div class="kanban-column" data-stage="copy" ondragover="financeDragOver(event)"
                  ondragleave="financeDragLeave(event)" ondrop="financeDrop(event)">
                  <div class="kanban-column-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <path
                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
                    </svg>
                    <span>宣发文案</span>
                    <span class="kanban-count" id="finCount-copy">0</span>
                  </div>
                  <div class="kanban-cards" id="finCards-copy"></div>
                </div>
                <!-- Column: 社群发布 -->
                <div class="kanban-column" data-stage="publish" ondragover="financeDragOver(event)"
                  ondragleave="financeDragLeave(event)" ondrop="financeDrop(event)">
                  <div class="kanban-column-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <line x1="22" y1="2" x2="11" y2="13" />
                      <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg>
                    <span>社群发布</span>
                    <span class="kanban-count" id="finCount-publish">0</span>
                  </div>
                  <div class="kanban-cards" id="finCards-publish"></div>
                </div>
                <!-- Column: 数据归档 (Done) -->
                <div class="kanban-column done" data-stage="data" ondragover="financeDragOver(event)"
                  ondragleave="financeDragLeave(event)" ondrop="financeDrop(event)">
                  <div class="kanban-column-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <polyline points="20 6 9 17 4 12" />
                    </svg>
                    <span>已完成</span>
                    <span class="kanban-count" id="finCount-data">0</span>
                  </div>
                  <div class="kanban-cards" id="finCards-data"></div>
                </div>
              </div>
            </div>


          </div>

          <!-- Statistics View -->
          <div id="finStatsView" style="display: none; padding-top: 1rem;">
            <div class="stats-dashboard-grid"
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
              <!-- Trend Chart -->
              <div class="card" style="min-height: 400px; display: flex; flex-direction: column;">
                <div class="card-header">
                  <h3 class="card-title card-title-sm">查看率趋势</h3>
                </div>
                <div class="card-body" style="flex: 1; position: relative;">
                  <canvas id="financeTrendChart"></canvas>
                </div>
              </div>
              <!-- Heatmap -->
              <div class="card" style="min-height: 400px;">
                <div class="card-header">
                  <h3 class="card-title card-title-sm">
                    <span>发布热力图</span>
                    <select id="financeHeatmapYear" class="select-sm" onchange="renderFinanceHeatmap()"></select>
                  </h3>
                </div>
                <div class="card-body">
                  <div class="heatmap-container" id="financeHeatmap"></div>
                  <div class="heatmap-legend">
                    <span class="heatmap-legend-label">Less</span>
                    <span class="heatmap-legend-item" style="background:#ebedf0"></span>
                    <span class="heatmap-legend-item" style="background:#40c463"></span>
                    <span class="heatmap-legend-label">More</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Episode Detail Modal -->
        <div class="modal-overlay" id="financeModal" style="display:none;">
          <div class="modal-content fin-modal">
            <div class="modal-header">
              <h3 id="finModalTitle">编辑期次</h3>
              <button class="modal-close" onclick="closeFinanceModal()">&times;</button>
            </div>
            <div class="modal-body">
              <form id="financeForm">
                <input type="hidden" id="finId" />
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label class="form-label">期数</label>
                    <input type="number" id="finEpisode" min="1" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">发布日期</label>
                    <input type="date" id="finDate" required />
                  </div>
                  <div class="form-group span-2">
                    <label class="form-label">本期主题</label>
                    <input type="text" id="finTitle" placeholder="标题或关键词" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">查看人数</label>
                    <input type="number" id="finViews" min="0" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">公司总人数</label>
                    <input type="number" id="finTotal" min="1" value="260" />
                  </div>
                  <div class="form-group span-2">
                    <label class="form-label">备注</label>
                    <input type="text" id="finNote" placeholder="特殊情况记录（选填）" />
                  </div>
                </div>
                <!-- Workflow Status -->
                <div class="fin-workflow-status" style="margin-top: 1.5rem;">
                  <label class="form-label">工作流进度</label>
                  <div class="fin-workflow-chips" id="finWorkflowChips"></div>
                </div>
                <div class="form-footer" style="margin-top: 1.5rem;">
                  <button class="btn btn-secondary" type="button" onclick="closeFinanceModal()">取消</button>
                  <button class="btn btn-delete" type="button" onclick="deleteCurrentFinanceEpisode()">删除</button>
                  <button class="btn btn-primary" type="submit">保存</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>


      <!-- 预算与开销 -->
      <div class="page" id="page-budget">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <span class="card-title-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
                  <line x1="1" y1="10" x2="23" y2="10" />
                </svg></span>
              预算与开销管理
            </h2>
          </div>
          <div class="card-body">
            <p class="card-intro">按月度记录预算与实际开销，区分常规项目与特殊项目，自动计算剩余金额。</p>
            <form id="budgetForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">月份</label>
                  <input type="month" id="budgetMonth" required />
                </div>
                <div class="form-group">
                  <label class="form-label">类型</label>
                  <select id="budgetType">
                    <option value="regular">常规项目</option>
                    <option value="special">特殊项目</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">预算金额（元）</label>
                  <input type="number" min="0" id="budgetAmount" required />
                </div>
                <div class="form-group">
                  <label class="form-label">实际开销（元）</label>
                  <input type="number" min="0" id="budgetSpent" required />
                </div>
                <div class="form-group span-full">
                  <label class="form-label">备注</label>
                  <textarea id="budgetNote" placeholder="预算说明或开销原因"></textarea>
                </div>
                <input type="hidden" id="budgetId" />
                <div class="form-footer">
                  <button class="btn btn-primary" type="submit">保存记录</button>
                </div>
              </div>
            </form>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>月份</th>
                    <th>类型</th>
                    <th>预算</th>
                    <th>实际</th>
                    <th>剩余</th>
                    <th>备注</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="budgetTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

  </div>

  <input type="file" id="filePicker" accept="application/json" style="display:none;" />

  <!-- Toast 容器 -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- 确认弹窗 -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <div class="modal-header" id="confirmTitle">确认操作</div>
      <div class="modal-body" id="confirmMessage">您确定要执行此操作吗？</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeConfirm(false)">取消</button>
        <button class="btn btn-primary" id="confirmBtn" onclick="closeConfirm(true)">确认</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="backupModal">
    <div class="modal backup-modal">
      <div class="modal-header">备份码</div>
      <div class="modal-body">
        <div class="backup-hint">复制备份码到其他浏览器粘贴后导入，可跨设备恢复全部数据。</div>
        <textarea id="backupCodeInput" class="backup-textarea" placeholder="在这里粘贴备份码"></textarea>
        <div class="backup-meta">
          <span id="backupCodeSize">0 字符</span>
          <span id="backupCodeStatus">未生成</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeBackupModal()">关闭</button>
        <button class="btn btn-secondary" onclick="generateBackupCode()">生成备份码</button>
        <button class="btn btn-secondary" onclick="copyBackupCode()">复制</button>
        <button class="btn btn-danger" onclick="forceClearCache()" title="清除本地缓存并重新拉取线上最新数据">强制刷新数据</button>
        <button class="btn btn-primary" onclick="restoreBackupCode()">导入</button>
      </div>
    </div>
  </div>

  <script>
    const uid = () => Math.random().toString(36).slice(2, 10);
    const STORAGE_KEY = 'surfin_ld_system_v2';

    const state = {
      sessions: [],
      budgets: [],
      aiStations: [],
      aiShares: [],
      aiStationTitles: {},
      aiShareTitles: {},
      aiStationTasks: [],
      aiShareTasks: [],
      currentStationEpisode: null,
      currentShareEpisode: null
    };

    const pageTitles = {
      dashboard: '培训大屏',
      training: '培训管理',
      aiknowledge: 'AI 知识库',
      budget: '预算与开销'
    };

    /* =========================================
       2. 工具函数 (Toast & Modal)
       ========================================= */

    // Toast 提示
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      let icon = '';
      if (type === 'success') icon = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
      else if (type === 'error') icon = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
      else icon = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';

      toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
      container.appendChild(toast);

      // 3秒后移除
      setTimeout(() => {
        toast.style.animation = 'toast-out 0.3s forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Confirm 弹窗
    let currentConfirmCallback = null;
    const modalEl = document.getElementById('confirmModal');

    function showConfirm(message, onConfirm) {
      document.getElementById('confirmMessage').textContent = message;
      modalEl.classList.add('active');
      currentConfirmCallback = onConfirm;
    }

    window.closeConfirm = function (confirmed) {
      modalEl.classList.remove('active');
      if (confirmed && currentConfirmCallback) {
        currentConfirmCallback();
      }
      currentConfirmCallback = null;
    };

    // 主题切换
    function setTheme(theme) {
      if (theme === 'default') {
        document.body.removeAttribute('data-theme');
      } else {
        document.body.setAttribute('data-theme', theme);
      }
      localStorage.setItem('surfin_theme', theme);
      document.getElementById('themeDropdown').classList.remove('active');
      showToast(`已切换至「${getThemeName(theme)}」主题`, 'info');
      // 触发图表刷新以适配背景
      setTimeout(renderAll, 300);
    }

    function getThemeName(theme) {
      const names = { default: '经典原力', dark: '暗夜星辰', wine: '流金岁月', mint: '生机薄荷', craft: '匠心工匠' };
      return names[theme] || '未知';
    }

    function toggleThemeDropdown(e) {
      e.stopPropagation();
      document.getElementById('themeDropdown').classList.toggle('active');
    }

    document.addEventListener('click', () => {
      document.getElementById('themeDropdown').classList.remove('active');
    });

    /* =========================================
       3. 数据初始化 & 逻辑
       ========================================= */

    // 数据版本号：每次更新 data.json 时递增此版本号
    const DATA_VERSION = 2;
    const DEFAULT_DATA = {
      sessions: [],
      budgets: [],
      aiStations: [],
      aiShares: [],
      financeWiki: [],
      aiStationTitles: {},
      aiShareTitles: {},
      financeTitles: {},
      aiStationTasks: [],
      aiShareTasks: [],
      financeTasks: [],
      currentStationEpisode: null,
      currentShareEpisode: null,
      currentFinanceEpisode: null
    };

    async function loadRemoteData() {
      try {
        const response = await fetch(`data.json?v=${DATA_VERSION}`, { cache: 'no-store' });
        if (!response.ok) return false;
        const data = await response.json();
        const payload = data && data.data && typeof data.data === 'object' ? data.data : data;
        const hasPayload = ['sessions', 'budgets', 'aiStations', 'aiShares', 'aiStationTasks', 'aiShareTasks']
          .some(key => Array.isArray(payload[key]));
        if (!hasPayload) return false;
        applyImportedState(payload);
        persist();
        localStorage.setItem(STORAGE_KEY + '_version', String(DATA_VERSION));
        return true;
      } catch (err) {
        return false;
      }
    }

    function seedDefaultData() {
      applyImportedState(DEFAULT_DATA);
      persist();
      localStorage.setItem(STORAGE_KEY + '_version', String(DATA_VERSION));
    }

    async function initData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const savedVersion = localStorage.getItem(STORAGE_KEY + '_version');

      if (raw && savedVersion === String(DATA_VERSION)) {
        try {
          const localData = JSON.parse(raw);
          const hasLocalPayload = ['sessions', 'budgets', 'aiStations', 'aiShares', 'aiStationTasks', 'aiShareTasks']
            .some(key => Array.isArray(localData[key]) && localData[key].length > 0);
          if (hasLocalPayload) {
            // 版本号匹配且有内容，使用本地缓存数据
            Object.assign(state, localData);
            if (!state.aiStationTitles || typeof state.aiStationTitles !== 'object') state.aiStationTitles = {};
            if (!state.aiShareTitles || typeof state.aiShareTitles !== 'object') state.aiShareTitles = {};
            return;
          }
        } catch (err) {
          // ignore parse error, fallback to remote
        }
      }

      const loaded = await loadRemoteData();
      if (!loaded) seedDefaultData();
    }


    function persist() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function calcManHours(s) { return Number(s.people) * Number(s.duration); }

    // 侧边栏收起/展开
    const sidebar = document.getElementById('sidebar');
    const mainWrapper = document.querySelector('.main-wrapper');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOpen = document.getElementById('sidebarOpen');

    // 从 localStorage 读取侧边栏状态
    const sidebarCollapsed = localStorage.getItem('sidebar_collapsed') === 'true';
    if (sidebarCollapsed) {
      sidebar.classList.add('collapsed');
      mainWrapper.classList.add('expanded');
    }

    function toggleSidebar(collapse) {
      if (collapse) {
        sidebar.classList.add('collapsed');
        mainWrapper.classList.add('expanded');
      } else {
        sidebar.classList.remove('collapsed');
        mainWrapper.classList.remove('expanded');
      }
      localStorage.setItem('sidebar_collapsed', collapse);
    }

    sidebarToggle.addEventListener('click', () => toggleSidebar(true));
    sidebarOpen.addEventListener('click', () => toggleSidebar(false));

    // 导航
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.dataset.page;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + page).classList.add('active');
        document.getElementById('pageTitle').textContent = pageTitles[page];
        if (page === 'aiknowledge') {
          requestAnimationFrame(() => {
            renderAIKnowledge();
          });
        }
      });
    });

    function renderSessions() {
      const tbody = document.getElementById('sessionTable');
      tbody.innerHTML = '';
      if (state.sessions.length === 0) {
        tbody.innerHTML = '<tr><td class="empty-cell" colspan="9">暂无培训记录</td></tr>';
        return;
      }
      state.sessions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.date}</td>
          <td>${item.course}</td>
          <td>${item.project}</td>
          <td>${item.lecturer}</td>
          <td>${item.people}</td>
          <td>${item.duration}h</td>
          <td><strong>${calcManHours(item)}</strong></td>
          <td>${item.note || '-'}</td>
          <td>
            <div class="actions-row">
              <button class="btn btn-edit" onclick="editSession('${item.id}')">编辑</button>
              <button class="btn btn-delete" onclick="deleteSession('${item.id}')">删除</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderBudgets() {
      const tbody = document.getElementById('budgetTable');
      tbody.innerHTML = '';
      if (state.budgets.length === 0) {
        tbody.innerHTML = '<tr><td class="empty-cell" colspan="7">暂无预算记录</td></tr>';
        return;
      }
      state.budgets.sort((a, b) => b.month.localeCompare(a.month)).forEach(item => {
        const remain = Number(item.amount) - Number(item.spent);
        const typeLabel = item.type === 'regular' ? '<span class="tag tag-primary">常规</span>' : '<span class="tag tag-warning">特殊</span>';
        const remainClass = remain >= 0 ? 'val-positive' : 'val-negative';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.month}</td>
          <td>${typeLabel}</td>
          <td>¥${item.amount.toLocaleString()}</td>
          <td>¥${item.spent.toLocaleString()}</td>
          <td class="${remainClass}">¥${remain.toLocaleString()}</td>
          <td>${item.note || '-'}</td>
          <td>
            <div class="actions-row">
              <button class="btn btn-edit" onclick="editBudget('${item.id}')">编辑</button>
              <button class="btn btn-delete" onclick="deleteBudget('${item.id}')">删除</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function resetSessionForm() { document.getElementById('sessionForm').reset(); document.getElementById('sessionId').value = ''; }
    function resetBudgetForm() { document.getElementById('budgetForm').reset(); document.getElementById('budgetId').value = ''; }

    window.editSession = function (id) {
      const item = state.sessions.find(s => s.id === id);
      if (!item) return;
      document.getElementById('sessionId').value = item.id;
      document.getElementById('sessionDate').value = item.date;
      document.getElementById('sessionCourse').value = item.course;
      document.getElementById('sessionProject').value = item.project;
      document.getElementById('sessionLecturer').value = item.lecturer;
      document.getElementById('sessionPeople').value = item.people;
      document.getElementById('sessionDuration').value = item.duration;
      document.getElementById('sessionNote').value = item.note;
      document.querySelector('.nav-item[data-page="training"]').click();
    };

    window.deleteSession = function (id) {
      showConfirm('确认删除这条培训记录吗？此操作不可恢复。', () => {
        state.sessions = state.sessions.filter(s => s.id !== id);
        persist(); renderAll();
        showToast('记录已删除', 'success');
      });
    };

    window.editBudget = function (id) {
      const item = state.budgets.find(s => s.id === id);
      if (!item) return;
      document.getElementById('budgetId').value = item.id;
      document.getElementById('budgetMonth').value = item.month;
      document.getElementById('budgetType').value = item.type;
      document.getElementById('budgetAmount').value = item.amount;
      document.getElementById('budgetSpent').value = item.spent;
      document.getElementById('budgetNote').value = item.note;
      document.querySelector('.nav-item[data-page="budget"]').click();
    };

    window.deleteBudget = function (id) {
      showConfirm('确认删除这条预算记录吗？此操作不可恢复。', () => {
        state.budgets = state.budgets.filter(s => s.id !== id);
        persist(); renderAll();
        showToast('记录已删除', 'success');
      });
    };

    function renderStats() {
      const now = new Date();
      const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const monthSessions = state.sessions.filter(s => s.date.startsWith(monthStr));
      const totalHours = monthSessions.reduce((sum, s) => sum + calcManHours(s), 0);
      const monthPeople = monthSessions.reduce((sum, s) => sum + (Number(s.people) || 0), 0);
      const latest = monthSessions.sort((a, b) => new Date(b.date) - new Date(a.date))[0];

      document.getElementById('statSessions').textContent = monthSessions.length;
      document.getElementById('statHours').textContent = totalHours.toLocaleString();
      document.getElementById('statUpcoming').textContent = latest ? `最近：${latest.course}` : '最近培训：-';

      const monthBudgets = state.budgets.filter(b => b.month === monthStr);
      const spentTotal = monthBudgets.reduce((s, b) => s + (Number(b.spent) || 0), 0);

      document.getElementById('statMonthPeople').textContent = monthPeople.toLocaleString();
      document.getElementById('statMonthSpend').textContent = `¥${spentTotal.toLocaleString()}`;

      const dashboardYear = 2026;
      const yearPrefix = `${dashboardYear}-`;
      const yearSessions = state.sessions.filter(s => s.date.startsWith(yearPrefix));
      const yearBudgets = state.budgets.filter(b => b.month.startsWith(yearPrefix));
      const yearPeople = yearSessions.reduce((sum, s) => sum + (Number(s.people) || 0), 0);
      const yearHours = yearSessions.reduce((sum, s) => sum + calcManHours(s), 0);
      const yearSpend = yearBudgets.reduce((sum, b) => sum + (Number(b.spent) || 0), 0);

      document.getElementById('statYearSessions').textContent = yearSessions.length;
      document.getElementById('statYearPeople').textContent = yearPeople.toLocaleString();
      document.getElementById('statYearHours').textContent = yearHours.toLocaleString();
      document.getElementById('statYearSpend').textContent = `¥${yearSpend.toLocaleString()}`;

      // Update Finance Wiki Stat
      const finTotal = state.financeWiki ? state.financeWiki.length : 0;
      const finEl = document.getElementById('statFinanceTotal');
      if (finEl) finEl.textContent = finTotal;

    }

    let hoursChart, budgetChart, costPie;

    function renderCharts() {
      const styles = getComputedStyle(document.documentElement);
      const read = (name, fallback) => styles.getPropertyValue(name).trim() || fallback;
      const colors = {
        primary: read('--dashboard-chart-primary', read('--primary', '#1E455F')),
        primaryLight: read('--dashboard-chart-primary', read('--primary-light', '#4B6E86')),
        primaryAlpha: read('--dashboard-chart-primary-fill', read('--primary-glow', 'rgba(75, 110, 134, 0.18)')),
        accent: read('--dashboard-chart-accent', read('--accent-danger', '#C07C7B')),
        grid: read('--chart-grid', 'rgba(28, 43, 58, 0.08)'),
        text: read('--text-muted', '#9AA6B2'),
        title: read('--text-title', '#1C2B3A')
      };

      const byMonth = {};
      state.sessions.forEach(s => {
        const month = s.date.slice(0, 7);
        byMonth[month] = (byMonth[month] || 0) + calcManHours(s);
      });
      const monthLabels = Object.keys(byMonth).sort();
      const hoursData = monthLabels.map(m => byMonth[m]);

      if (hoursChart) hoursChart.destroy();
      hoursChart = new Chart(document.getElementById('hoursChart'), {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [{
            label: '总人时',
            data: hoursData,
            borderColor: colors.primary,
            backgroundColor: colors.primaryAlpha,
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: colors.primary,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: colors.text, font: { size: 11 } } },
            y: { grid: { color: colors.grid }, ticks: { color: colors.text, font: { size: 11 } } }
          }
        }
      });

      const months = [...new Set(state.budgets.map(b => b.month))].sort();
      const budgetAmount = months.map(m => state.budgets.filter(b => b.month === m).reduce((s, b) => s + Number(b.amount), 0));
      const budgetSpent = months.map(m => state.budgets.filter(b => b.month === m).reduce((s, b) => s + Number(b.spent), 0));

      if (budgetChart) budgetChart.destroy();
      budgetChart = new Chart(document.getElementById('budgetChart'), {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            { label: '预算', data: budgetAmount, backgroundColor: colors.primary, borderRadius: 6, barThickness: 32, maxBarThickness: 40 },
            { label: '实际', data: budgetSpent, backgroundColor: colors.accent, borderRadius: 6, barThickness: 32, maxBarThickness: 40 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top', align: 'end', labels: { usePointStyle: true, pointStyle: 'rect', font: { size: 11 }, color: colors.text, padding: 12 } } },
          scales: {
            x: { grid: { display: false }, ticks: { color: colors.text, font: { size: 11 } } },
            y: { grid: { color: colors.grid }, ticks: { color: colors.text, font: { size: 11 } } }
          }
        }
      });

      const costRegular = state.budgets.filter(b => b.type === 'regular').reduce((s, b) => s + Number(b.spent), 0);
      const costSpecial = state.budgets.filter(b => b.type === 'special').reduce((s, b) => s + Number(b.spent), 0);
      const totalSpent = costRegular + costSpecial;

      // 圆心文字插件
      const centerTextPlugin = {
        id: 'centerText',
        beforeDraw: function (chart) {
          if (chart.config.type !== 'doughnut') return;
          const { ctx, chartArea } = chart;
          if (!chartArea) return;

          // 计算圆环真正的圆心位置
          const centerX = (chartArea.left + chartArea.right) / 2;
          const centerY = (chartArea.top + chartArea.bottom) / 2;

          ctx.restore();

          // 总支出标签
          ctx.font = '500 12px "Helvetica Neue", sans-serif';
          ctx.fillStyle = colors.text;
          ctx.textBaseline = 'middle';
          ctx.textAlign = 'center';
          ctx.fillText('总支出', centerX, centerY - 10);

          // 金额
          ctx.font = '700 20px "Helvetica Neue", sans-serif';
          ctx.fillStyle = colors.title;
          ctx.fillText('¥' + totalSpent.toLocaleString(), centerX, centerY + 12);

          ctx.save();
        }
      };

      if (costPie) costPie.destroy();
      costPie = new Chart(document.getElementById('costPie'), {
        type: 'doughnut',
        data: {
          labels: ['常规开销', '特殊开销'],
          datasets: [{
            data: [costRegular, costSpecial],
            backgroundColor: [colors.primary, colors.accent],
            borderWidth: 0,
            hoverOffset: 4,
            borderRadius: 6,
            spacing: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '72%',
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'rect', font: { size: 11 }, color: colors.text, padding: 16 } } }
        },
        plugins: [centerTextPlugin]
      });
    }

    // 导出功能
    const BACKUP_PREFIX = 'S-LD:';

    function parseEpisodeLike(value) {
      if (value === null || value === undefined) return null;
      const trimmed = String(value).trim();
      if (!trimmed) return null;
      const direct = Number(trimmed);
      if (Number.isFinite(direct)) return direct;
      const match = trimmed.match(/(\d+)/);
      if (match) return Number(match[1]);
      return null;
    }

    function normalizeEpisodeList(list) {
      return list.map(item => {
        const episode = parseEpisodeLike(item.episode);
        return Number.isFinite(episode) ? { ...item, episode } : item;
      });
    }

    function normalizeTaskEpisodes(list) {
      return list.map(item => {
        const episode = parseEpisodeLike(item.episode);
        return Number.isFinite(episode) ? { ...item, episode } : item;
      });
    }

    function buildTaskEpisodeStats(tasks) {
      const stats = new Map();
      tasks.forEach(task => {
        const episode = parseEpisodeLike(task.episode);
        if (!Number.isFinite(episode)) return;
        const entry = stats.get(episode) || { total: 0, done: 0 };
        entry.total += 1;
        if (task.done === true || task.done === 'true') entry.done += 1;
        stats.set(episode, entry);
      });
      return stats;
    }

    function pickEpisodeFromTasks(stats) {
      let candidate = null;
      stats.forEach((info, episode) => {
        const score = [
          info.done > 0 ? 1 : 0,
          info.done,
          info.total,
          episode
        ];
        if (!candidate) {
          candidate = { episode, score };
          return;
        }
        for (let i = 0; i < score.length; i += 1) {
          if (score[i] !== candidate.score[i]) {
            if (score[i] > candidate.score[i]) candidate = { episode, score };
            return;
          }
        }
      });
      return candidate ? candidate.episode : null;
    }

    function normalizeEpisodeValue(current, list, tasks, titles) {
      const currentNum = parseEpisodeLike(current);
      const taskStats = buildTaskEpisodeStats(tasks);
      const taskEpisodes = Array.from(taskStats.keys());
      const listEpisodes = list.map(item => parseEpisodeLike(item.episode)).filter(Number.isFinite);
      const titleEpisodes = Object.keys(titles || {}).map(parseEpisodeLike).filter(Number.isFinite);
      const allEpisodes = Array.from(new Set([...taskEpisodes, ...listEpisodes, ...titleEpisodes]));
      if (!allEpisodes.length) return Number.isFinite(currentNum) ? currentNum : null;
      const maxEpisode = Math.max(...allEpisodes);
      const taskPick = pickEpisodeFromTasks(taskStats);
      if (!Number.isFinite(currentNum)) return pickEpisodeFromTasks(taskStats) ?? maxEpisode;
      const hasCurrent = allEpisodes.includes(currentNum);
      const hasDone = Array.from(taskStats.values()).some(info => info.done > 0);
      if (taskPick !== null) {
        if (!taskStats.has(currentNum)) return taskPick;
        const info = taskStats.get(currentNum);
        if (hasDone && info.done === 0 && taskPick !== currentNum) return taskPick;
      }
      if (taskStats.has(currentNum)) return currentNum;
      if (!hasCurrent) return taskPick ?? maxEpisode;
      if (currentNum === 0 && maxEpisode > 0) return taskPick ?? maxEpisode;
      return currentNum;
    }

    function normalizeImportedEpisodes() {
      state.currentStationEpisode = normalizeEpisodeValue(
        state.currentStationEpisode,
        state.aiStations,
        state.aiStationTasks,
        state.aiStationTitles
      );
      state.currentShareEpisode = normalizeEpisodeValue(
        state.currentShareEpisode,
        state.aiShares,
        state.aiShareTasks,
        state.aiShareTitles
      );
      if (state.currentStationEpisode !== null && state.currentStationEpisode !== undefined) {
        applyStationEpisode(state.currentStationEpisode);
      }
      if (state.currentShareEpisode !== null && state.currentShareEpisode !== undefined) {
        applyShareEpisode(state.currentShareEpisode);
      }
    }

    function applyImportedState(payload) {
      state.sessions = Array.isArray(payload.sessions) ? payload.sessions : [];
      state.budgets = Array.isArray(payload.budgets) ? payload.budgets : [];
      state.aiStations = Array.isArray(payload.aiStations) ? normalizeEpisodeList(payload.aiStations) : [];
      state.aiShares = Array.isArray(payload.aiShares) ? normalizeEpisodeList(payload.aiShares) : [];
      state.aiStationTasks = Array.isArray(payload.aiStationTasks) ? normalizeTaskEpisodes(payload.aiStationTasks) : [];
      state.aiShareTasks = Array.isArray(payload.aiShareTasks) ? normalizeTaskEpisodes(payload.aiShareTasks) : [];
      state.aiStationTitles = payload.aiStationTitles && typeof payload.aiStationTitles === 'object' ? payload.aiStationTitles : {};
      state.aiShareTitles = payload.aiShareTitles && typeof payload.aiShareTitles === 'object' ? payload.aiShareTitles : {};
      const stationEpisode = parseEpisodeLike(payload.currentStationEpisode);
      const shareEpisode = parseEpisodeLike(payload.currentShareEpisode);
      state.currentStationEpisode = Number.isFinite(stationEpisode) ? stationEpisode : null;
      state.currentShareEpisode = Number.isFinite(shareEpisode) ? shareEpisode : null;
    }

    function encodeBackupPayload(payload) {
      const json = JSON.stringify(payload);
      return BACKUP_PREFIX + btoa(unescape(encodeURIComponent(json)));
    }

    function decodeBackupPayload(raw) {
      const trimmed = raw.trim();
      if (!trimmed) throw new Error('备份码为空');
      if (trimmed.startsWith('{')) return JSON.parse(trimmed);
      const cleaned = trimmed.replace(/\s+/g, '');
      const base = cleaned.startsWith(BACKUP_PREFIX) ? cleaned.slice(BACKUP_PREFIX.length) : cleaned;
      const json = decodeURIComponent(escape(atob(base)));
      return JSON.parse(json);
    }

    window.exportJson = function () {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'surfin-ld-data.json'; a.click();
      URL.revokeObjectURL(url);
    };

    window.importJson = function () {
      document.getElementById('filePicker').click();
    };

    document.getElementById('filePicker').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data || typeof data !== 'object') throw new Error('文件格式不正确');
          const payload = data.data && typeof data.data === 'object' ? data.data : data;
          const hasPayload = ['sessions', 'budgets', 'aiStations', 'aiShares', 'aiStationTasks', 'aiShareTasks']
            .some(key => Array.isArray(payload[key]));
          if (!hasPayload) throw new Error('缺少关键字段');
          applyImportedState(payload);
          normalizeImportedEpisodes();
          localStorage.setItem(STORAGE_KEY + '_version', String(DATA_VERSION));
          renderAll();
          renderAIKnowledge();
          showToast('数据导入成功', 'success');
        } catch (err) { showToast('导入失败：' + err.message, 'error'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    const backupCodeInput = document.getElementById('backupCodeInput');
    const backupCodeSize = document.getElementById('backupCodeSize');
    const backupCodeStatus = document.getElementById('backupCodeStatus');

    function updateBackupMeta(statusText) {
      if (!backupCodeInput) return;
      const size = backupCodeInput.value.trim().length;
      if (backupCodeSize) backupCodeSize.textContent = `${size} 字符`;
      if (statusText && backupCodeStatus) backupCodeStatus.textContent = statusText;
    }

    window.openBackupModal = function () {
      const modal = document.getElementById('backupModal');
      if (!modal) return;
      modal.classList.add('active');
      window.generateBackupCode();
    };

    window.closeBackupModal = function () {
      const modal = document.getElementById('backupModal');
      if (!modal) return;
      modal.classList.remove('active');
    };

    window.generateBackupCode = function () {
      if (!backupCodeInput) return;
      const payload = { version: DATA_VERSION, createdAt: new Date().toISOString(), data: state };
      backupCodeInput.value = encodeBackupPayload(payload);
      updateBackupMeta('已生成');
    };

    window.copyBackupCode = function () {
      if (!backupCodeInput) return;
      const text = backupCodeInput.value.trim();
      if (!text) {
        showToast('没有备份码可复制', 'error');
        return;
      }
      const done = () => {
        showToast('备份码已复制', 'success');
        updateBackupMeta('已复制');
      };
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(done).catch(() => {
          backupCodeInput.select();
          document.execCommand('copy');
          done();
        });
      } else {
        backupCodeInput.select();
        document.execCommand('copy');
        done();
      }
    };

    window.restoreBackupCode = function () {
      if (!backupCodeInput) return;
      const raw = backupCodeInput.value.trim();
      if (!raw) {
        showToast('请先粘贴备份码', 'error');
        return;
      }
      try {
        const data = decodeBackupPayload(raw);
        const payload = data && data.data && typeof data.data === 'object' ? data.data : data;
        const hasPayload = ['sessions', 'budgets', 'aiStations', 'aiShares', 'aiStationTasks', 'aiShareTasks']
          .some(key => Array.isArray(payload[key]));
        if (!hasPayload) throw new Error('缺少关键字段');
        applyImportedState(payload);
        normalizeImportedEpisodes();
        localStorage.setItem(STORAGE_KEY + '_version', String(DATA_VERSION));
        renderAll();
        renderAIKnowledge();
        updateBackupMeta('已导入');
        showToast('备份码已导入', 'success');
      } catch (err) {
        showToast('导入失败：' + err.message, 'error');
      }
    };

    window.forceClearCache = function () {
      showConfirm('确定要强制刷新吗？\n警告：这将清空本地所有缓存数据（包括您未导出的新记录），并强制重新拉取 GitHub 上的 data.json。\n\n建议操作前先点击「生成备份码」备份当前数据！', () => {
        localStorage.clear();
        location.reload();
      });
    };

    if (backupCodeInput) {
      updateBackupMeta('未生成');
      backupCodeInput.addEventListener('input', () => updateBackupMeta());
    }

    window.exportExcel = function () {
      const wb = XLSX.utils.book_new();

      // 培训记录表
      const sessionsData = state.sessions.map(s => ({
        '时间': s.date,
        '课程': s.course,
        '项目': s.project,
        '讲师': s.lecturer,
        '人数': s.people,
        '时长(h)': s.duration,
        '总人时': calcManHours(s),
        '备注': s.note || ''
      }));
      const ws1 = XLSX.utils.json_to_sheet(sessionsData);
      XLSX.utils.book_append_sheet(wb, ws1, '培训记录');

      // 预算记录表
      const budgetsData = state.budgets.map(b => ({
        '月份': b.month,
        '类型': b.type === 'regular' ? '常规' : '特殊',
        '预算': b.amount,
        '实际': b.spent,
        '剩余': b.amount - b.spent,
        '备注': b.note || ''
      }));
      const ws2 = XLSX.utils.json_to_sheet(budgetsData);
      XLSX.utils.book_append_sheet(wb, ws2, '预算开销');

      XLSX.writeFile(wb, 'Surfin学习发展数据.xlsx');
    };

    window.exportPdf = async function () {
      const activePageId = document.querySelector('.page.active').id;
      const element = document.querySelector('.page.active');
      const canvas = await html2canvas(element, { scale: 3, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
      const imgWidth = imgProps.width * ratio * 0.9;
      const imgHeight = imgProps.height * ratio * 0.9;
      pdf.addImage(imgData, 'PNG', (pageWidth - imgWidth) / 2, 10, imgWidth, imgHeight);
      pdf.save(`Surfin-${pageTitles[activePageId.replace('page-', '')]}.pdf`);
    };

    function renderAll() {
      renderSessions();
      renderBudgets();
      renderStats();
      renderCharts();
      renderFinanceWiki();
      persist();
    }

    document.getElementById('sessionForm').addEventListener('submit', e => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('sessionId').value || uid(),
        date: document.getElementById('sessionDate').value,
        course: document.getElementById('sessionCourse').value,
        project: document.getElementById('sessionProject').value,
        lecturer: document.getElementById('sessionLecturer').value,
        people: Number(document.getElementById('sessionPeople').value),
        duration: Number(document.getElementById('sessionDuration').value),
        note: document.getElementById('sessionNote').value
      };
      const existing = state.sessions.find(s => s.id === payload.id);
      if (existing) Object.assign(existing, payload);
      else state.sessions.push(payload);
      resetSessionForm(); renderAll();
      showToast('培训记录已保存', 'success');
    });

    document.getElementById('budgetForm').addEventListener('submit', e => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('budgetId').value || uid(),
        month: document.getElementById('budgetMonth').value,
        type: document.getElementById('budgetType').value,
        amount: Number(document.getElementById('budgetAmount').value),
        spent: Number(document.getElementById('budgetSpent').value),
        note: document.getElementById('budgetNote').value
      };
      const existing = state.budgets.find(b => b.id === payload.id);
      if (existing) Object.assign(existing, payload);
      else state.budgets.push(payload);
      resetBudgetForm(); renderAll();
      showToast('预算记录已保存', 'success');
    });

    // 初始化
    (async () => {
      await initData();
      // 加载主题
      const savedTheme = localStorage.getItem('surfin_theme');
      if (savedTheme) {
        if (savedTheme === 'default') document.body.removeAttribute('data-theme');
        else document.body.setAttribute('data-theme', savedTheme);
      }
      renderAll();
    })();

    // ============ AI 知识库功能 ============

    // Tab 切换
    document.querySelectorAll('.ai-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.ai-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
        refreshAICharts(tab.dataset.tab);
      });
    });

    // 任务模板
    const stationStageDefs = [
      { id: 'theme', title: '主题确定', desc: '方向与受众', wip: 1, accent: 'var(--primary)' },
      { id: 'writing', title: '文案制作', desc: '主文档成型', wip: 1, accent: 'var(--primary-light)' },
      { id: 'sync', title: '同步归档', desc: '钉钉/飞书一致', wip: 1, accent: 'var(--primary-light)' },
      { id: 'produce', title: '资产制作', desc: '海报与播客', wip: 2, accent: 'var(--accent-warning)' },
      { id: 'assemble', title: '组装检查', desc: '新闻&发刊词', wip: 2, accent: 'var(--accent-success)' },
      { id: 'publish', title: '群内发布', desc: '群内触达', wip: 1, accent: 'var(--primary)' },
      { id: 'data', title: '数据回收', desc: '查看率&下载', wip: 1, accent: 'var(--accent-success)' },
      { id: 'review', title: '复盘总结', desc: '经验与优化', wip: 1, accent: 'var(--text-muted)' }
    ];

    const stationTaskTemplate = [
      { name: '确定本期主题', stage: 'theme', tool: '主题对齐', output: '选题定位', detail: '明确看点与受众', owner: '策划' },
      { name: '主文案撰写', stage: 'writing', tool: '钉钉文档', output: '主稿', detail: '可直接发布', owner: '内容' },
      { name: '飞书归档同步', stage: 'sync', tool: '飞书文档', output: '归档记录', detail: '版本一致', owner: '归档' },
      { name: '视觉海报制作', stage: 'produce', tool: 'Gemini', output: '海报/封面', detail: '主视觉', owner: '设计' },
      { name: 'AI 播客制作', stage: 'produce', tool: '豆包', output: '播客', detail: '音频成品', owner: '剪辑' },
      { name: '全球 AI 新闻撰写', stage: 'assemble', tool: '钉钉文档', output: '新闻区块', detail: '嵌入广播站', owner: '内容' },
      { name: '发刊词撰写', stage: 'assemble', tool: '钉钉文档', output: '发刊词', detail: '开场引导', owner: '内容' },
      { name: '钉钉群发布', stage: 'publish', tool: '钉钉群', output: '触达发布', detail: '群内推送', owner: '运营' },
      { name: '数据回收与查看率', stage: 'data', tool: '数据回收', output: '查看率', detail: '发布后 2 天', owner: '分析' },
      { name: '复盘与改进', stage: 'review', tool: '复盘模板', output: '优化清单', detail: '沉淀经验', owner: '复盘' }
    ];

    const stationTaskAliases = {
      '选题确定': '确定本期主题',
      '内容撰写': '主文案撰写',
      '制作发布': '钉钉群发布',
      '数据回收': '数据回收与查看率'
    };

    const shareStageDefs = [
      { id: 'theme', title: '主题确定', desc: '目标与受众', wip: 1, accent: 'var(--primary)' },
      { id: 'dev', title: '课程开发', desc: '课件/脚本', wip: 1, accent: 'var(--primary-light)' },
      { id: 'material', title: '宣发物料', desc: '文案/海报/码', wip: 1, accent: 'var(--accent-warning)' },
      { id: 'notify1', title: '首轮通知', desc: '全员宣发(T-6)', wip: 1, accent: 'var(--accent-success)' },
      { id: 'notify2', title: '二轮通知', desc: '提醒/确认(T-2)', wip: 1, accent: 'var(--accent-success)' },
      { id: 'group', title: '建群倒计时', desc: '双群/海报', wip: 1, accent: 'var(--accent-info)' },
      { id: 'execute', title: '培训执行', desc: '现场与互动', wip: 1, accent: 'var(--accent-danger)' },
      { id: 'archive', title: '数据归档', desc: '人数与档案', wip: 1, accent: 'var(--text-muted)' }
    ];

    const shareTaskTemplate = [
      { name: '主题确定', stage: 'theme', tool: '需求对齐', output: '主题&目标', detail: '明确人群', owner: '' },
      { name: '课程开发', stage: 'dev', tool: 'PPT/脚本', output: '课件', detail: '内容开发', owner: '' },
      { name: '宣发物料', stage: 'material', tool: '设计/文案', output: '海报/二维码', detail: '物料准备', owner: '' },
      { name: '首轮通知', stage: 'notify1', tool: '钉钉/飞书', output: '通知已发', detail: '周五预告', owner: '' },
      { name: '二轮通知', stage: 'notify2', tool: '钉钉/飞书', output: '名单确认', detail: '周二/三确认', owner: '' },
      { name: '建群倒计时', stage: 'group', tool: '社群运营', output: '群/倒计时', detail: '氛围营造', owner: '' },
      { name: '培训执行', stage: 'execute', tool: '线下/直播', output: '培训完成', detail: '控场/录制', owner: '' },
      { name: '数据归档', stage: 'archive', tool: '档案库', output: '归档记录', detail: '人数/资料', owner: '' }
    ];

    const shareTaskAliases = {};
    const stationTaskTemplateMap = new Map(stationTaskTemplate.map(task => [task.name, task]));
    const shareTaskTemplateMap = new Map(shareTaskTemplate.map(task => [task.name, task]));

    // 分类标签映射
    const categoryMap = {
      news: { label: 'AI 新闻', class: 'tag-news' },
      tool: { label: 'AI 工具', class: 'tag-tool' },
      paper: { label: 'AI 论文', class: 'tag-paper' },
      thought: { label: 'AI 思考', class: 'tag-thought' },
      mixed: { label: '综合', class: 'tag-mixed' }
    };

    // 图表实例
    let stationChart = null;
    let shareChart = null;
    let stationChartRange = { start: 0, count: 12 };
    const stationChartGesture = {
      wheelDelta: 0,
      zoomDelta: 0,
      touchDistance: null,
      touchCenterX: null
    };
    let stationChartGesturesBound = false;

    function parseEpisodeValue(value) {
      const trimmed = String(value).trim();
      if (!trimmed) return null;
      const parsed = Number(trimmed);
      if (!Number.isInteger(parsed) || parsed < 0) return null;
      return parsed;
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function getEpisodeTitle(list, episode, fallback, titleMap) {
      if (episode === null || episode === undefined) return fallback;
      const key = String(episode);
      if (titleMap && titleMap[key]) return titleMap[key];
      const item = list.find(entry => entry.episode === episode);
      if (item && item.title) return item.title;
      return fallback;
    }

    function updateEpisodeTitle(list, titleMap, episode, value) {
      if (episode === null || episode === undefined) return;
      const key = String(episode);
      const title = String(value || '').trim();
      if (title) titleMap[key] = title;
      else delete titleMap[key];
      const item = list.find(entry => entry.episode === episode);
      if (item) item.title = title;
    }

    function focusEpisodePicker(inputId, episode) {
      const picker = document.getElementById(inputId);
      if (!picker) return false;
      picker.value = episode;
      picker.focus();
      picker.select();
      return true;
    }

    function ensureEpisodeTasks(taskList, episode, template, aliasMap) {
      let added = false;
      const existing = taskList.filter(task => task.episode === episode);
      template.forEach(task => {
        const hasTask = existing.some(item => item.name === task.name || aliasMap[item.name] === task.name);
        if (!hasTask) {
          taskList.push({
            id: uid(),
            episode,
            name: task.name,
            stage: task.stage,
            tool: task.tool,
            output: task.output,
            detail: task.detail,
            owner: task.owner,
            done: false
          });
          added = true;
        }
      });
      return added;
    }

    function applyStationEpisode(episode) {
      state.currentStationEpisode = episode;
      ensureEpisodeTasks(state.aiStationTasks, episode, stationTaskTemplate, stationTaskAliases);
      persist();
      renderStationKanban();
      const formInput = document.getElementById('stationEpisode');
      if (formInput) formInput.value = episode;
      const picker = document.getElementById('stationEpisodePicker');
      if (picker) picker.value = episode;
    }

    function applyShareEpisode(episode) {
      state.currentShareEpisode = episode;
      ensureEpisodeTasks(state.aiShareTasks, episode, shareTaskTemplate, shareTaskAliases);
      persist();
      renderShareKanban();
      const formInput = document.getElementById('shareEpisode');
      if (formInput) formInput.value = episode;
      const picker = document.getElementById('shareEpisodePicker');
      if (picker) picker.value = episode;
    }

    window.toggleEpisodeEdit = function (type, force) {
      const isShare = type === 'share';
      const headerId = isShare ? 'shareKanbanHeader' : 'stationKanbanHeader';
      const pickerId = isShare ? 'shareEpisodePicker' : 'stationEpisodePicker';
      const titleId = isShare ? 'shareTitlePicker' : 'stationTitlePicker';
      const header = document.getElementById(headerId);
      if (!header) return;
      const next = typeof force === 'boolean' ? force : !header.classList.contains('editing');
      header.classList.toggle('editing', next);
      if (next) {
        const episode = isShare ? state.currentShareEpisode : state.currentStationEpisode;
        const episodeInput = document.getElementById(pickerId);
        if (episodeInput) episodeInput.value = episode ?? '';
        const titleInput = document.getElementById(titleId);
        const title = isShare
          ? getEpisodeTitle(state.aiShares, episode, '', state.aiShareTitles)
          : getEpisodeTitle(state.aiStations, episode, '', state.aiStationTitles);
        if (titleInput) titleInput.value = title;
        if (episodeInput) {
          episodeInput.focus();
          episodeInput.select();
        } else if (titleInput) {
          titleInput.focus();
          titleInput.select();
        }
      }
    };

    window.confirmStationEpisode = function () {
      const picker = document.getElementById('stationEpisodePicker');
      if (!picker) return;
      const episode = parseEpisodeValue(picker.value);
      if (episode === null) {
        showToast('请输入有效期数', 'error');
        return;
      }
      const titleInput = document.getElementById('stationTitlePicker');
      updateEpisodeTitle(state.aiStations, state.aiStationTitles, episode, titleInput ? titleInput.value : '');
      const previousEpisode = state.currentStationEpisode;
      applyStationEpisode(episode);
      const sameEpisode = previousEpisode === episode;
      showToast(`已切换到第 ${episode} 期`, sameEpisode ? 'info' : 'success');
      window.toggleEpisodeEdit('station', false);
    };

    window.confirmShareEpisode = function () {
      const picker = document.getElementById('shareEpisodePicker');
      if (!picker) return;
      const episode = parseEpisodeValue(picker.value);
      if (episode === null) {
        showToast('请输入有效期数', 'error');
        return;
      }
      const titleInput = document.getElementById('shareTitlePicker');
      updateEpisodeTitle(state.aiShares, state.aiShareTitles, episode, titleInput ? titleInput.value : '');
      const previousEpisode = state.currentShareEpisode;
      applyShareEpisode(episode);
      const sameEpisode = previousEpisode === episode;
      showToast(`已切换到第 ${episode} 期`, sameEpisode ? 'info' : 'success');
      window.toggleEpisodeEdit('share', false);
    };

    const stationEpisodePicker = document.getElementById('stationEpisodePicker');
    if (stationEpisodePicker) {
      stationEpisodePicker.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          window.confirmStationEpisode();
        }
      });
    }

    const stationTitlePicker = document.getElementById('stationTitlePicker');
    if (stationTitlePicker) {
      stationTitlePicker.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          window.confirmStationEpisode();
        }
      });
    }

    const shareEpisodePicker = document.getElementById('shareEpisodePicker');
    if (shareEpisodePicker) {
      shareEpisodePicker.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          window.confirmShareEpisode();
        }
      });
    }

    const shareTitlePicker = document.getElementById('shareTitlePicker');
    if (shareTitlePicker) {
      shareTitlePicker.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          window.confirmShareEpisode();
        }
      });
    }

    function refreshAICharts(panel) {
      requestAnimationFrame(() => {
        if (panel === 'station') {
          renderStationChart();
        } else if (panel === 'share') {
          renderShareChart();
        }
      });
    }

    function getChartPalette() {
      const styles = getComputedStyle(document.documentElement);
      const read = (name, fallback) => styles.getPropertyValue(name).trim() || fallback;
      return {
        barBottom: read('--chart-blue-bottom', 'rgba(30, 78, 216, 0.9)'),
        barMid: read('--chart-blue-mid', 'rgba(59, 130, 246, 0.85)'),
        barTop: read('--chart-blue-top', 'rgba(147, 197, 253, 0.9)'),
        barSolid: read('--chart-blue-solid', 'rgba(30, 78, 216, 0.8)'),
        barEdge: read('--chart-blue-edge', 'rgba(30, 78, 216, 0.9)'),
        line: read('--chart-green-line', '#1BB678'),
        lineFill: read('--chart-green-fill', 'rgba(27, 182, 120, 0.14)'),
        grid: read('--chart-grid', 'rgba(15, 66, 100, 0.08)')
      };
    }

    function normalizeStationChartRange() {
      const total = state.aiStations.length;
      if (total === 0) {
        stationChartRange.start = 0;
        stationChartRange.count = 0;
        return;
      }
      const minCount = Math.min(6, total);
      stationChartRange.count = Math.min(total, Math.max(minCount, stationChartRange.count));
      const maxStart = Math.max(0, total - stationChartRange.count);
      stationChartRange.start = Math.min(maxStart, Math.max(0, stationChartRange.start));
    }

    function applyStationChartZoom(step) {
      if (!step) return;
      const before = stationChartRange.count;
      stationChartRange.count += step;
      normalizeStationChartRange();
      if (stationChartRange.count !== before) renderStationChart();
    }

    function applyStationChartPan(step) {
      if (!step) return;
      const before = stationChartRange.start;
      stationChartRange.start += step;
      normalizeStationChartRange();
      if (stationChartRange.start !== before) renderStationChart();
    }

    // 渲染广播站表格
    function renderStations() {
      const tbody = document.getElementById('stationTable');
      tbody.innerHTML = '';
      if (state.aiStations.length === 0) {
        tbody.innerHTML = '<tr><td class="empty-cell" colspan="9">暂无广播站记录</td></tr>';
        return;
      }
      state.aiStations.sort((a, b) => b.episode - a.episode).forEach(item => {
        const rate = ((item.views / item.total) * 100).toFixed(1);
        const rateClass = rate >= 90 ? 'rate-good' : rate >= 80 ? 'rate-mid' : 'rate-low';
        const cat = categoryMap[item.category] || categoryMap.mixed;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>第 ${item.episode} 期</strong></td>
          <td>${item.date}</td>
          <td>${item.title}</td>
          <td><span class="tag ${cat.class}">${cat.label}</span></td>
          <td>${item.views}</td>
          <td>${item.total}</td>
          <td class="${rateClass}">${rate}%</td>
          <td>${item.note || '-'}</td>
          <td>
            <div class="actions-row">
              <button class="btn btn-edit" onclick="editStation('${item.id}')">编辑</button>
              <button class="btn btn-delete" onclick="deleteStation('${item.id}')">删除</button>
            </div>
          </td>
        `;
        row.addEventListener('click', (e) => {
          if (!e.target.closest('button')) highlightStationChart(item.episode);
        });
        tbody.appendChild(row);
      });
    }

    // 渲染分享月表格
    function renderShares() {
      const tbody = document.getElementById('shareTable');
      tbody.innerHTML = '';
      if (state.aiShares.length === 0) {
        tbody.innerHTML = '<tr><td class="empty-cell" colspan="9">暂无分享月记录</td></tr>';
        return;
      }
      state.aiShares.sort((a, b) => b.episode - a.episode).forEach(item => {
        const rate = ((item.attendees / item.total) * 100).toFixed(1);
        const rateClass = rate >= 20 ? 'rate-good' : rate >= 15 ? 'rate-mid' : 'rate-low';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>第 ${item.episode} 期</strong></td>
          <td>${item.date}</td>
          <td>${item.title}</td>
          <td>${item.attendees}</td>
          <td>${item.total}</td>
          <td class="${rateClass}">${rate}%</td>
          <td>${item.duration} 分钟</td>
          <td>${item.note || '-'}</td>
          <td>
            <div class="actions-row">
              <button class="btn btn-edit" onclick="editShare('${item.id}')">编辑</button>
              <button class="btn btn-delete" onclick="deleteShare('${item.id}')">删除</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // 渲染广播站图表
    function renderStationChart() {
      const ctx = document.getElementById('stationChart');
      if (!ctx) return;

      normalizeStationChartRange();
      const palette = getChartPalette();
      let barGradient = null;
      const sorted = [...state.aiStations].sort((a, b) => a.episode - b.episode);
      const total = sorted.length;
      const start = Math.max(0, total - stationChartRange.count - stationChartRange.start);
      const end = total - stationChartRange.start;
      const data = sorted.slice(start, end);

      const labels = data.map(d => `第${d.episode}期`);
      const views = data.map(d => d.views);
      const rates = data.map(d => Number(((d.views / d.total) * 100).toFixed(1)));

      if (stationChart) stationChart.destroy();
      stationChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: '查看人数',
              data: views,
              backgroundColor: (context) => {
                const { chart } = context;
                const { chartArea } = chart;
                if (!chartArea) return palette.barSolid;
                if (!barGradient) {
                  const gradient = chart.ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                  gradient.addColorStop(0, palette.barBottom);
                  gradient.addColorStop(0.6, palette.barMid);
                  gradient.addColorStop(1, palette.barTop);
                  barGradient = gradient;
                }
                return barGradient;
              },
              borderColor: palette.barEdge,
              borderWidth: 1,
              borderRadius: 6,
              borderSkipped: false,
              maxBarThickness: 26,
              categoryPercentage: 0.7,
              barPercentage: 0.7,
              yAxisID: 'y'
            },
            {
              label: '查看率',
              data: rates,
              type: 'line',
              borderColor: palette.line,
              backgroundColor: palette.lineFill,
              borderWidth: 2.5,
              pointRadius: 3.5,
              pointHoverRadius: 5,
              pointBackgroundColor: palette.line,
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0.35,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', align: 'end', labels: { usePointStyle: true, font: { size: 11 } } }
          },
          scales: {
            x: { grid: { display: false }, ticks: { maxRotation: 0, autoSkip: true, autoSkipPadding: 8 } },
            y: { position: 'left', title: { display: true, text: '人数' }, grid: { color: palette.grid } },
            y1: { position: 'right', title: { display: true, text: '查看率 %' }, min: 0, max: 100, grid: { display: false } }
          }
        }
      });
      bindStationChartGestures();
    }

    // 渲染分享月图表
    function renderShareChart() {
      const ctx = document.getElementById('shareChart');
      if (!ctx) return;

      const palette = getChartPalette();
      let barGradient = null;
      const sorted = [...state.aiShares].sort((a, b) => a.episode - b.episode);
      const labels = sorted.map(d => `第${d.episode}期`);
      const attendees = sorted.map(d => d.attendees);
      const rates = sorted.map(d => Number(((d.attendees / d.total) * 100).toFixed(1)));

      if (shareChart) shareChart.destroy();
      shareChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: '参加人数',
              data: attendees,
              backgroundColor: (context) => {
                const { chart } = context;
                const { chartArea } = chart;
                if (!chartArea) return palette.barSolid;
                if (!barGradient) {
                  const gradient = chart.ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                  gradient.addColorStop(0, palette.barBottom);
                  gradient.addColorStop(0.6, palette.barMid);
                  gradient.addColorStop(1, palette.barTop);
                  barGradient = gradient;
                }
                return barGradient;
              },
              borderColor: palette.barEdge,
              borderWidth: 1,
              borderRadius: 6,
              borderSkipped: false,
              maxBarThickness: 30,
              categoryPercentage: 0.72,
              barPercentage: 0.72,
              yAxisID: 'y'
            },
            {
              label: '参与率',
              data: rates,
              type: 'line',
              borderColor: '#F59E0B',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 2.5,
              pointRadius: 3.5,
              pointHoverRadius: 5,
              pointBackgroundColor: '#F59E0B',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              tension: 0.35,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', align: 'end', labels: { usePointStyle: true, font: { size: 11 } } }
          },
          scales: {
            x: { grid: { display: false }, ticks: { maxRotation: 0, autoSkip: true, autoSkipPadding: 8 } },
            y: { position: 'left', title: { display: true, text: '人数' }, grid: { color: palette.grid } },
            y1: { position: 'right', title: { display: true, text: '参与率 %' }, min: 0, max: 50, grid: { display: false } }
          }
        }
      });
    }

    function bindStationChartGestures() {
      if (stationChartGesturesBound) return;
      const canvas = document.getElementById('stationChart');
      if (!canvas) return;
      const target = canvas.closest('.chart-container') || canvas;

      const wheelPanStep = 60;
      const wheelZoomStep = 40;
      const touchPanStep = 24;
      const touchZoomStep = 18;

      target.addEventListener('wheel', (e) => {
        if (e.ctrlKey) {
          e.preventDefault();
          stationChartGesture.zoomDelta += e.deltaY;
          const steps = Math.trunc(stationChartGesture.zoomDelta / wheelZoomStep);
          if (steps !== 0) {
            applyStationChartZoom(steps);
            stationChartGesture.zoomDelta -= steps * wheelZoomStep;
          }
          return;
        }

        if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
          e.preventDefault();
          stationChartGesture.wheelDelta += e.deltaX;
          const steps = Math.trunc(stationChartGesture.wheelDelta / wheelPanStep);
          if (steps !== 0) {
            applyStationChartPan(-steps);
            stationChartGesture.wheelDelta -= steps * wheelPanStep;
          }
        }
      }, { passive: false });

      target.addEventListener('touchstart', (e) => {
        if (e.touches.length !== 2) return;
        const [t1, t2] = e.touches;
        stationChartGesture.touchDistance = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        stationChartGesture.touchCenterX = (t1.clientX + t2.clientX) / 2;
      }, { passive: false });

      target.addEventListener('touchmove', (e) => {
        if (e.touches.length !== 2) return;
        e.preventDefault();
        const [t1, t2] = e.touches;
        const distance = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        const centerX = (t1.clientX + t2.clientX) / 2;

        if (stationChartGesture.touchDistance !== null) {
          const deltaDistance = distance - stationChartGesture.touchDistance;
          if (Math.abs(deltaDistance) >= touchZoomStep) {
            const steps = Math.round(Math.abs(deltaDistance) / touchZoomStep);
            applyStationChartZoom(deltaDistance < 0 ? steps : -steps);
          }
        }

        if (stationChartGesture.touchCenterX !== null) {
          const deltaX = centerX - stationChartGesture.touchCenterX;
          if (Math.abs(deltaX) >= touchPanStep) {
            const steps = Math.round(Math.abs(deltaX) / touchPanStep);
            applyStationChartPan(deltaX > 0 ? -steps : steps);
          }
        }

        stationChartGesture.touchDistance = distance;
        stationChartGesture.touchCenterX = centerX;
      }, { passive: false });

      const resetTouch = () => {
        stationChartGesture.touchDistance = null;
        stationChartGesture.touchCenterX = null;
      };

      target.addEventListener('touchend', resetTouch);
      target.addEventListener('touchcancel', resetTouch);
      stationChartGesturesBound = true;
    }

    // 图表缩放
    window.zoomStationChart = function (action) {
      if (action === 'in') {
        applyStationChartZoom(-3);
      } else if (action === 'out') {
        applyStationChartZoom(3);
      } else {
        stationChartRange = { start: 0, count: 12 };
        normalizeStationChartRange();
        renderStationChart();
      }
    };

    // 高亮图表某期
    function highlightStationChart(episode) {
      const sorted = [...state.aiStations].sort((a, b) => a.episode - b.episode);
      const idx = sorted.findIndex(d => d.episode === episode);
      if (idx >= 0 && stationChart) {
        stationChart.setActiveElements([{ datasetIndex: 0, index: idx }]);
        stationChart.update();
      }
    }

    // 渲染热力图
    function renderStationHeatmap() {
      const container = document.getElementById('stationHeatmap');
      const yearSelect = document.getElementById('stationHeatmapYear');
      if (!container || !yearSelect) return;

      // 初始化年份选择器
      const years = [...new Set(state.aiStations.map(s => new Date(s.date).getFullYear()))].sort((a, b) => b - a);
      if (years.length === 0) years.push(new Date().getFullYear());
      if (yearSelect.options.length === 0) {
        years.forEach(y => {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y + ' 年';
          yearSelect.appendChild(opt);
        });
      }

      const year = parseInt(yearSelect.value) || years[0];
      const startDate = new Date(year, 0, 1);
      const endDate = new Date(year, 11, 31);

      // 按日期索引数据
      const dataMap = {};
      state.aiStations.forEach(s => {
        const d = new Date(s.date);
        if (d.getFullYear() === year) {
          const key = s.date;
          dataMap[key] = { rate: (s.views / s.total) * 100, title: s.title, episode: s.episode };
        }
      });

      container.innerHTML = '';

      // 生成周列
      let currentDate = new Date(startDate);
      currentDate.setDate(currentDate.getDate() - currentDate.getDay()); // 从周日开始

      while (currentDate <= endDate || currentDate.getDay() !== 0) {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'heatmap-week';

        for (let i = 0; i < 7; i++) {
          const dayDiv = document.createElement('div');
          dayDiv.className = 'heatmap-day';

          const dateStr = currentDate.toISOString().split('T')[0];
          const data = dataMap[dateStr];

          if (currentDate >= startDate && currentDate <= endDate) {
            if (data) {
              const level = data.rate >= 95 ? 4 : data.rate >= 90 ? 3 : data.rate >= 85 ? 2 : 1;
              dayDiv.dataset.level = level;
              dayDiv.innerHTML = `<div class="heatmap-tooltip">第${data.episode}期: ${data.title}<br>${data.rate.toFixed(1)}%</div>`;
            }
          } else {
            dayDiv.style.visibility = 'hidden';
          }

          weekDiv.appendChild(dayDiv);
          currentDate.setDate(currentDate.getDate() + 1);
        }

        container.appendChild(weekDiv);
      }
    }

    // 看板渲染
    function resolveTaskTemplate(task, templateMap, aliasMap, stageIds, defaultStage) {
      const alias = aliasMap[task.name];
      const template = templateMap.get(task.name) || (alias ? templateMap.get(alias) : null);
      const stage = task.stage || (template && template.stage) || defaultStage;
      const safeStage = stageIds.has(stage) ? stage : defaultStage;
      const displayName = (template && template.name) || task.name;

      return {
        id: task.id,
        name: displayName,
        stage: safeStage,
        done: Boolean(task.done),
        tool: task.tool || (template && template.tool) || '',
        output: task.output || (template && template.output) || '',
        detail: task.detail || (template && template.detail) || '',
        owner: task.owner || (template && template.owner) || ''
      };
    }

    function renderProjectCard(task, toggleHandler, index) {
      const chips = [
        task.tool ? `<span class="task-chip">${task.tool}</span>` : '',
        task.output ? `<span class="task-chip ghost">${task.output}</span>` : ''
      ].filter(Boolean).join('');

      return `
        <div class="project-card ${task.done ? 'done' : ''}" style="--card-index:${index}" onclick="${toggleHandler}('${task.id}')">
          <div class="card-top">
            <span class="card-status"></span>
            <div class="project-card-title">${task.name}</div>
          </div>
          ${task.detail ? `<div class="card-detail">${task.detail}</div>` : ''}
          ${chips ? `<div class="card-meta">${chips}</div>` : ''}
          <div class="card-footer">
            <span>${task.done ? '已完成' : '进行中'}</span>
            ${task.owner ? `<strong>${task.owner}</strong>` : ''}
          </div>
        </div>
      `;
    }

    function renderProjectBoard({ boardEl, summaryEl, tasks, stageDefs, templateMap, aliasMap, toggleHandler, emptyMessage }) {
      if (!boardEl) return;
      if (summaryEl) summaryEl.innerHTML = '';

      if (!tasks || tasks.length === 0) {
        boardEl.innerHTML = `<div class="kanban-empty">${emptyMessage}</div>`;
        return;
      }

      const stageIds = new Set(stageDefs.map(stage => stage.id));
      const defaultStage = stageDefs[0] ? stageDefs[0].id : '';
      const enrichedTasks = tasks.map(task => resolveTaskTemplate(task, templateMap, aliasMap, stageIds, defaultStage));
      const total = enrichedTasks.length;
      const doneCount = enrichedTasks.filter(task => task.done).length;
      const pending = total - doneCount;
      const progress = total ? Math.round((doneCount / total) * 100) : 0;
      const currentStage = stageDefs.find(stage => enrichedTasks.some(task => task.stage === stage.id && !task.done))
        || stageDefs[stageDefs.length - 1];

      if (summaryEl) {
        summaryEl.innerHTML = `
          <div class="kanban-summary-card">
            <div class="summary-label">交付进度</div>
            <div class="summary-value">${doneCount}/${total}</div>
            <div class="summary-bar" style="--progress:${progress}%"><span></span></div>
          </div>
          <div class="summary-metrics">
            <div class="summary-metric">
              <div class="summary-label">当前阶段</div>
              <div class="summary-title">${currentStage ? currentStage.title : '-'}</div>
            </div>
            <div class="summary-metric">
              <div class="summary-label">待办</div>
              <div class="summary-title">${pending}</div>
            </div>
          </div>
        `;
      }

      boardEl.innerHTML = stageDefs.map((stage, stageIndex) => {
        const stageTasks = enrichedTasks.filter(task => task.stage === stage.id);
        const stageDone = stageTasks.filter(task => task.done).length;
        const stageTotal = stageTasks.length;
        const laneCards = stageTasks.length
          ? stageTasks.map((task, idx) => renderProjectCard(task, toggleHandler, stageIndex * 10 + idx)).join('')
          : '<div class="lane-empty">暂无事项</div>';
        const stageLabel = stageTotal ? `${stageDone}/${stageTotal}` : '0';
        const wip = stage.wip ? `<span class="lane-wip">WIP ${stage.wip}</span>` : '';

        return `
          <div class="project-lane" style="--lane-accent:${stage.accent || 'var(--primary)'}">
            <div class="lane-header">
              <div class="lane-title">
                <span>${stage.title}</span>
                <span class="lane-count">${stageLabel}</span>
              </div>
              <div class="lane-desc">${stage.desc || ''}</div>
              ${wip}
            </div>
            <div class="lane-body">${laneCards}</div>
          </div>
        `;
      }).join('');
    }

    function renderStationKanban() {
      const episodeEl = document.getElementById('stationKanbanEpisode');
      const boardEl = document.getElementById('stationKanbanBoard');
      const summaryEl = document.getElementById('stationKanbanSummary');
      const headerEl = document.getElementById('stationKanbanHeader');
      const picker = document.getElementById('stationEpisodePicker');
      const hasEpisode = state.currentStationEpisode !== null && state.currentStationEpisode !== undefined;

      if (picker) picker.value = hasEpisode ? state.currentStationEpisode : '';

      if (!hasEpisode) {
        if (episodeEl) {
          episodeEl.textContent = '未选择期次';
          episodeEl.classList.remove('active');
        }
        if (headerEl) headerEl.classList.add('editing');
        renderProjectBoard({
          boardEl,
          summaryEl,
          tasks: [],
          stageDefs: stationStageDefs,
          templateMap: stationTaskTemplateMap,
          aliasMap: stationTaskAliases,
          toggleHandler: 'toggleStationTask',
          emptyMessage: '点击「新建期次」开始'
        });
        return;
      }

      if (episodeEl) {
        const title = getEpisodeTitle(state.aiStations, state.currentStationEpisode, '未设置主题', state.aiStationTitles);
        episodeEl.innerHTML = `<span class="episode-badge">第 ${state.currentStationEpisode} 期</span><span class="episode-title-text">${escapeHtml(title)}</span>`;
        episodeEl.title = title;
        episodeEl.classList.add('active');
      }

      const seeded = ensureEpisodeTasks(state.aiStationTasks, state.currentStationEpisode, stationTaskTemplate, stationTaskAliases);
      if (seeded) persist();
      const tasks = state.aiStationTasks.filter(task => task.episode === state.currentStationEpisode);
      renderProjectBoard({
        boardEl,
        summaryEl,
        tasks,
        stageDefs: stationStageDefs,
        templateMap: stationTaskTemplateMap,
        aliasMap: stationTaskAliases,
        toggleHandler: 'toggleStationTask',
        emptyMessage: '暂无任务'
      });
    }

    function renderShareKanban() {
      // 0. 自动清理旧的测试数据 (如果发现旧的 stage 定义残留)
      if (state.aiShares.length > 0 && state.aiShareTasks.some(t => t.stage === 'prep' || t.stage === 'data')) {
        console.log('Cleaning legacy share data...');
        state.aiShares = [];
        state.aiShareTasks = [];
        state.currentShareEpisode = null;
        persist();
      }

      const episodeEl = document.getElementById('shareKanbanEpisode');
      const boardEl = document.getElementById('shareTimelineBoard'); // 注意 ID 变了
      const headerEl = document.getElementById('shareKanbanHeader');
      const picker = document.getElementById('shareEpisodePicker');
      const hasEpisode = state.currentShareEpisode !== null && state.currentShareEpisode !== undefined;

      if (picker) picker.value = hasEpisode ? state.currentShareEpisode : '';

      if (!hasEpisode) {
        if (episodeEl) {
          episodeEl.textContent = '未选择期次';
          episodeEl.classList.remove('active');
        }
        if (headerEl) headerEl.classList.add('editing');
        // 显示空状态引导
        if (boardEl) {
          boardEl.innerHTML = `
                <div style="padding: 3rem; text-align: center; color: var(--text-muted); width: 100%; display:flex; flex-direction:column; align-items:center; gap:1rem;">
                    <div style="width:60px; height:60px; border-radius:50%; background:var(--surface-card); display:flex; align-items:center; justify-content:center; border:2px dashed var(--border-medium);">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                    </div>
                    <div>点击右上角「+ 新建期次」<br>启动 AI 分享月任务流</div>
                </div>
            `;
        }
        return;
      }

      if (episodeEl) {
        const title = getEpisodeTitle(state.aiShares, state.currentShareEpisode, '未设置主题', state.aiShareTitles);
        episodeEl.innerHTML = `<span class="episode-badge">第 ${state.currentShareEpisode} 期</span><span class="episode-title-text">${escapeHtml(title)}</span>`;
        episodeEl.title = title;
        episodeEl.classList.add('active');
      }

      const seeded = ensureEpisodeTasks(state.aiShareTasks, state.currentShareEpisode, shareTaskTemplate, shareTaskAliases);
      if (seeded) persist();

      const tasks = state.aiShareTasks.filter(task => task.episode === state.currentShareEpisode);

      // 按照 stageDefs 顺序排序
      const sortedTasks = shareStageDefs.map(def => {
        return tasks.find(t => t.stage === def.id) || {
          id: 'temp_' + def.id,
          stage: def.id,
          name: def.title, // Fallback
          done: false
        };
      });

      // 计算进度
      const totalSteps = shareStageDefs.length;
      let completedSteps = 0;
      let activeIndex = -1; // 找到第一个未完成的设为 Active

      sortedTasks.forEach((t, index) => {
        if (t.done) completedSteps++;
        if (!t.done && activeIndex === -1) activeIndex = index;
      });
      // 如果全部完成，最后一个保持 Active 或者是全绿
      if (completedSteps === totalSteps) activeIndex = totalSteps;

      // 渲染 Timeline
      if (boardEl) {
        const progressPercent = totalSteps > 1 ? (completedSteps / (totalSteps - 1)) * 100 : 0;

        let html = `<div class="timeline-track">
            <!-- 连线 -->
            <div class="timeline-line-bg"></div>
            <div class="timeline-line-active" style="width: ${Math.max(0, Math.min(100, (activeIndex / (totalSteps - 1)) * 100))}%; left: 3rem;"></div>
          `;

        html += sortedTasks.map((task, index) => {
          const def = shareStageDefs.find(d => d.id === task.stage);
          const isDone = task.done;
          const isActive = (index === activeIndex) || (isDone && index === totalSteps - 1 && activeIndex === totalSteps);

          // 状态类名
          let statusClass = '';
          if (isDone) statusClass = 'done';
          else if (isActive) statusClass = 'active';

          // 图标选择 (根据阶段ID匹配一些默认图标，或者通用图标)
          let iconSvg = '';
          switch (task.stage) {
            case 'theme': iconSvg = '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>'; break; // Star
            case 'dev': iconSvg = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>'; break; // File
            case 'material': iconSvg = '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>'; break; // Image
            case 'notify1': iconSvg = '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>'; break; // Bell
            case 'notify2': iconSvg = '<path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/>'; break; // Bell 2
            case 'group': iconSvg = '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>'; break; // Users
            case 'execute': iconSvg = '<polygon points="5 3 19 12 5 21 5 3"/>'; break; // Play
            case 'archive': iconSvg = '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>'; break; // Folder
            default: iconSvg = '<circle cx="12" cy="12" r="10"/>';
          }

          // 查找模板详情以显示
          const template = shareTaskTemplate.find(t => t.stage === task.stage);

          const ownerText = template ? template.owner : '';
          const detailText = template ? template.detail : '';

          return `
                <div class="timeline-step ${statusClass}" onclick="toggleShareTask('${task.id}')" title="点击切换状态: ${task.name}">
                  <div class="step-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        ${isDone ? '<polyline points="20 6 9 17 4 12"/>' : iconSvg}
                    </svg>
                  </div>
                  <div class="step-card">
                    <div class="step-title">${task.name}</div>
                    <div class="step-desc">${detailText}<br><span style="opacity:0.7; font-size:0.65rem;">${ownerText}</span></div>
                  </div>
                </div>
              `;
        }).join('');

        html += `</div>`; // end track
        boardEl.innerHTML = html;
      }
    }

    // 新建期次
    window.newStationEpisode = function () {
      const maxEpisode = state.aiStations.length > 0 ? Math.max(...state.aiStations.map(s => s.episode)) : 0;
      const newEpisode = maxEpisode + 1;
      applyStationEpisode(newEpisode);
      window.toggleEpisodeEdit('station', false);
    };

    window.newShareEpisode = function () {
      const maxEpisode = state.aiShares.length > 0 ? Math.max(...state.aiShares.map(s => s.episode)) : 0;
      const newEpisode = maxEpisode + 1;
      applyShareEpisode(newEpisode);
      window.toggleEpisodeEdit('share', false);
    };

    // 切换任务状态
    window.toggleStationTask = function (id) {
      const task = state.aiStationTasks.find(t => t.id === id);
      if (task) {
        task.done = !task.done;
        persist();
        renderStationKanban();
      }
    };

    window.toggleShareTask = function (id) {
      const task = state.aiShareTasks.find(t => t.id === id);
      if (task) {
        task.done = !task.done;
        persist();
        renderShareKanban();
      }
    };

    // 表单操作
    function resetStationForm() {
      document.getElementById('stationForm').reset();
      document.getElementById('stationId').value = '';
    }

    function resetShareForm() {
      document.getElementById('shareForm').reset();
      document.getElementById('shareId').value = '';
    }

    window.resetStationForm = resetStationForm;
    window.resetShareForm = resetShareForm;

    window.editStation = function (id) {
      const item = state.aiStations.find(s => s.id === id);
      if (!item) return;
      document.getElementById('stationId').value = item.id;
      document.getElementById('stationEpisode').value = item.episode;
      document.getElementById('stationDate').value = item.date;
      document.getElementById('stationTitle').value = item.title;
      document.getElementById('stationViews').value = item.views;
      document.getElementById('stationTotal').value = item.total;
      document.getElementById('stationCategory').value = item.category;
      document.getElementById('stationNote').value = item.note || '';
      // 自动滚动到表单位置
      document.getElementById('stationForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
      // 显示取消编辑按钮
      document.getElementById('stationCancelBtn').style.display = 'inline-block';
    };

    window.deleteStation = function (id) {
      showConfirm('确认删除这条广播站记录吗？此操作不可恢复。', () => {
        state.aiStations = state.aiStations.filter(s => s.id !== id);
        persist();
        renderAIKnowledge();
        showToast('记录已删除', 'success');
      });
    };

    window.cancelStationEdit = function () {
      resetStationForm();
      document.getElementById('stationCancelBtn').style.display = 'none';
    };

    window.editShare = function (id) {
      const item = state.aiShares.find(s => s.id === id);
      if (!item) return;
      document.getElementById('shareId').value = item.id;
      document.getElementById('shareEpisode').value = item.episode;
      document.getElementById('shareDate').value = item.date;
      document.getElementById('shareTitle').value = item.title;
      document.getElementById('shareAttendees').value = item.attendees;
      document.getElementById('shareTotal').value = item.total;
      document.getElementById('shareDuration').value = item.duration;
      document.getElementById('shareNote').value = item.note || '';
    };

    window.deleteShare = function (id) {
      const item = state.aiShares.find(s => s.id === id);
      showConfirm('确认删除这条分享月记录吗？\n(关联的培训记录也将一并删除)', () => {
        // 1. Delete share
        state.aiShares = state.aiShares.filter(s => s.id !== id);

        // 2. Delete linked session if exists
        if (item) {
          const targetProjectName = `AI分享月(第${item.episode}期)`;
          // 优先匹配 linkedSessionId，其次匹配特征
          if (item.linkedSessionId) {
            state.sessions = state.sessions.filter(s => s.id !== item.linkedSessionId);
          } else {
            // 兼容旧数据：尝试通过 项目名称+日期 匹配
            state.sessions = state.sessions.filter(s => !(s.project === targetProjectName && s.date === item.date));
          }
        }

        persist();
        renderAIKnowledge();
        showToast('记录已删除', 'success');
      });
    };

    // 表单提交
    document.getElementById('stationForm').addEventListener('submit', e => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('stationId').value || uid(),
        episode: Number(document.getElementById('stationEpisode').value),
        date: document.getElementById('stationDate').value,
        title: document.getElementById('stationTitle').value,
        views: Number(document.getElementById('stationViews').value),
        total: Number(document.getElementById('stationTotal').value),
        category: document.getElementById('stationCategory').value,
        note: document.getElementById('stationNote').value
      };
      const existing = state.aiStations.find(s => s.id === payload.id);
      if (existing) Object.assign(existing, payload);
      else state.aiStations.push(payload);
      resetStationForm();
      persist();
      renderAIKnowledge();
      showToast('广播站记录已保存', 'success');
    });

    document.getElementById('shareForm').addEventListener('submit', e => {
      e.preventDefault();
      const payload = {
        id: document.getElementById('shareId').value || uid(),
        episode: Number(document.getElementById('shareEpisode').value),
        date: document.getElementById('shareDate').value,
        title: document.getElementById('shareTitle').value,
        attendees: Number(document.getElementById('shareAttendees').value),
        total: Number(document.getElementById('shareTotal').value),
        duration: Number(document.getElementById('shareDuration').value),
        note: document.getElementById('shareNote').value
      };

      const existing = state.aiShares.find(s => s.id === payload.id);

      // --- 数据联动 Logic Start ---
      // 1. 查找是否已有关联的 Session
      let relatedSession = null;
      if (existing && existing.linkedSessionId) {
        relatedSession = state.sessions.find(s => s.id === existing.linkedSessionId);
      }
      // 2. 如果没找到关联ID，尝试通过“项目名+日期”模糊匹配（防止旧数据重复创建）
      const projectName = `AI分享月(第${payload.episode}期)`;
      if (!relatedSession) {
        relatedSession = state.sessions.find(s => s.project === projectName && s.date === payload.date);
      }

      // 3. 构造 Session 数据
      const sessionPayload = {
        id: relatedSession ? relatedSession.id : uid(),
        date: payload.date,
        course: payload.title, // 课程名 = 主题
        project: projectName,  // 项目名 = AI分享月(第X期)
        lecturer: '',          // 默认留空，或可设置为当前用户
        people: payload.attendees,
        duration: (payload.duration / 60).toFixed(1), // 分钟 -> 小时
        note: (payload.note || '') + ' [自动同步自AI分享月]',
        source: 'ai_share'
      };

      // 4. 更新/插入 Session
      if (relatedSession) {
        Object.assign(relatedSession, sessionPayload);
      } else {
        state.sessions.push(sessionPayload);
      }

      // 5. 将 Session ID 回写到 Share 记录中
      payload.linkedSessionId = sessionPayload.id;
      // --- 数据联动 Logic End ---

      if (existing) Object.assign(existing, payload);
      else state.aiShares.push(payload);

      resetShareForm();
      persist();
      renderAIKnowledge();
      showToast('分享月记录已保存 (并同步至培训管理)', 'success');
    });

    // 渲染所有AI知识库内容
    function renderAIKnowledge() {
      renderStations();
      renderShares();
      renderStationChart();
      renderShareChart();
      renderStationHeatmap();
      renderStationKanban();
      renderShareKanban();
    }

    // 初始化AI知识库
    setTimeout(() => {
      const aiPage = document.getElementById('page-aiknowledge');
      if (aiPage && aiPage.classList.contains('active')) {
        renderAIKnowledge();
      }
    }, 100);
    /* =========================================
       New: 金融小百科 (Finance Encyclopedia) - Kanban Logic
       ========================================= */
    const financeTaskTemplate = [
      { name: '选题策划', stage: 'topic' },
      { name: '文案撰写', stage: 'draft' },
      { name: 'PPT制作', stage: 'ppt' },
      { name: '视频制作', stage: 'video' },
      { name: '宣发文案', stage: 'copy' },
      { name: '社群发布', stage: 'publish' },
      { name: '数据归档', stage: 'data' }
    ];

    let financeChart = null;

    // Determine which stage an item is currently in (first undone stage)
    function getFinanceStage(item) {
      if (!item.workflow) item.workflow = {};
      for (const step of financeTaskTemplate) {
        if (!item.workflow[step.stage]) return step.stage;
      }
      return 'data'; // All done = last column
    }

    // Main render function
    // Main render function
    function renderFinanceWiki() {
      if (!state.financeWiki) state.financeWiki = [];
      renderFinanceKanban();
    }

    // --- Drag & Drop Handlers ---
    let draggedFinanceItemId = null;

    window.financeDragStart = function (e, id) {
      draggedFinanceItemId = id;
      e.dataTransfer.effectAllowed = 'move';
      // Use a timeout to ensure element isn't hidden immediately if we manipulate DOM
      requestAnimationFrame(() => {
        e.target.classList.add('is-dragging');
      });
    };

    window.financeDragEnd = function (e) {
      e.target.classList.remove('is-dragging');
      document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drag-over'));
      draggedFinanceItemId = null;
    };

    window.financeDragOver = function (e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const col = e.target.closest('.kanban-column');
      if (col) col.classList.add('drag-over');
    };

    window.financeDragLeave = function (e) {
      const col = e.target.closest('.kanban-column');
      if (col) col.classList.remove('drag-over');
    };

    window.financeDrop = function (e) {
      e.preventDefault();
      const col = e.target.closest('.kanban-column');
      document.querySelectorAll('.kanban-column').forEach(c => c.classList.remove('drag-over'));

      if (!col || !draggedFinanceItemId) return;

      const targetStage = col.dataset.stage;
      const item = state.financeWiki.find(i => i.id === draggedFinanceItemId);
      if (!item) return;

      if (!item.workflow) item.workflow = {};

      // Update logic:
      // If dropped in 'data' (Done), everything is true.
      // If dropped in 'topic', everything is false.
      // Else, everything BEFORE target is true, target and AFTER are false.
      // Wait, if I drop in 'draft', 'topic' is done, 'draft' is Todo (false).

      let pastTarget = false;

      // Special check: If target is 'data', everything is true. 
      // But 'data' stage in template is the last one.

      financeTaskTemplate.forEach(t => {
        if (t.stage === targetStage) pastTarget = true;

        if (pastTarget) {
          item.workflow[t.stage] = false;
        } else {
          item.workflow[t.stage] = true;
        }
      });

      // Special case: If dropping into "data" column (Completed), maybe we want everything true?
      // Logic above: If target is 'data', pastTarget becomes true immediately.
      // So 'data' becomes false. Previous are true.
      // Result: 'data' is the first FALSE stage. So getFinanceStage returns 'data'. Correct.
      // But wait... getFinanceStage returns 'data' if ALL are true?
      // "return 'data'; // All done" (Line 6104 in step 934)
      // The template has 'data' as the last stage.
      // If workflow['data'] is TRUE, do we move to a hidden 8th stage? No.
      // If workflow['data'] is FALSE, getFinanceStage returns 'data'.
      // So drag-to-data column sets workflow['data'] = false, implies it's "IN PROGRESS" at data stage.
      // To mark as "COMPLETED" (done-done), workflow['data'] should be true?
      // Visually 'data' column has class 'done'.
      // If I want it to stay in 'data' column, getFinanceStage must return 'data'.
      // getFinanceStage returns 'data' if 'publish' is true and 'data' is false.
      // OR if 'data' is true, loop finishes, returns 'data'.
      // So it doesn't matter if 'data' is true or false, it returns 'data'.
      // So keeping it false is fine.

      persist();
      renderFinanceKanban();
    };

    // Render Kanban Board
    function renderFinanceKanban() {
      const stages = ['topic', 'draft', 'ppt', 'video', 'copy', 'publish', 'data'];
      const buckets = {};
      stages.forEach(s => buckets[s] = []);

      state.financeWiki.forEach(item => {
        const stage = getFinanceStage(item);
        buckets[stage].push(item);
      });

      stages.forEach(stage => {
        const countEl = document.getElementById(`finCount-${stage}`);
        const cardsEl = document.getElementById(`finCards-${stage}`);
        if (countEl) countEl.textContent = buckets[stage].length;
        if (cardsEl) {
          cardsEl.innerHTML = buckets[stage].sort((a, b) => b.episode - a.episode).map(item => `
            <div class="kanban-card" draggable="true" 
                 onclick="openFinanceModal('${item.id}')"
                 ondragstart="financeDragStart(event, '${item.id}')"
                 ondragend="financeDragEnd(event)">
              <div class="kanban-card-ep">第 ${item.episode} 期</div>
              <div class="kanban-card-title">${escapeHtml(item.title)}</div>
              <div class="kanban-card-date">${item.date || '--'}</div>
            </div>
          `).join('');
        }
      });
    }

    // View Switch
    window.switchFinanceView = function (view) {
      const kanbanView = document.getElementById('finKanbanView');
      const statsView = document.getElementById('finStatsView');
      const kanbanTab = document.getElementById('finView-kanban');
      const statsTab = document.getElementById('finView-stats');

      if (view === 'kanban') {
        if (kanbanView) kanbanView.style.display = 'block';
        if (statsView) statsView.style.display = 'none';
        if (kanbanTab) kanbanTab.classList.add('active');
        if (statsTab) statsTab.classList.remove('active');
      } else {
        if (kanbanView) kanbanView.style.display = 'none';
        if (statsView) statsView.style.display = 'block';
        if (kanbanTab) kanbanTab.classList.remove('active');
        if (statsTab) statsTab.classList.add('active');
        renderFinanceCharts();
        renderFinanceHeatmap();
      }
    };

    // Open Modal
    window.openFinanceModal = function (id) {
      const item = state.financeWiki.find(i => i.id === id);
      if (!item) return;

      state.currentFinanceEpisode = id;

      document.getElementById('finId').value = item.id;
      document.getElementById('finEpisode').value = item.episode;
      document.getElementById('finTitle').value = item.title;
      document.getElementById('finDate').value = item.date || '';
      document.getElementById('finViews').value = item.views || 0;
      document.getElementById('finTotal').value = item.total || 260;
      document.getElementById('finNote').value = item.note || '';

      // Render workflow chips
      const chipsContainer = document.getElementById('finWorkflowChips');
      if (chipsContainer) {
        if (!item.workflow) item.workflow = {};
        chipsContainer.innerHTML = financeTaskTemplate.map(step => {
          const done = !!item.workflow[step.stage];
          return `<span class="fin-chip ${done ? 'done' : ''}" onclick="toggleFinanceStep('${item.id}', '${step.stage}')">${done ? '✓ ' : ''}${step.name}</span>`;
        }).join('');
      }

      const modal = document.getElementById('financeModal');
      modal.style.display = 'flex';
      // Small delay to allow display:flex to apply before adding class for transition
      requestAnimationFrame(() => {
        modal.classList.add('active');
      });
    };

    window.closeFinanceModal = function () {
      const modal = document.getElementById('financeModal');
      modal.classList.remove('active');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 200);
    };

    // Toggle step from modal
    window.toggleFinanceStep = function (id, stage) {
      const item = state.financeWiki.find(i => i.id === id);
      if (!item) return;
      if (!item.workflow) item.workflow = {};
      item.workflow[stage] = !item.workflow[stage];
      persist();
      openFinanceModal(id); // refresh modal
      renderFinanceKanban();
    };

    // Delete current episode
    window.deleteCurrentFinanceEpisode = function () {
      const id = document.getElementById('finId').value;
      if (!id) return;
      showConfirm('确定删除该期次吗？删除后无法恢复。', () => {
        state.financeWiki = state.financeWiki.filter(i => i.id !== id);
        if (state.currentFinanceEpisode === id) state.currentFinanceEpisode = null;
        persist();
        closeFinanceModal();
        renderFinanceKanban();
        showToast('期次已删除', 'success');
      });
    };

    // New Episode with Manual Input
    function newFinanceEpisode() {
      if (!state.financeWiki) state.financeWiki = [];
      let maxEp = 0;
      if (state.financeWiki.length > 0) {
        maxEp = Math.max(...state.financeWiki.map(i => i.episode || 0));
      }
      const defaultEp = maxEp + 1;
      const input = prompt('请输入新期号 (例如: 86)', defaultEp);
      if (input === null) return; // cancelled

      const newEp = parseInt(input, 10);
      if (isNaN(newEp) || newEp < 1) {
        showToast('请输入有效的数字', 'error');
        return;
      }

      // Check for duplicate
      if (state.financeWiki.some(i => i.episode === newEp)) {
        showToast(`第 ${newEp} 期已存在`, 'error');
        return;
      }

      const newItem = {
        id: uid(),
        episode: newEp,
        title: `稳定币超入门 第${newEp}期`,
        date: new Date().toISOString().split('T')[0],
        note: '',
        views: 0,
        total: 260,
        workflow: {}, // Start empty
        project: 'Stablecoin 101'
      };

      state.financeWiki.push(newItem);
      state.currentFinanceEpisode = newItem.id;
      persist();
      renderFinanceKanban();
      // force switch to kanban view if not already
      switchFinanceView('kanban');
      openFinanceModal(newItem.id);
      showToast(`新建第 ${newEp} 期成功`, 'success');
    }

    /* --- Finance Charts --- */
    function renderFinanceCharts() {
      const ctx = document.getElementById('financeTrendChart');
      if (!ctx) return;
      if (!state.financeWiki) state.financeWiki = [];

      const data = [...state.financeWiki].sort((a, b) => a.episode - b.episode);
      const labels = data.map(i => `第${i.episode}期`);
      const rates = data.map(i => {
        const v = Number(i.views) || 0;
        const t = Number(i.total) || 260;
        return t > 0 ? ((v / t) * 100).toFixed(1) : 0;
      });
      const views = data.map(i => Number(i.views) || 0);

      // Create Gradient
      const chartCtx = ctx.getContext('2d');
      const gradient = chartCtx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(75, 110, 134, 0.8)');
      gradient.addColorStop(1, 'rgba(75, 110, 134, 0.1)');

      if (financeChart) financeChart.destroy();
      financeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: '查看人数',
              data: views,
              backgroundColor: gradient,
              borderRadius: 4,
              order: 2,
              yAxisID: 'y'
            },
            {
              label: '查看率 %',
              data: rates,
              type: 'line',
              borderColor: '#10B981',
              borderWidth: 3,
              pointBackgroundColor: '#fff',
              pointBorderColor: '#10B981',
              pointRadius: 4,
              order: 1,
              tension: 0.3,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleFont: { size: 13 },
              bodyFont: { size: 13 }
            }
          },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, position: 'left', grid: { color: 'rgba(0,0,0,0.05)' } },
            y1: { beginAtZero: true, position: 'right', max: 100, grid: { display: false } }
          }
        }
      });
    }

    function renderFinanceHeatmap() {
      const container = document.getElementById('financeHeatmap');
      const select = document.getElementById('financeHeatmapYear');
      if (!container || !select) return;
      if (!state.financeWiki) state.financeWiki = [];

      if (select.options.length === 0) {
        const currentYear = new Date().getFullYear();
        for (let y = currentYear; y >= currentYear - 2; y--) {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y + ' 年';
          select.appendChild(opt);
        }
      }
      const year = Number(select.value);
      container.innerHTML = '';

      const dayMap = {};
      let maxCount = 0;
      state.financeWiki.forEach(item => {
        if (!item.date) return;
        const d = new Date(item.date);
        if (d.getFullYear() === year) {
          const key = item.date;
          dayMap[key] = (dayMap[key] || 0) + 1;
          if (dayMap[key] > maxCount) maxCount = dayMap[key];
        }
      });

      // Prevent divide by zero
      if (maxCount === 0) maxCount = 1;

      const start = new Date(year, 0, 1);
      const end = new Date(year, 11, 31);
      let html = '';
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const key = d.toISOString().split('T')[0];
        const count = dayMap[key] || 0;

        // Calculate color intensity (GitHub style)
        // 0: #ebedf0
        // >0: shades of green
        let color = '#ebedf0';
        if (count > 0) {
          const ratio = count / maxCount;
          if (ratio <= 0.25) color = '#9be9a8';
          else if (ratio <= 0.5) color = '#40c463';
          else if (ratio <= 0.75) color = '#30a14e';
          else color = '#216e39';
        }

        html += `<div class="heatmap-item" style="background:${color}" title="${key}: ${count} 期"></div>`;
      }
      container.innerHTML = html;
    }

    // Form Submit (Save from Modal)
    document.getElementById('financeForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('finId').value;
      if (!id) return;
      const fItem = state.financeWiki.find(i => i.id === id);
      if (fItem) {
        // Fix: Allow editing episode number manually
        const newEp = Number(document.getElementById('finEpisode').value);
        if (newEp) fItem.episode = newEp;

        fItem.title = document.getElementById('finTitle').value;
        fItem.date = document.getElementById('finDate').value;
        fItem.views = Number(document.getElementById('finViews').value);
        fItem.total = Number(document.getElementById('finTotal').value);
        fItem.note = document.getElementById('finNote').value;
        persist();
        closeFinanceModal();
        renderFinanceKanban();
        showToast('保存成功', 'success');
      }
    });

  </script>
</body>

</html>